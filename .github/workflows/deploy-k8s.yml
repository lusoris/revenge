name: Deploy Testing - Kubernetes (kind)

on:
  push:
    branches:
      - develop
      - main
    paths:
      - 'charts/**'
      - 'deploy/**'
      - 'Dockerfile'
      - '.github/workflows/deploy-k8s.yml'
  pull_request:
    paths:
      - 'charts/**'
      - 'deploy/**'
      - 'Dockerfile'
      - '.github/workflows/deploy-k8s.yml'
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  versions:
    name: Get versions from SOURCE_OF_TRUTH
    uses: ./.github/workflows/_versions.yml

  kind-deploy:
    name: Test Kubernetes Deployment (kind)
    runs-on: ubuntu-latest
    needs: versions
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: revenge-test
          config: |
            kind: Cluster
            apiVersion: kind.x-k8s.io/v1alpha4
            nodes:
            - role: control-plane
              extraPortMappings:
              - containerPort: 30080
                hostPort: 8080
                protocol: TCP
            - role: worker
            - role: worker

      - name: Verify Kubernetes cluster
        run: |
          kubectl cluster-info
          kubectl get nodes
          kubectl version

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.16.0

      - name: Add Helm repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add dragonfly https://dragonflydb.github.io/dragonfly-operator
          helm repo update

      - name: Create namespace
        run: kubectl create namespace revenge

      - name: Deploy PostgreSQL
        run: |
          helm install postgresql bitnami/postgresql \
            --namespace revenge \
            --set auth.postgresPassword=test \
            --set auth.database=revenge \
            --set primary.persistence.size=1Gi \
            --wait --timeout 5m

      - name: Deploy Dragonfly
        run: |
          helm install dragonfly dragonfly/dragonfly \
            --namespace revenge \
            --wait --timeout 5m

      - name: Build and load Docker image
        run: |
          docker build -t ghcr.io/${{ github.repository }}:test .
          kind load docker-image ghcr.io/${{ github.repository }}:test --name revenge-test

      - name: Deploy Revenge with Helm
        run: |
          helm install revenge charts/revenge \
            --namespace revenge \
            --set image.repository=ghcr.io/${{ github.repository }} \
            --set image.tag=test \
            --set image.pullPolicy=Never \
            --set postgresql.enabled=false \
            --set postgresql.host=postgresql.revenge.svc.cluster.local \
            --set postgresql.password=test \
            --set dragonfly.enabled=false \
            --set dragonfly.host=dragonfly.revenge.svc.cluster.local \
            --set service.type=NodePort \
            --set service.nodePort=30080 \
            --wait --timeout 10m

      - name: Verify deployment
        run: |
          kubectl get all -n revenge
          kubectl get configmaps -n revenge
          kubectl get secrets -n revenge

      - name: Wait for Revenge pods
        run: |
          kubectl wait --for=condition=ready pod \
            -l app.kubernetes.io/name=revenge \
            -n revenge \
            --timeout=5m

      - name: Test health endpoints
        run: |
          # Test liveness
          curl -f http://localhost:8080/health/live || exit 1
          echo "✅ Liveness check passed"

          # Test readiness
          curl -f http://localhost:8080/health/ready || exit 1
          echo "✅ Readiness check passed"

          # Test startup
          curl -f http://localhost:8080/health/startup || exit 1
          echo "✅ Startup check passed"

      - name: Test Kubernetes resources
        run: |
          # Check HPA (if enabled)
          kubectl get hpa -n revenge || echo "No HPA configured"

          # Check PVC
          kubectl get pvc -n revenge

          # Check Service
          kubectl get svc -n revenge
          kubectl describe svc revenge -n revenge

      - name: Test pod scaling
        run: |
          echo "=== Scaling to 3 replicas ==="
          kubectl scale deployment revenge -n revenge --replicas=3
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=revenge -n revenge --timeout=3m
          kubectl get pods -n revenge -l app.kubernetes.io/name=revenge

          echo "=== Scaling back to 1 replica ==="
          kubectl scale deployment revenge -n revenge --replicas=1
          sleep 10
          kubectl get pods -n revenge -l app.kubernetes.io/name=revenge

      - name: Get pod logs on failure
        if: failure()
        run: |
          echo "=== Revenge Deployment ==="
          kubectl describe deployment revenge -n revenge
          echo ""
          echo "=== Revenge Pods ==="
          kubectl get pods -n revenge -l app.kubernetes.io/name=revenge
          echo ""
          echo "=== Revenge Logs ==="
          kubectl logs -n revenge -l app.kubernetes.io/name=revenge --tail=100 --all-containers
          echo ""
          echo "=== PostgreSQL Logs ==="
          kubectl logs -n revenge -l app.kubernetes.io/name=postgresql --tail=50
          echo ""
          echo "=== Dragonfly Logs ==="
          kubectl logs -n revenge -l app.kubernetes.io/name=dragonfly --tail=50
          echo ""
          echo "=== Events ==="
          kubectl get events -n revenge --sort-by='.lastTimestamp'

  k8s-manifests:
    name: Generate and Validate k8s Manifests
    runs-on: ubuntu-latest
    needs: versions
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.16.0

      - name: Generate Kubernetes manifests
        run: |
          helm template revenge charts/revenge \
            --namespace revenge \
            --set image.tag=${{ needs.versions.outputs.go-version }} \
            --set ingress.enabled=true \
            --set ingress.className=nginx \
            --set ingress.hosts[0].host=revenge.local \
            --set ingress.hosts[0].paths[0].path=/ \
            --set ingress.hosts[0].paths[0].pathType=Prefix \
            > deploy/k8s-manifests.yaml

      - name: Validate manifests with kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'

      - name: Validate YAML syntax
        run: |
          kubectl apply --dry-run=client -f deploy/k8s-manifests.yaml

      - name: Upload manifests
        uses: actions/upload-artifact@v4
        with:
          name: k8s-manifests
          path: deploy/k8s-manifests.yaml

  helm-chart-test:
    name: Helm Chart Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.16.0

      - name: Install chart-testing
        uses: helm/chart-testing-action@v2

      - name: List changed charts
        id: list-changed
        run: |
          changed=$(ct list-changed --target-branch ${{ github.event.repository.default_branch }})
          if [[ -n "$changed" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Lint charts
        if: steps.list-changed.outputs.changed == 'true'
        run: ct lint --target-branch ${{ github.event.repository.default_branch }}

      - name: Create kind cluster
        if: steps.list-changed.outputs.changed == 'true'
        uses: helm/kind-action@v1

      - name: Run chart-testing (install)
        if: steps.list-changed.outputs.changed == 'true'
        run: ct install --target-branch ${{ github.event.repository.default_branch }}
