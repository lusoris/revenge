name: Validate SOURCE_OF_TRUTH

on:
  pull_request:
    paths:
      - 'docs/dev/design/00_SOURCE_OF_TRUTH.md'
      - '.github/workflows/**'
      - '**/*.md'
      - '.claude/skills/**'
  schedule:
    # Run weekly on Mondays at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  validate-no-hardcoded-versions:
    name: Check for Hardcoded Versions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for hardcoded Go versions
        run: |
          echo "ðŸ” Checking for hardcoded Go versions..."

          # Patterns to search for (excluding SOURCE_OF_TRUTH itself and examples)
          PATTERNS=(
            'go1\.25\.[0-9]'
            'Go 1\.25\.[0-9]'
            'go-version.*1\.25\.[0-9]'
          )

          # Files to exclude from search
          EXCLUDE_FILES=(
            'docs/dev/design/00_SOURCE_OF_TRUTH.md'
            '.github/workflows/_versions.yml'
            '.github/workflows/validate-sot.yml'
          )

          # Build grep exclude args
          EXCLUDE_ARGS=""
          for file in "${EXCLUDE_FILES[@]}"; do
            EXCLUDE_ARGS="$EXCLUDE_ARGS --exclude=$file"
          done

          # Search for each pattern
          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            echo "  Searching for pattern: $pattern"
            if grep -r $EXCLUDE_ARGS \
                --exclude-dir=.git \
                --exclude-dir=node_modules \
                --exclude-dir='*/sources' \
                --exclude-dir='*/sources/*' \
                --exclude='*/sources/*.md' \
                --exclude='release-notes.md' \
                --exclude-dir=.analysis \
                --exclude-dir=.shared \
                --exclude-dir=.zed \
                "$pattern" . 2>/dev/null | grep -v "e.g\|example\|Example\|TODO\|<from SOT>\|check SOURCE_OF_TRUTH\|docs/dev/sources"; then
              echo "  âŒ Found hardcoded version matching: $pattern"
              FOUND=1
            fi
          done

          if [ $FOUND -eq 1 ]; then
            echo ""
            echo "âŒ VALIDATION FAILED: Hardcoded versions found!"
            echo ""
            echo "All versions should be:"
            echo "1. Defined in docs/dev/design/00_SOURCE_OF_TRUTH.md"
            echo "2. Extracted via .github/workflows/_versions.yml"
            echo "3. Referenced via needs.versions.outputs.* in workflows"
            echo ""
            exit 1
          else
            echo "âœ… No hardcoded Go versions found!"
          fi

      - name: Check for hardcoded Python versions
        run: |
          echo "ðŸ” Checking for hardcoded Python versions..."

          if grep -r \
              --exclude-dir=.git \
              --exclude-dir=node_modules \
              --exclude-dir=docs/dev/sources \
              --exclude-dir=.github/docs \
              --exclude-dir=.analysis \
              --exclude-dir=.shared \
              --exclude-dir=.zed \
              --exclude="00_SOURCE_OF_TRUTH.md" --exclude="_versions.yml" \
              --exclude="validate-sot.yml" \
              "python-version.*3\.12" . 2>/dev/null | \
              grep -v "needs.versions.outputs" | \
              grep -v "e.g\|example\|Example\|TODO\|<from SOT>"; then
            echo "âŒ Found hardcoded Python version 3.12"
            echo "Use: needs.versions.outputs.python-version instead"
            exit 1
          else
            echo "âœ… No hardcoded Python versions found!"
          fi

      - name: Check for hardcoded Node.js versions
        run: |
          echo "ðŸ” Checking for hardcoded Node.js versions..."

          if grep -r \
              --exclude-dir=.git \
              --exclude-dir=node_modules \
              --exclude-dir=docs/dev/sources \
              --exclude-dir=.github/docs \
              --exclude-dir=.analysis \
              --exclude-dir=.shared \
              --exclude-dir=.zed \
              --exclude="00_SOURCE_OF_TRUTH.md" --exclude="_versions.yml" \
              --exclude="validate-sot.yml" \
              "node-version.*['\"]20" . 2>/dev/null | \
              grep "\.yml\|\.yaml" | \
              grep -v "needs.versions.outputs" | \
              grep -v "e.g\|example\|Example\|TODO\|<from SOT>"; then
            echo "âŒ Found hardcoded Node.js version"
            echo "Use: needs.versions.outputs.node-version instead"
            exit 1
          else
            echo "âœ… No hardcoded Node.js versions found!"
          fi

      - name: Check for hardcoded GOEXPERIMENT
        run: |
          echo "ðŸ” Checking for hardcoded GOEXPERIMENT..."

          if grep -r \
              --exclude-dir=.git \
              --exclude-dir=node_modules \
              --exclude-dir=docs/dev/sources \
              --exclude-dir=.github/docs \
              --exclude-dir=.analysis \
              --exclude-dir=.shared \
              --exclude-dir=.zed \
              --exclude="00_SOURCE_OF_TRUTH.md" --exclude="_versions.yml" \
              --exclude="validate-sot.yml" \
              "GOEXPERIMENT: greenteagc,jsonv2" . 2>/dev/null | \
              grep "\.yml\|\.yaml" | \
              grep -v "needs.versions.outputs.goexperiment"; then
            echo "âŒ Found hardcoded GOEXPERIMENT in workflows"
            echo "Use: needs.versions.outputs.goexperiment instead"
            exit 1
          else
            echo "âœ… No hardcoded GOEXPERIMENT found in workflows!"
          fi

      - name: Verify SOURCE_OF_TRUTH format
        run: |
          echo "ðŸ” Verifying SOURCE_OF_TRUTH.md format..."

          SOT_FILE="docs/dev/design/00_SOURCE_OF_TRUTH.md"

          # Check required fields exist
          if ! grep -q "^\*\*Go Version\*\*:" "$SOT_FILE"; then
            echo "âŒ Missing '**Go Version**:' in SOURCE_OF_TRUTH"
            exit 1
          fi

          if ! grep -q "^\*\*Node\.js\*\*:" "$SOT_FILE"; then
            echo "âŒ Missing '**Node.js**:' in SOURCE_OF_TRUTH"
            exit 1
          fi

          if ! grep -q "^\*\*Python\*\*:" "$SOT_FILE"; then
            echo "âŒ Missing '**Python**:' in SOURCE_OF_TRUTH"
            exit 1
          fi

          if ! grep -q "^\*\*PostgreSQL\*\*:" "$SOT_FILE"; then
            echo "âŒ Missing '**PostgreSQL**:' in SOURCE_OF_TRUTH"
            exit 1
          fi

          if ! grep -q "^\*\*Build Command\*\*:" "$SOT_FILE"; then
            echo "âŒ Missing '**Build Command**:' in SOURCE_OF_TRUTH"
            exit 1
          fi

          echo "âœ… SOURCE_OF_TRUTH format is valid!"

      - name: Test version extraction
        run: |
          echo "ðŸ” Testing version extraction..."

          SOT_FILE="docs/dev/design/00_SOURCE_OF_TRUTH.md"

          # Test Go version extraction
          GO_VERSION=$(grep "^\*\*Go Version\*\*:" "$SOT_FILE" | sed 's/.*: //')
          if [ -z "$GO_VERSION" ]; then
            echo "âŒ Failed to extract Go version"
            exit 1
          fi
          echo "âœ… Extracted Go version: $GO_VERSION"

          # Test GOEXPERIMENT extraction
          GOEXPERIMENT=$(grep "^\*\*Build Command\*\*:" "$SOT_FILE" | sed -n 's/.*GOEXPERIMENT=\([^ ]*\).*/\1/p')
          if [ -z "$GOEXPERIMENT" ]; then
            echo "âŒ Failed to extract GOEXPERIMENT"
            exit 1
          fi
          echo "âœ… Extracted GOEXPERIMENT: $GOEXPERIMENT"

          # Test PostgreSQL version extraction
          POSTGRES_VERSION=$(grep "^\*\*PostgreSQL\*\*:" "$SOT_FILE" | sed 's/.*: //;s/ .*//')
          if [ -z "$POSTGRES_VERSION" ]; then
            echo "âŒ Failed to extract PostgreSQL version"
            exit 1
          fi
          echo "âœ… Extracted PostgreSQL version: $POSTGRES_VERSION"

          # Test Python version extraction
          PYTHON_VERSION=$(grep "^\*\*Python\*\*:" "$SOT_FILE" | sed 's/.*: //')
          if [ -z "$PYTHON_VERSION" ]; then
            echo "âŒ Failed to extract Python version"
            exit 1
          fi
          echo "âœ… Extracted Python version: $PYTHON_VERSION"

          # Test Node.js version extraction
          NODE_VERSION=$(grep "^\*\*Node\.js\*\*:" "$SOT_FILE" | sed 's/.*: //;s/ .*//')
          if [ -z "$NODE_VERSION" ]; then
            echo "âŒ Failed to extract Node.js version"
            exit 1
          fi
          echo "âœ… Extracted Node.js version: $NODE_VERSION"

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: validate-no-hardcoded-versions
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## ðŸ“‹ SOURCE_OF_TRUTH Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate-no-hardcoded-versions.result }}" == "success" ]; then
            echo "âœ… **All checks passed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- No hardcoded versions found" >> $GITHUB_STEP_SUMMARY
            echo "- SOURCE_OF_TRUTH format is valid" >> $GITHUB_STEP_SUMMARY
            echo "- Version extraction working correctly" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Validation failed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please ensure all versions are defined in SOURCE_OF_TRUTH" >> $GITHUB_STEP_SUMMARY
            echo "and referenced via the _versions.yml workflow." >> $GITHUB_STEP_SUMMARY
          fi
