name: Coverage

on:
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write

env:
  GO_VERSION: "1.26"
  GOEXPERIMENT: jsonv2,goroutineleakprofile,simd,runtimesecret

jobs:
  coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends pkg-config libvips-dev nasm
      - name: Build FFmpeg 8.0 from source
        run: |
          git clone --depth 1 --branch n8.0 https://github.com/FFmpeg/FFmpeg.git /tmp/ffmpeg
          cd /tmp/ffmpeg
          ./configure --prefix=/usr/local --enable-shared --disable-static --disable-programs --disable-doc --disable-x86asm
          make -j$(nproc)
          sudo make install
          sudo ldconfig
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Run tests with coverage
        run: go test -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Generate coverage summary
        run: |
          go tool cover -func=coverage.out -o=coverage.txt
          go tool cover -html=coverage.out -o=coverage.html

      - uses: codecov/codecov-action@v5
        with:
          files: ./coverage.out
          flags: unittests
          fail_ci_if_error: false

      - uses: actions/upload-artifact@v7
        with:
          name: coverage-report
          path: |
            coverage.out
            coverage.txt
            coverage.html
          retention-days: 30

      - name: Comment PR with coverage
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const coverage = fs.readFileSync('coverage.txt', 'utf8');
            const body = `## Coverage Report\n\n\`\`\`\n${coverage}\n\`\`\`\n\n> Generated by GitHub Actions`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Coverage Report')
            );

            const params = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            };

            if (botComment) {
              await github.rest.issues.updateComment({ ...params, comment_id: botComment.id });
            } else {
              await github.rest.issues.createComment({ ...params, issue_number: context.issue.number });
            }
