name: Weekly Source Refresh

on:
  schedule:
    # Run every Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      force:
        description: 'Force update even if unchanged'
        required: false
        default: false
        type: boolean
      category:
        description: 'Specific category to refresh (leave empty for all)'
        required: false
        type: string

jobs:
  # Extract versions from SOURCE_OF_TRUTH first
  versions:
    name: Get versions from SOURCE_OF_TRUTH
    uses: ./.github/workflows/_versions.yml

  refresh-sources:
    runs-on: ubuntu-latest
    needs: versions
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.versions.outputs.python-version }}

      - name: Install dependencies
        run: pip install -r scripts/requirements.txt

      - name: Run source pipeline
        run: |
          ARGS="--apply"
          if [ "${{ github.event.inputs.force }}" = "true" ]; then
            ARGS="$ARGS --force"
          fi
          if [ -n "${{ github.event.inputs.category }}" ]; then
            ARGS="$ARGS --category ${{ github.event.inputs.category }}"
          fi
          python scripts/source-pipeline/01-fetch.py $ARGS
          python scripts/source-pipeline/02-index.py --apply
          python scripts/source-pipeline/03-breadcrumbs.py --apply

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'docs: refresh external sources'
          title: 'ðŸ“š Weekly Source Refresh'
          body: |
            ## Summary

            Automated weekly refresh of external documentation sources.

            ### Changes

            This PR updates fetched documentation from external sources including:
            - API documentation (TMDB, TVDB, etc.)
            - Package documentation (Go, npm)
            - Protocol specifications

            ### Review Checklist

            - [ ] Check INDEX.yaml for any failed fetches
            - [ ] Verify SOURCES.md is properly formatted
            - [ ] Confirm breadcrumbs are correctly updated

            ---
            ðŸ¤– Generated by [Weekly Source Refresh](.github/workflows/source-refresh.yml)
          branch: auto/source-refresh
          delete-branch: true
          labels: |
            documentation
            automated
