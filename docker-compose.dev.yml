# Development docker-compose with all required services
# PostgreSQL 18+, Dragonfly, Typesense

services:
  revenge:
    build:
      context: .
      dockerfile: Dockerfile
    image: revenge/revenge:dev
    container_name: revenge-dev
    ports:
      - "8096:8096"
      - "2345:2345"  # Delve debugger port
    environment:
      - REVENGE_LOG_LEVEL=debug
      - REVENGE_LOG_FORMAT=console
      - REVENGE_SERVER_PORT=8096
      - REVENGE_DATABASE_HOST=postgres
      - REVENGE_DATABASE_PORT=5432
      - REVENGE_DATABASE_USER=revenge
      - REVENGE_DATABASE_PASSWORD=revenge_dev_pass
      - REVENGE_DATABASE_NAME=revenge
      - REVENGE_CACHE_ADDR=dragonfly:6379
      - REVENGE_SEARCH_HOST=typesense
      - REVENGE_SEARCH_PORT=8108
      - REVENGE_SEARCH_API_KEY=dev_api_key
    volumes:
      - ./:/app
      - revenge-data:/data
      - revenge-config:/config
      - revenge-cache:/cache
      - ./testdata/media:/media:ro
    depends_on:
      postgres:
        condition: service_healthy
      dragonfly:
        condition: service_healthy
      typesense:
        condition: service_healthy
    restart: unless-stopped

  # PostgreSQL 18+ (REQUIRED)
  postgres:
    image: postgres:18-alpine
    container_name: revenge-postgres-dev
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=revenge
      - POSTGRES_USER=revenge
      - POSTGRES_PASSWORD=revenge_dev_pass
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U revenge"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Dragonfly (Redis-compatible, REQUIRED)
  dragonfly:
    image: docker.dragonflydb.io/dragonflydb/dragonfly:latest
    container_name: revenge-dragonfly-dev
    command: ["--maxmemory=1gb", "--maxmemory-policy=allkeys-lru"]
    ports:
      - "6379:6379"
    volumes:
      - dragonfly-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Typesense 0.25+ (REQUIRED)
  typesense:
    image: typesense/typesense:0.25.2
    container_name: revenge-typesense-dev
    ports:
      - "8108:8108"
    environment:
      - TYPESENSE_DATA_DIR=/data
      - TYPESENSE_API_KEY=dev_api_key
      - TYPESENSE_ENABLE_CORS=true
    volumes:
      - typesense-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8108/health"]
      interval: 5s
      timeout: 3s
      retries: 5

  # pgAdmin (optional - for database management)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: revenge-pgadmin-dev
    ports:
      - "5050:80"
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@revenge.local
      - PGADMIN_DEFAULT_PASSWORD=admin
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    depends_on:
      - postgres
    profiles:
      - tools

volumes:
  revenge-data:
  revenge-config:
  revenge-cache:
  postgres-data:
  dragonfly-data:
  typesense-data:
  pgadmin-data:
