# Development docker-compose with all required services
# PostgreSQL 18+, Dragonfly, Typesense
# Tuned for dev/small-prod (~14GB total memory across all services)

services:
  revenge:
    build:
      context: .
      dockerfile: Dockerfile
    image: revenge/revenge:dev
    container_name: revenge-dev
    ports:
      - "8096:8096"
      - "9096:9096"  # Prometheus metrics port
      - "2345:2345"  # Delve debugger port
    environment:
      - REVENGE_LOG_LEVEL=debug
      - REVENGE_LOG_FORMAT=console
      - REVENGE_SERVER_PORT=8096
      - REVENGE_DATABASE_URL=postgres://revenge:revenge_dev_pass@postgres:5432/revenge?sslmode=disable&search_path=public,shared,movie,tvshow
      - REVENGE_CACHE_ENABLED=true
      - REVENGE_CACHE_URL=redis://dragonfly:6379
      - REVENGE_SEARCH_ENABLED=true
      - REVENGE_SEARCH_URL=http://typesense:8108
      - REVENGE_SEARCH_API_KEY=dev_api_key
      # Rate limiting - relaxed for dev/testing
      # (live smoke tests fire many register+login requests concurrently)
      - REVENGE_SERVER_RATE_LIMIT_ENABLED=true
      - REVENGE_SERVER_RATE_LIMIT_GLOBAL_REQUESTS_PER_SECOND=200
      - REVENGE_SERVER_RATE_LIMIT_GLOBAL_BURST=1000
      - REVENGE_SERVER_RATE_LIMIT_AUTH_REQUESTS_PER_SECOND=50
      - REVENGE_SERVER_RATE_LIMIT_AUTH_BURST=200
      # Playback - relaxed for load testing
      - REVENGE_PLAYBACK_MAX_CONCURRENT_SESSIONS=100
      - REVENGE_PLAYBACK_SESSION_TIMEOUT=5m
      # Radarr integration
      - REVENGE_INTEGRATIONS_RADARR_ENABLED=true
      - REVENGE_INTEGRATIONS_RADARR_BASE_URL=http://radarr:7878
      - REVENGE_INTEGRATIONS_RADARR_API_KEY=39314e5cb02942a49ee73eb474ba6f9c
      # Sonarr integration
      - REVENGE_INTEGRATIONS_SONARR_ENABLED=true
      - REVENGE_INTEGRATIONS_SONARR_BASE_URL=http://sonarr:8989
      - REVENGE_INTEGRATIONS_SONARR_API_KEY=31f3baf2872f4769921ba2bdd29f9457
    volumes:
      # ./:/app - Disabled for Docker-based testing (overwrites binary)
      - revenge-data:/data
      - revenge-config:/config
      - revenge-cache:/cache
      - ./testdata/media:/media:ro
      - ./.workingdir11:/movies:ro
    depends_on:
      postgres:
        condition: service_healthy
      dragonfly:
        condition: service_healthy
      typesense:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 8G

  # Frontend (SvelteKit + nginx) — with dev proxy to backend
  frontend:
    build:
      context: ./web
      dockerfile: Dockerfile
    image: revenge/revenge-frontend:dev
    container_name: revenge-frontend-dev
    ports:
      - "4000:3000"
    depends_on:
      revenge:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          memory: 128M

  # PostgreSQL 18+ (REQUIRED)
  # Tuned for moderate writes (library scans) + heavy reads (API serving)
  postgres:
    image: postgres:18-alpine
    container_name: revenge-postgres-dev
    shm_size: 256mb  # Required for shared_buffers > default
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=revenge
      - POSTGRES_USER=revenge
      - POSTGRES_PASSWORD=revenge_dev_pass
    command:
      - postgres
      # Memory: 2GB container, 25% shared_buffers
      - -c
      - shared_buffers=512MB
      - -c
      - effective_cache_size=1536MB
      - -c
      - maintenance_work_mem=128MB
      - -c
      - work_mem=16MB
      # WAL: tuned for moderate write load
      - -c
      - wal_buffers=16MB
      - -c
      - checkpoint_completion_target=0.9
      - -c
      - checkpoint_timeout=15min
      - -c
      - max_wal_size=1GB
      - -c
      - min_wal_size=256MB
      - -c
      - wal_compression=on
      # Query planner: SSD-optimized
      - -c
      - random_page_cost=1.1
      - -c
      - effective_io_concurrency=200
      # Connections
      - -c
      - max_connections=100
      # Autovacuum: active for metadata-heavy workload
      - -c
      - autovacuum_max_workers=3
      - -c
      - autovacuum_naptime=30s
      # Logging: only slow queries
      - -c
      - log_min_duration_statement=1000
      - -c
      - log_statement=none
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U revenge -d revenge"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

  # Dragonfly (Redis-compatible, REQUIRED)
  # Pure cache mode: LFRU eviction, no persistence
  # NOTE: --cluster_mode=emulated is required for rueidis client compatibility
  dragonfly:
    image: docker.dragonflydb.io/dragonflydb/dragonfly:latest
    container_name: revenge-dragonfly-dev
    ulimits:
      memlock: -1  # Required for Dragonfly memory management
    command:
      - dragonfly
      - --cluster_mode=emulated     # Required for rueidis client compatibility
      - --cache_mode=true           # LFRU eviction when approaching maxmemory
      - --maxmemory=1G              # 1GB cache (headroom within 1.5GB container)
      - --proactor_threads=2        # Match allocated CPUs
      - --dbfilename=               # Disable RDB snapshots (pure cache)
      - --logtostderr=true
    ports:
      - "6379:6379"
    volumes:
      - dragonfly-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 1536M
        reservations:
          memory: 512M

  # Typesense 27.1 (REQUIRED)
  # Full-text search for movie + tvshow libraries
  typesense:
    image: typesense/typesense:27.1
    container_name: revenge-typesense-dev
    command:
      - --data-dir=/data
      - --api-key=dev_api_key
      - --api-address=0.0.0.0
      - --api-port=8108
      - --thread-pool-size=8                   # 4x CPU cores for I/O-bound search
      - --num-collections-parallel-load=4      # Faster startup
      - --enable-cors=true
      - --log-slow-requests-time-ms=1000       # Log slow queries
      - --healthy-read-lag=1000                # Backpressure thresholds
      - --healthy-write-lag=500
      - --snapshot-interval-seconds=3600       # Snapshot every hour
      - --reset-peers-on-error=false           # Single-node setup
    ports:
      - "8108:8108"
    volumes:
      - typesense-data:/data
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/8108'"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1536M
        reservations:
          memory: 512M

  # pgAdmin (optional - for database management)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: revenge-pgadmin-dev
    ports:
      - "5050:80"
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@revenge.local
      - PGADMIN_DEFAULT_PASSWORD=admin
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    depends_on:
      - postgres
    profiles:
      - tools

  # Prometheus (optional - scrapes revenge metrics)
  prometheus:
    image: prom/prometheus:latest
    container_name: revenge-prometheus-dev
    ports:
      - "9090:9090"
    volumes:
      - ./deploy/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.retention.time=7d
      - --web.enable-lifecycle
    depends_on:
      - revenge
    profiles:
      - tools
    deploy:
      resources:
        limits:
          memory: 512M

  # nginx-prometheus-exporter (optional - scrapes frontend stub_status)
  nginx-exporter:
    image: nginx/nginx-prometheus-exporter:latest
    container_name: revenge-nginx-exporter-dev
    command:
      - --nginx.scrape-uri=http://revenge-frontend-dev:3000/stub_status
    depends_on:
      - frontend
    profiles:
      - tools
    deploy:
      resources:
        limits:
          memory: 64M

  # Grafana (optional - pre-provisioned dashboards)
  grafana:
    image: grafana/grafana:latest
    container_name: revenge-grafana-dev
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ./deploy/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./deploy/grafana/provisioning/dashboards:/var/lib/grafana/dashboards:ro
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
    profiles:
      - tools
    deploy:
      resources:
        limits:
          memory: 256M

  # Radarr — Movie management (PVR)
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: revenge-radarr-dev
    ports:
      - "7878:7878"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Berlin
    volumes:
      - radarr-config:/config
      - media-data:/media
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:7878/ping || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 512M

  # Sonarr — TV show management (PVR)
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: revenge-sonarr-dev
    ports:
      - "8989:8989"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Berlin
    volumes:
      - sonarr-config:/config
      - media-data:/media
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8989/ping || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 512M

volumes:
  revenge-data:
  revenge-config:
  revenge-cache:
  postgres-data:
  dragonfly-data:
  typesense-data:
  pgadmin-data:
  prometheus-data:
  grafana-data:
  radarr-config:
  sonarr-config:
  media-data:
