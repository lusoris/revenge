# Production docker-compose
# All services are REQUIRED: PostgreSQL 18+, Dragonfly, Typesense

services:
  revenge:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: ${VERSION:-dev}
        BUILD_TIME: ${BUILD_TIME:-unknown}
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
    image: revenge/revenge:${VERSION:-latest}
    container_name: revenge
    ports:
      - "8096:8096"
    environment:
      - REVENGE_LOG_LEVEL=info
      - REVENGE_LOG_FORMAT=json
      - REVENGE_SERVER_PORT=8096
      - REVENGE_DATABASE_HOST=postgres
      - REVENGE_DATABASE_PORT=5432
      - REVENGE_DATABASE_USER=revenge
      - REVENGE_DATABASE_PASSWORD=${DB_PASSWORD:?DB_PASSWORD is required}
      - REVENGE_DATABASE_NAME=revenge
      - REVENGE_DATABASE_SSL_MODE=disable
      - REVENGE_CACHE_ADDR=dragonfly:6379
      - REVENGE_SEARCH_HOST=typesense
      - REVENGE_SEARCH_PORT=8108
      - REVENGE_SEARCH_API_KEY=${TYPESENSE_API_KEY:?TYPESENSE_API_KEY is required}
    volumes:
      - revenge-data:/data
      - revenge-config:/config
      - ./media:/media:ro
    depends_on:
      postgres:
        condition: service_healthy
      dragonfly:
        condition: service_healthy
      typesense:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8096/health/live"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # PostgreSQL 18+ (REQUIRED)
  postgres:
    image: postgres:18-alpine
    container_name: revenge-postgres
    environment:
      - POSTGRES_DB=revenge
      - POSTGRES_USER=revenge
      - POSTGRES_PASSWORD=${DB_PASSWORD:?DB_PASSWORD is required}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U revenge"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Dragonfly (REQUIRED)
  dragonfly:
    image: docker.dragonflydb.io/dragonflydb/dragonfly:latest
    container_name: revenge-dragonfly
    command: ["--maxmemory=2gb", "--maxmemory-policy=allkeys-lru"]
    volumes:
      - dragonfly-data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Typesense 0.25+ (REQUIRED)
  typesense:
    image: typesense/typesense:0.25.2
    container_name: revenge-typesense
    environment:
      - TYPESENSE_DATA_DIR=/data
      - TYPESENSE_API_KEY=${TYPESENSE_API_KEY:?TYPESENSE_API_KEY is required}
    volumes:
      - typesense-data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8108/health"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  revenge-data:
  revenge-config:
  postgres-data:
  dragonfly-data:
  typesense-data:
