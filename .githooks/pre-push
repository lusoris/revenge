#!/bin/sh

# Pre-push hook for Revenge
# Runs comprehensive checks before pushing

set -e

echo "ğŸš€ Running pre-push checks..."

BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Don't allow direct push to main
if [ "$BRANCH" = "main" ]; then
    echo "âŒ Direct pushes to main branch are not allowed!"
    echo "   Please create a pull request instead"
    exit 1
fi

# Run full test suite before pushing to develop
if [ "$BRANCH" = "develop" ]; then
    echo "ğŸ§ª Running full test suite for develop branch..."
    if ! go test -race ./... 2>&1; then
        echo "âŒ Tests failed on develop branch"
        exit 1
    fi
    echo "âœ… All tests passed"
fi

# Run linter
echo "ğŸ” Running linter..."
if command -v golangci-lint &> /dev/null; then
    if ! golangci-lint run --timeout=3m 2>&1; then
        echo "âŒ Linter found issues"
        echo "   Run 'make lint' locally to see details"
        exit 1
    fi
    echo "âœ… Linter passed"
else
    echo "âš ï¸  golangci-lint not found, skipping linter check"
    echo "   Install: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest"
fi

# Build check
echo "ğŸ”¨ Checking if code builds..."
if ! GOEXPERIMENT=greenteagc,jsonv2 go build ./cmd/revenge 2>&1; then
    echo "âŒ Build failed"
    exit 1
fi
echo "âœ… Build successful"

echo "âœ… All pre-push checks passed!"
exit 0
