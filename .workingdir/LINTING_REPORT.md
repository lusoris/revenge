# Linting Report - Revenge Project

**Date**: 2026-02-04
**Linter**: golangci-lint v1.64.8
**Status**: ‚ùå COMPILATION ERRORS PREVENT LINTING

---

## Executive Summary

The project has **compilation errors** that prevent golangci-lint from running successfully. These are NOT style/quality issues but fundamental build problems that must be resolved before meaningful linting can occur.

### Critical Issues Found

1. **Movie Package CGO Dependencies** (69 errors)
   - Missing `astiav` package for media processing
   - Platform-specific (Linux/CGO) code failing on Windows

2. **Mock Naming Mismatch** (33 errors)
   - Tests reference `MockRepository` but mock is named `MockMovieRepository`
   - Affects `service_test.go` and `library_service_test.go`

3. **CGO Runtime Issue** (1 error)
   - "no export data for runtime/cgo"
   - Prevents goanalysis_metalinter from running

---

## Detailed Error Analysis

### 1. Missing CGO Dependency: `astiav`

**File**: `internal/content/movie/mediainfo.go`
**Error**: `undefined: astiav` (69 occurrences)
**Lines Affected**: 90, 111, 120, 124, 127, 137, 180, 205, 208, 214, 220, 233, 236, 243, 244, 250, 298, 301-435, 438, 441, 450

**Root Cause**:
- `astiav` is a Go wrapper for FFmpeg/libav (CGO dependency)
- Not available or not building correctly on Windows
- Platform-specific build requirements

**Impact**:
- Entire movie mediainfo extraction system cannot compile
- Prevents linting of entire codebase
- Blocks type checking and static analysis

**Recommendation**:
- Add build tags to separate CGO code: `//go:build !windows`
- Create Windows-compatible stub or alternative implementation
- Update CI to handle platform-specific builds
- Document FFmpeg/libav dependencies in setup guide

**Files to Fix**:
```
internal/content/movie/mediainfo.go
```

---

### 2. Mock Type Naming Mismatch

**Files**:
- `internal/content/movie/service_test.go` (33 occurrences)
- `internal/content/movie/library_service_test.go` (3 occurrences)

**Error**: `undefined: MockRepository`

**Root Cause**:
- Mock file defines `MockMovieRepository` (generated by mockery)
- Test files reference `MockRepository`
- Package is `movie_test` in mock file

**Current State**:
```go
// In mock_repository_test.go
package movie_test

type MockMovieRepository struct {
    mock.Mock
}
```

```go
// In service_test.go - INCORRECT
mockRepo := new(MockRepository)  // ‚ùå Doesn't exist
```

**Expected**:
```go
// Should be:
mockRepo := new(MockMovieRepository)  // ‚úÖ Correct
```

**Impact**:
- All movie service tests fail to compile
- 36 test functions affected
- Cannot run movie package tests

**Recommendation**:
**Option A** (Quick Fix):
- Find/replace `MockRepository` ‚Üí `MockMovieRepository` in test files
- Update all 36 test function declarations

**Option B** (Type Alias):
- Add type alias in test files: `type MockRepository = MockMovieRepository`
- Maintains existing test code

**Option C** (Regenerate Mocks):
- Update mockery configuration to generate `MockRepository` instead
- Regenerate mocks with correct naming

**Recommended**: Option A (most explicit)

---

### 3. CGO Runtime Export Data Missing

**Error**:
```
Can't run linter goanalysis_metalinter: buildir: failed to load package cgo:
could not load export data: no export data for "runtime/cgo"
```

**Root Cause**:
- CGO toolchain not properly configured on Windows
- Missing C compiler or CGO disabled
- Go installation issue

**Impact**:
- Advanced static analysis linters cannot run
- Type checking may be incomplete
- Some vulnerability checks skipped

**Recommendation**:
- Verify CGO environment:
  ```bash
  go env CGO_ENABLED
  gcc --version  # Check C compiler
  ```
- Install MinGW-w64 for Windows CGO support
- Consider setting `CGO_ENABLED=0` for Windows builds if CGO not needed

---

## Linter Configuration Issues

### Deprecated Option Found

**Warning**:
```
The configuration option `run.skip-dirs` is deprecated,
please use `issues.exclude-dirs`.
```

**Fix Required**:
Update `.golangci.yml` - if `run.skip-dirs` exists, replace with:
```yaml
issues:
  exclude-dirs:
    - path/to/exclude
```

---

## Summary Statistics

| Category | Count | Severity |
|----------|-------|----------|
| CGO `astiav` undefined | 69 | üî¥ CRITICAL |
| Mock naming mismatch | 36 | üî¥ CRITICAL |
| CGO runtime issue | 1 | üü° WARNING |
| Config deprecation | 1 | üü° WARNING |
| **TOTAL BLOCKING** | **105** | **CRITICAL** |

---

## Recommendations Priority

### Priority 1: Enable Compilation (CRITICAL)

1. **Fix Movie Package CGO Dependencies**
   - **Action**: Add build tags to separate platform-specific code
   - **File**: `internal/content/movie/mediainfo.go`
   - **Effort**: 1-2 hours
   - **Blocks**: All linting and testing

2. **Fix Mock Naming Mismatch**
   - **Action**: Replace `MockRepository` ‚Üí `MockMovieRepository` in tests
   - **Files**: `service_test.go`, `library_service_test.go`
   - **Effort**: 15 minutes
   - **Blocks**: Movie package tests

### Priority 2: Linter Configuration (MEDIUM)

3. **Update golangci-lint Configuration**
   - **Action**: Replace deprecated `run.skip-dirs` with `issues.exclude-dirs`
   - **File**: `.golangci.yml`
   - **Effort**: 5 minutes
   - **Impact**: Future-proofing

### Priority 3: CGO Setup (LOW - Optional)

4. **Configure CGO Environment**
   - **Action**: Install MinGW-w64, verify CGO setup
   - **Impact**: Enables full linting capabilities
   - **Effort**: 30 minutes
   - **Note**: May not be needed if platform-specific builds used

---

## Next Steps

### Immediate Actions

1. **Document Platform Limitations**
   - Add note to README about Windows build limitations
   - Document CGO dependencies for Linux/macOS builds

2. **Create Build Tags**
   ```go
   //go:build !windows
   // +build !windows

   package movie

   // CGO-dependent code here
   ```

3. **Create Windows Stubs**
   ```go
   //go:build windows
   // +build windows

   package movie

   // Stub implementations or error returns
   ```

4. **Fix Mock References**
   ```bash
   # In internal/content/movie/
   sed -i 's/MockRepository/MockMovieRepository/g' service_test.go library_service_test.go
   ```

### After Fixes Applied

1. **Re-run Linting**:
   ```bash
   golangci-lint run ./... --timeout=10m
   ```

2. **Generate Clean Report**:
   ```bash
   golangci-lint run ./... --out-format=json > linting_results.json
   golangci-lint run ./... --out-format=checkstyle > linting_results.xml
   ```

3. **Run Tests**:
   ```bash
   go test ./internal/content/movie/...
   ```

---

## Platform-Specific Build Strategy

### Recommended Approach

**Option 1**: Build Tags (Recommended)
- Separate CGO code with `//go:build` tags
- Maintain full functionality on Linux/macOS
- Graceful degradation on Windows

**Option 2**: Feature Flags
- Runtime detection of CGO availability
- Conditional mediainfo extraction
- More complex but more flexible

**Option 3**: External Binary
- Use standalone FFmpeg binary
- Shell out for media analysis
- Platform-independent but slower

---

## Conclusion

The codebase **cannot be linted** in its current state due to compilation errors. The issues are:

1. ‚úÖ **Fixable**: Mock naming mismatch (15 min fix)
2. ‚ö†Ô∏è **Requires Architecture**: CGO dependencies need platform isolation
3. üü° **Optional**: CGO environment setup

**Estimated Time to Lintable State**: 2-3 hours

**Critical Path**:
1. Add build tags to `mediainfo.go`
2. Fix mock naming in test files
3. Re-run linting

---

**Report Generated**: 2026-02-04
**Next Action**: Apply Priority 1 fixes to enable linting
