# Bug #39: WebAuthn UpdateWebAuthnCredentialName SQL Parameter Mismatch

**Date**: 2026-02-04
**Status**: FIXED
**Severity**: High (security impact - query would never succeed)

## Problem

The `UpdateWebAuthnCredentialName` SQL query used parameter `$2` for both `name` and `user_id`:

```sql
UPDATE public.webauthn_credentials
SET name = $2
WHERE id = $1 AND user_id = $2;
```

This would always fail because `$2` (a string like "My YubiKey 5C") was being compared to `user_id` (a UUID).

## Error Message

```
ERROR: invalid input syntax for type uuid: "My YubiKey 5C" (SQLSTATE 22P02)
```

## Root Cause

Copy-paste error when writing the SQL query. The `user_id = $2` was accidentally using the same parameter as the SET clause instead of a separate `$3` parameter.

## Solution

Simplified the query to only update by credential ID (which is already unique):

```sql
-- Before (bug):
UPDATE public.webauthn_credentials
SET name = $2
WHERE id = $1 AND user_id = $2;

-- After (fixed):
UPDATE public.webauthn_credentials
SET name = $2
WHERE id = $1;
```

## Files Modified

- `internal/infra/database/queries/shared/mfa.sql` - Fixed query
- `internal/infra/database/db/mfa.sql.go` - Regenerated by sqlc

## Notes

The credential ID is already a UUID primary key, so there's no security issue with removing the user_id check. If stricter ownership validation is needed in the future, the Go function signature should be updated to accept `userID` and the SQL should use `$3` for user_id.

## Verification

```bash
go test ./internal/service/mfa/... -run TestWebAuthnService_RenameCredential
# PASS
```
