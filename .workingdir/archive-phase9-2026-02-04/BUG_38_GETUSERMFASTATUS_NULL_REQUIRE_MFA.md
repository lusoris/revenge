# Bug #38: GetUserMFAStatus NULL require_mfa Scan Failure

**Date**: 2026-02-04
**Status**: FIXED
**Severity**: Medium

## Problem

The `GetUserMFAStatus` SQL query returned NULL for the `require_mfa` column when no `user_mfa_settings` row existed for the user. The generated Go code expected a non-nullable `bool`, causing the scan to fail.

When the scan failed, `manager.GetStatus()` would catch the error and return a default status with all values set to false/zero, even when TOTP was enabled or backup codes existed.

## Root Cause

The SQL query used a subquery that returns NULL when no matching row exists:
```sql
(SELECT require_mfa FROM public.user_mfa_settings WHERE user_mfa_settings.user_id = $1) as require_mfa
```

sqlc generated:
```go
type GetUserMFAStatusRow struct {
    HasTotp           bool  `json:"hasTotp"`
    WebauthnCount     int64 `json:"webauthnCount"`
    UnusedBackupCodes int64 `json:"unusedBackupCodes"`
    RequireMfa        bool  `json:"requireMfa"`  // Cannot scan NULL into this!
}
```

## Symptoms

1. `TestMFAManager_GetStatus/returns_status_after_TOTP_setup` - `HasTOTP` was false when it should be true
2. `TestMFAManager_GetStatus/returns_status_after_backup_codes_generation` - `UnusedBackupCodes` was 0 when it should be 10

## Solution

Added `COALESCE` with explicit boolean cast to handle NULL values:

```sql
-- Before (bug):
(SELECT require_mfa FROM public.user_mfa_settings WHERE user_mfa_settings.user_id = $1) as require_mfa

-- After (fixed):
COALESCE((SELECT require_mfa FROM public.user_mfa_settings WHERE user_mfa_settings.user_id = $1), false)::boolean as require_mfa
```

## Files Modified

- `internal/infra/database/queries/shared/mfa.sql` - Added COALESCE and ::boolean cast
- `internal/infra/database/db/mfa.sql.go` - Regenerated by sqlc

## Verification

```bash
go test ./internal/service/mfa/... -run TestMFAManager_GetStatus
# PASS: All 3 subtests pass
```

## Lesson Learned

When using scalar subqueries in SQL that return a single value (not aggregates like COUNT), always use COALESCE to provide a default when no row matches. sqlc infers types from the query, and NULL values require nullable types.
