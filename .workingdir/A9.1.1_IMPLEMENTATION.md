# A9.1.1 Implementation: Movie Multi-Language Database Migration

**Status**: ✅ COMPLETE
**Date**: 2026-02-05
**Priority**: P0 (Critical - Foundation for Multi-Language Support)

## Overview

Created database migration to add multi-language support to the movies table. This migration enables storing titles, taglines, overviews, and age ratings in multiple languages using PostgreSQL JSONB columns with a hybrid approach for optimal performance.

## Changes Made

### 1. Migration Files

#### migrations/000031_movie_multilanguage.up.sql (NEW)
Comprehensive migration to add multi-language support:

**New JSONB Columns**:
- `titles_i18n JSONB` - Movie titles by language code
- `taglines_i18n JSONB` - Taglines by language code
- `overviews_i18n JSONB` - Plot summaries by language code
- `age_ratings JSONB` - Age ratings by country and rating system

**Data Structure Examples**:
```json
// titles_i18n
{"en": "The Shawshank Redemption", "de": "Die Verurteilten", "fr": "Les Évadés"}

// age_ratings
{"US": {"MPAA": "R"}, "DE": {"FSK": "12"}, "GB": {"BBFC": "15"}}
```

**Key Features**:
1. Uses `IF NOT EXISTS` for idempotent migrations
2. Migrates existing English data: `UPDATE movies SET titles_i18n = jsonb_build_object('en', title)`
3. Only migrates unmigrated rows: `WHERE titles_i18n = '{}'::jsonb`
4. Handles NULL values correctly with CASE statements
5. Creates GIN indexes for efficient JSONB queries
6. Creates B-tree index for `original_language` filtering

**Indexes Created**:
- `idx_movies_titles_i18n` (GIN) - Fast title lookups by language
- `idx_movies_taglines_i18n` (GIN) - Tagline searches
- `idx_movies_overviews_i18n` (GIN) - Overview text searches
- `idx_movies_age_ratings` (GIN) - Age rating queries
- `idx_movies_original_language` (B-tree) - Language filtering

#### migrations/000031_movie_multilanguage.down.sql (NEW)
Rollback migration that:
- Drops all new indexes
- Drops JSONB columns (titles_i18n, taglines_i18n, overviews_i18n, age_ratings)
- Preserves `original_language` (existed before this migration)
- Keeps default fields (title, tagline, overview) intact

**Important**: The down migration does NOT drop `original_language` because it was part of the original movies table schema (migration 000021).

## Architecture

### Hybrid Approach

**Rationale**: Balance performance with flexibility

**Default Fields** (kept for performance):
```sql
title TEXT NOT NULL        -- Fast queries, no JSON parsing
tagline TEXT
overview TEXT
original_language TEXT      -- Already existed
```

**I18N Fields** (added for multi-language):
```sql
titles_i18n JSONB          -- {"en": "...", "de": "...", "fr": "..."}
taglines_i18n JSONB
overviews_i18n JSONB
age_ratings JSONB          -- {"US": {"MPAA": "R"}, "DE": {"FSK": "12"}}
```

**Why Hybrid**:
1. **Performance**: Simple queries use default fields (no JSON overhead)
2. **Flexibility**: Multi-language queries use JSONB fields
3. **Backwards Compatibility**: Existing code continues to work
4. **Migration Safety**: Can be rolled back cleanly

### Data Migration Strategy

**Existing Data Handling**:
```sql
UPDATE movies
SET
    original_language = COALESCE(original_language, 'en'),
    titles_i18n = jsonb_build_object('en', title),
    taglines_i18n = CASE
        WHEN tagline IS NOT NULL AND tagline != ''
        THEN jsonb_build_object('en', tagline)
        ELSE '{}'::jsonb
    END,
    overviews_i18n = CASE
        WHEN overview IS NOT NULL AND overview != ''
        THEN jsonb_build_object('en', overview)
        ELSE '{}'::jsonb
    END
WHERE titles_i18n = '{}'::jsonb;
```

**Migration Logic**:
1. Check if row already migrated (`titles_i18n = '{}'::jsonb`)
2. Set `original_language` to 'en' if NULL
3. Copy `title` to `titles_i18n['en']`
4. Copy non-empty `tagline` to `taglines_i18n['en']`
5. Copy non-empty `overview` to `overviews_i18n['en']`

**Idempotent**: Can be run multiple times safely

### Index Strategy

**GIN Indexes** (Generalized Inverted Index):
- Used for JSONB columns
- Efficient for key existence checks: `titles_i18n ? 'de'`
- Efficient for containment: `titles_i18n @> '{"en": "Shawshank"}'`
- Supports full-text search within JSONB values

**B-tree Index**:
- Used for `original_language` column
- Fast equality and range queries
- Optimal for filtering: `WHERE original_language = 'ja'`

## Language Support

### ISO 639-1 Language Codes

**Primary Languages Supported**:
- `en` - English (default, fallback)
- `de` - German (Deutsch)
- `fr` - French (Français)
- `es` - Spanish (Español)
- `ja` - Japanese (日本語)
- `ko` - Korean (한국어)
- `zh` - Chinese (中文)
- `pt` - Portuguese (Português)
- `ru` - Russian (Русский)
- `it` - Italian (Italiano)

**Extensible**: Any ISO 639-1 code supported (40+ languages from TMDb)

### Age Rating Systems

**Supported Country/Rating Systems**:

| Country | System | Values |
|---------|--------|--------|
| **US** | MPAA | G, PG, PG-13, R, NC-17 |
| **DE** | FSK | 0, 6, 12, 16, 18 |
| **GB** | BBFC | U, PG, 12, 12A, 15, 18 |
| **FR** | CNC | U, 10, 12, 16, 18 |
| **JP** | Eirin | G, PG12, R15+, R18+ |
| **KR** | KMRB | All, 12, 15, 18 |
| **BR** | DJCTQ | L, 10, 12, 14, 16, 18 |
| **AU** | ACB | G, PG, M, MA15+, R18+ |

**Data Structure**:
```json
{
  "US": {"MPAA": "R"},
  "DE": {"FSK": "12"},
  "GB": {"BBFC": "15"},
  "FR": {"CNC": "12"}
}
```

## Query Examples

### Querying Multi-Language Data

**Get title in specific language**:
```sql
SELECT
    title,  -- Default field (usually English)
    titles_i18n->>'en' AS title_en,
    titles_i18n->>'de' AS title_de,
    titles_i18n->>'fr' AS title_fr
FROM movies
WHERE id = 'some-uuid';
```

**Get title with fallback chain** (user pref → original → English):
```sql
SELECT
    COALESCE(
        titles_i18n->>'de',          -- Preferred language
        titles_i18n->>original_language,  -- Original language
        titles_i18n->>'en',          -- English fallback
        title                         -- Default field fallback
    ) AS localized_title
FROM movies;
```

**Filter by original language**:
```sql
SELECT * FROM movies
WHERE original_language = 'ja'
ORDER BY release_date DESC;
```

**Check if translation exists**:
```sql
SELECT * FROM movies
WHERE titles_i18n ? 'de';  -- Has German title
```

**Get age rating for country**:
```sql
SELECT
    title,
    age_ratings->'US'->>'MPAA' AS us_rating,
    age_ratings->'DE'->>'FSK' AS de_rating
FROM movies
WHERE age_ratings ? 'US';
```

### Performance Queries

**Count movies by original language**:
```sql
SELECT original_language, COUNT(*)
FROM movies
GROUP BY original_language
ORDER BY COUNT(*) DESC;
```

**Find movies with multiple translations**:
```sql
SELECT title, jsonb_object_keys(titles_i18n) AS languages
FROM movies
WHERE jsonb_array_length(jsonb_object_keys(titles_i18n)::jsonb) > 1;
```

## Migration Execution

### Manual Testing

**Run migration**:
```bash
# Using migrate CLI
migrate -path migrations -database "postgres://user:pass@localhost/revenge?sslmode=disable" up

# Or using Go app
go run cmd/revenge/main.go migrate
```

**Verify migration**:
```sql
-- Check columns exist
\d movies

-- Check data migrated
SELECT
    title,
    titles_i18n,
    original_language
FROM movies
LIMIT 5;

-- Check indexes
\di *movies*i18n*
```

**Test queries**:
```sql
-- Test JSONB query
SELECT title, titles_i18n->>'en'
FROM movies
LIMIT 10;

-- Test GIN index usage
EXPLAIN SELECT * FROM movies WHERE titles_i18n ? 'de';
```

### Rollback Testing

**Test rollback**:
```bash
migrate -path migrations -database "postgres://..." down 1
```

**Verify rollback**:
```sql
-- Columns should be gone
\d movies

-- Indexes should be gone
\di *movies*i18n*

-- Original fields should remain
SELECT title, tagline, overview, original_language
FROM movies
LIMIT 5;
```

## Benefits

### Internationalization
- **Problem**: Can only display English metadata
- **Solution**: Store titles in 40+ languages
- **Result**: Users see content in their preferred language

### Accurate Metadata
- **Problem**: "The Shawshank Redemption" vs "Die Verurteilten" ambiguity
- **Solution**: Store both, show correct one based on user language
- **Result**: Better UX for international users

### Age Ratings
- **Problem**: MPAA R rating meaningless in Germany
- **Solution**: Store FSK 12, MPAA R, BBFC 15 simultaneously
- **Result**: Users see relevant rating system for their country

### Search & Discovery
- **Problem**: German users can't search for "Die Verurteilten"
- **Solution**: Index all language titles
- **Result**: Search works in any language

### Future-Proof
- **Problem**: Adding languages later requires massive refactoring
- **Solution**: JSONB schema flexible from day one
- **Result**: Easy to add new languages

## Performance Impact

### Storage Overhead

**Per Movie** (average):
- titles_i18n: ~200 bytes (5 languages × 40 chars average)
- taglines_i18n: ~300 bytes (5 languages × 60 chars)
- overviews_i18n: ~2KB (5 languages × 400 chars)
- age_ratings: ~100 bytes (5 countries × 20 chars)

**Total**: ~2.5 KB per movie

**For 10,000 movies**: ~25 MB

### Query Performance

**JSONB GIN Index**:
- Key lookup: O(log n) - Very fast
- Existence check: O(1) - Constant time
- Text search: Efficient with GIN index

**Compared to Relational**:
- JSONB: 1 row, 1 query
- Relational: N rows (1 per language), JOIN required
- Winner: JSONB for this use case (read-heavy, flexible schema)

### Index Size

**GIN indexes**: ~20-30% of JSONB data size
- titles_i18n index: ~5 MB for 10k movies
- overviews_i18n index: ~15 MB for 10k movies

**Total index overhead**: ~25 MB for 10k movies

## Future Enhancements

### Planned
- **A9.2**: Update Go domain models with i18n fields
- **A9.3**: Update sqlc queries for multi-language support
- **A9.4**: TMDb integration for multiple languages
- **A9.5**: User language preference API
- **A9.6**: Fallback chain implementation

### Possible
- **Automatic Translation**: Use translation APIs for missing languages
- **User Contributions**: Allow users to submit translations
- **Language Detection**: Auto-detect user language from browser
- **Search Aliases**: Search in any language, find all results

## Troubleshooting

### Migration Fails

**Error**: Column already exists
```
ERROR: column "titles_i18n" of relation "movies" already exists
```
**Solution**: Migration is idempotent, safe to ignore or use `IF NOT EXISTS`

**Error**: Cannot create GIN index
```
ERROR: access method "gin" does not exist
```
**Solution**: Enable pg_trgm extension: `CREATE EXTENSION IF NOT EXISTS pg_trgm;`

### Data Migration Issues

**Problem**: Some titles not migrated
**Check**:
```sql
SELECT COUNT(*) FROM movies WHERE titles_i18n = '{}'::jsonb;
```
**Solution**: Re-run migration or manually update:
```sql
UPDATE movies SET titles_i18n = jsonb_build_object('en', title)
WHERE titles_i18n = '{}'::jsonb;
```

### Query Performance

**Problem**: JSONB queries slow
**Check**: Verify GIN indexes exist:
```sql
\di idx_movies_titles_i18n
```
**Solution**: Create missing indexes or run `VACUUM ANALYZE movies;`

## References

- **PostgreSQL JSONB**: https://www.postgresql.org/docs/current/datatype-json.html
- **GIN Indexes**: https://www.postgresql.org/docs/current/gin-intro.html
- **ISO 639-1 Codes**: https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes
- **TMDb Languages**: https://developers.themoviedb.org/3/configuration/get-languages
- **Age Rating Systems**: https://en.wikipedia.org/wiki/Motion_picture_content_rating_system

---

**Phase A9.1.1 Complete**: Database schema migrated to support multi-language metadata with hybrid JSONB approach.
