// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: apikeys.sql

package db

import (
	"context"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgtype"
)

const countUserAPIKeys = `-- name: CountUserAPIKeys :one
SELECT COUNT(*) FROM shared.api_keys
WHERE user_id = $1 AND is_active = true
`

func (q *Queries) CountUserAPIKeys(ctx context.Context, userID uuid.UUID) (int64, error) {
	row := q.db.QueryRow(ctx, countUserAPIKeys, userID)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const createAPIKey = `-- name: CreateAPIKey :one
INSERT INTO shared.api_keys (
    user_id,
    name,
    description,
    key_hash,
    key_prefix,
    scopes,
    expires_at
) VALUES (
    $1, $2, $3, $4, $5, $6, $7
) RETURNING id, user_id, name, description, key_hash, key_prefix, scopes, is_active, expires_at, last_used_at, created_at, updated_at
`

type CreateAPIKeyParams struct {
	UserID      uuid.UUID          `json:"userId"`
	Name        string             `json:"name"`
	Description *string            `json:"description"`
	KeyHash     string             `json:"keyHash"`
	KeyPrefix   string             `json:"keyPrefix"`
	Scopes      []string           `json:"scopes"`
	ExpiresAt   pgtype.Timestamptz `json:"expiresAt"`
}

func (q *Queries) CreateAPIKey(ctx context.Context, arg CreateAPIKeyParams) (SharedApiKey, error) {
	row := q.db.QueryRow(ctx, createAPIKey,
		arg.UserID,
		arg.Name,
		arg.Description,
		arg.KeyHash,
		arg.KeyPrefix,
		arg.Scopes,
		arg.ExpiresAt,
	)
	var i SharedApiKey
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.Name,
		&i.Description,
		&i.KeyHash,
		&i.KeyPrefix,
		&i.Scopes,
		&i.IsActive,
		&i.ExpiresAt,
		&i.LastUsedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const deleteAPIKey = `-- name: DeleteAPIKey :exec
DELETE FROM shared.api_keys
WHERE id = $1
`

func (q *Queries) DeleteAPIKey(ctx context.Context, id uuid.UUID) error {
	_, err := q.db.Exec(ctx, deleteAPIKey, id)
	return err
}

const deleteExpiredAPIKeys = `-- name: DeleteExpiredAPIKeys :exec
DELETE FROM shared.api_keys
WHERE expires_at IS NOT NULL
  AND expires_at < NOW()
  AND is_active = false
`

func (q *Queries) DeleteExpiredAPIKeys(ctx context.Context) error {
	_, err := q.db.Exec(ctx, deleteExpiredAPIKeys)
	return err
}

const getAPIKey = `-- name: GetAPIKey :one
SELECT id, user_id, name, description, key_hash, key_prefix, scopes, is_active, expires_at, last_used_at, created_at, updated_at FROM shared.api_keys
WHERE id = $1
`

func (q *Queries) GetAPIKey(ctx context.Context, id uuid.UUID) (SharedApiKey, error) {
	row := q.db.QueryRow(ctx, getAPIKey, id)
	var i SharedApiKey
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.Name,
		&i.Description,
		&i.KeyHash,
		&i.KeyPrefix,
		&i.Scopes,
		&i.IsActive,
		&i.ExpiresAt,
		&i.LastUsedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getAPIKeyByHash = `-- name: GetAPIKeyByHash :one
SELECT id, user_id, name, description, key_hash, key_prefix, scopes, is_active, expires_at, last_used_at, created_at, updated_at FROM shared.api_keys
WHERE key_hash = $1
`

func (q *Queries) GetAPIKeyByHash(ctx context.Context, keyHash string) (SharedApiKey, error) {
	row := q.db.QueryRow(ctx, getAPIKeyByHash, keyHash)
	var i SharedApiKey
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.Name,
		&i.Description,
		&i.KeyHash,
		&i.KeyPrefix,
		&i.Scopes,
		&i.IsActive,
		&i.ExpiresAt,
		&i.LastUsedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getAPIKeyByPrefix = `-- name: GetAPIKeyByPrefix :one
SELECT id, user_id, name, description, key_hash, key_prefix, scopes, is_active, expires_at, last_used_at, created_at, updated_at FROM shared.api_keys
WHERE key_prefix = $1 AND is_active = true
LIMIT 1
`

func (q *Queries) GetAPIKeyByPrefix(ctx context.Context, keyPrefix string) (SharedApiKey, error) {
	row := q.db.QueryRow(ctx, getAPIKeyByPrefix, keyPrefix)
	var i SharedApiKey
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.Name,
		&i.Description,
		&i.KeyHash,
		&i.KeyPrefix,
		&i.Scopes,
		&i.IsActive,
		&i.ExpiresAt,
		&i.LastUsedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getAPIKeyUsageCount = `-- name: GetAPIKeyUsageCount :one
SELECT last_used_at FROM shared.api_keys
WHERE id = $1
`

// This is a placeholder - actual usage tracking would be in a separate table
// For now, we just return last_used_at
func (q *Queries) GetAPIKeyUsageCount(ctx context.Context, id uuid.UUID) (pgtype.Timestamptz, error) {
	row := q.db.QueryRow(ctx, getAPIKeyUsageCount, id)
	var last_used_at pgtype.Timestamptz
	err := row.Scan(&last_used_at)
	return last_used_at, err
}

const listActiveUserAPIKeys = `-- name: ListActiveUserAPIKeys :many
SELECT id, user_id, name, description, key_hash, key_prefix, scopes, is_active, expires_at, last_used_at, created_at, updated_at FROM shared.api_keys
WHERE user_id = $1 AND is_active = true
ORDER BY created_at DESC
`

func (q *Queries) ListActiveUserAPIKeys(ctx context.Context, userID uuid.UUID) ([]SharedApiKey, error) {
	rows, err := q.db.Query(ctx, listActiveUserAPIKeys, userID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []SharedApiKey{}
	for rows.Next() {
		var i SharedApiKey
		if err := rows.Scan(
			&i.ID,
			&i.UserID,
			&i.Name,
			&i.Description,
			&i.KeyHash,
			&i.KeyPrefix,
			&i.Scopes,
			&i.IsActive,
			&i.ExpiresAt,
			&i.LastUsedAt,
			&i.CreatedAt,
			&i.UpdatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listUserAPIKeys = `-- name: ListUserAPIKeys :many
SELECT id, user_id, name, description, key_hash, key_prefix, scopes, is_active, expires_at, last_used_at, created_at, updated_at FROM shared.api_keys
WHERE user_id = $1
ORDER BY created_at DESC
`

func (q *Queries) ListUserAPIKeys(ctx context.Context, userID uuid.UUID) ([]SharedApiKey, error) {
	rows, err := q.db.Query(ctx, listUserAPIKeys, userID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []SharedApiKey{}
	for rows.Next() {
		var i SharedApiKey
		if err := rows.Scan(
			&i.ID,
			&i.UserID,
			&i.Name,
			&i.Description,
			&i.KeyHash,
			&i.KeyPrefix,
			&i.Scopes,
			&i.IsActive,
			&i.ExpiresAt,
			&i.LastUsedAt,
			&i.CreatedAt,
			&i.UpdatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const revokeAPIKey = `-- name: RevokeAPIKey :exec
UPDATE shared.api_keys
SET is_active = false, updated_at = NOW()
WHERE id = $1
`

func (q *Queries) RevokeAPIKey(ctx context.Context, id uuid.UUID) error {
	_, err := q.db.Exec(ctx, revokeAPIKey, id)
	return err
}

const updateAPIKeyLastUsed = `-- name: UpdateAPIKeyLastUsed :exec
UPDATE shared.api_keys
SET last_used_at = NOW(), updated_at = NOW()
WHERE id = $1
`

func (q *Queries) UpdateAPIKeyLastUsed(ctx context.Context, id uuid.UUID) error {
	_, err := q.db.Exec(ctx, updateAPIKeyLastUsed, id)
	return err
}

const updateAPIKeyScopes = `-- name: UpdateAPIKeyScopes :exec
UPDATE shared.api_keys
SET scopes = $2, updated_at = NOW()
WHERE id = $1
`

type UpdateAPIKeyScopesParams struct {
	ID     uuid.UUID `json:"id"`
	Scopes []string  `json:"scopes"`
}

func (q *Queries) UpdateAPIKeyScopes(ctx context.Context, arg UpdateAPIKeyScopesParams) error {
	_, err := q.db.Exec(ctx, updateAPIKeyScopes, arg.ID, arg.Scopes)
	return err
}
