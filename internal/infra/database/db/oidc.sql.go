// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: oidc.sql

package db

import (
	"context"
	"encoding/json"
	"time"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgtype"
)

const countUserOIDCLinks = `-- name: CountUserOIDCLinks :one
SELECT COUNT(*) FROM shared.oidc_user_links WHERE user_id = $1
`

// Counts how many OIDC providers a user is linked to
func (q *Queries) CountUserOIDCLinks(ctx context.Context, userID uuid.UUID) (int64, error) {
	row := q.db.QueryRow(ctx, countUserOIDCLinks, userID)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const createOIDCProvider = `-- name: CreateOIDCProvider :one
INSERT INTO shared.oidc_providers (
    name,
    display_name,
    provider_type,
    issuer_url,
    client_id,
    client_secret_encrypted,
    authorization_endpoint,
    token_endpoint,
    userinfo_endpoint,
    jwks_uri,
    end_session_endpoint,
    scopes,
    claim_mappings,
    role_mappings,
    auto_create_users,
    update_user_info,
    allow_linking,
    is_enabled,
    is_default
) VALUES (
    $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19
) RETURNING id, name, display_name, provider_type, issuer_url, client_id, client_secret_encrypted, authorization_endpoint, token_endpoint, userinfo_endpoint, jwks_uri, end_session_endpoint, scopes, claim_mappings, role_mappings, auto_create_users, update_user_info, allow_linking, is_enabled, is_default, created_at, updated_at
`

type CreateOIDCProviderParams struct {
	Name                  string          `json:"name"`
	DisplayName           string          `json:"displayName"`
	ProviderType          string          `json:"providerType"`
	IssuerUrl             string          `json:"issuerUrl"`
	ClientID              string          `json:"clientId"`
	ClientSecretEncrypted []byte          `json:"clientSecretEncrypted"`
	AuthorizationEndpoint *string         `json:"authorizationEndpoint"`
	TokenEndpoint         *string         `json:"tokenEndpoint"`
	UserinfoEndpoint      *string         `json:"userinfoEndpoint"`
	JwksUri               *string         `json:"jwksUri"`
	EndSessionEndpoint    *string         `json:"endSessionEndpoint"`
	Scopes                []string        `json:"scopes"`
	ClaimMappings         json.RawMessage `json:"claimMappings"`
	RoleMappings          json.RawMessage `json:"roleMappings"`
	AutoCreateUsers       bool            `json:"autoCreateUsers"`
	UpdateUserInfo        bool            `json:"updateUserInfo"`
	AllowLinking          bool            `json:"allowLinking"`
	IsEnabled             bool            `json:"isEnabled"`
	IsDefault             bool            `json:"isDefault"`
}

// Creates a new OIDC provider configuration
func (q *Queries) CreateOIDCProvider(ctx context.Context, arg CreateOIDCProviderParams) (SharedOidcProvider, error) {
	row := q.db.QueryRow(ctx, createOIDCProvider,
		arg.Name,
		arg.DisplayName,
		arg.ProviderType,
		arg.IssuerUrl,
		arg.ClientID,
		arg.ClientSecretEncrypted,
		arg.AuthorizationEndpoint,
		arg.TokenEndpoint,
		arg.UserinfoEndpoint,
		arg.JwksUri,
		arg.EndSessionEndpoint,
		arg.Scopes,
		arg.ClaimMappings,
		arg.RoleMappings,
		arg.AutoCreateUsers,
		arg.UpdateUserInfo,
		arg.AllowLinking,
		arg.IsEnabled,
		arg.IsDefault,
	)
	var i SharedOidcProvider
	err := row.Scan(
		&i.ID,
		&i.Name,
		&i.DisplayName,
		&i.ProviderType,
		&i.IssuerUrl,
		&i.ClientID,
		&i.ClientSecretEncrypted,
		&i.AuthorizationEndpoint,
		&i.TokenEndpoint,
		&i.UserinfoEndpoint,
		&i.JwksUri,
		&i.EndSessionEndpoint,
		&i.Scopes,
		&i.ClaimMappings,
		&i.RoleMappings,
		&i.AutoCreateUsers,
		&i.UpdateUserInfo,
		&i.AllowLinking,
		&i.IsEnabled,
		&i.IsDefault,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const createOIDCState = `-- name: CreateOIDCState :one

INSERT INTO shared.oidc_states (
    state,
    code_verifier,
    provider_id,
    user_id,
    redirect_url,
    expires_at
) VALUES (
    $1, $2, $3, $4, $5, $6
) RETURNING id, state, code_verifier, provider_id, user_id, redirect_url, expires_at, created_at
`

type CreateOIDCStateParams struct {
	State        string      `json:"state"`
	CodeVerifier *string     `json:"codeVerifier"`
	ProviderID   uuid.UUID   `json:"providerId"`
	UserID       pgtype.UUID `json:"userId"`
	RedirectUrl  *string     `json:"redirectUrl"`
	ExpiresAt    time.Time   `json:"expiresAt"`
}

// ============================================================================
// OIDC States (OAuth2 flow)
// ============================================================================
// Creates a new OAuth2 state for the auth flow
func (q *Queries) CreateOIDCState(ctx context.Context, arg CreateOIDCStateParams) (SharedOidcState, error) {
	row := q.db.QueryRow(ctx, createOIDCState,
		arg.State,
		arg.CodeVerifier,
		arg.ProviderID,
		arg.UserID,
		arg.RedirectUrl,
		arg.ExpiresAt,
	)
	var i SharedOidcState
	err := row.Scan(
		&i.ID,
		&i.State,
		&i.CodeVerifier,
		&i.ProviderID,
		&i.UserID,
		&i.RedirectUrl,
		&i.ExpiresAt,
		&i.CreatedAt,
	)
	return i, err
}

const createOIDCUserLink = `-- name: CreateOIDCUserLink :one

INSERT INTO shared.oidc_user_links (
    user_id,
    provider_id,
    subject,
    email,
    name,
    picture_url,
    access_token_encrypted,
    refresh_token_encrypted,
    token_expires_at,
    last_login_at
) VALUES (
    $1, $2, $3, $4, $5, $6, $7, $8, $9, NOW()
) RETURNING id, user_id, provider_id, subject, email, name, picture_url, access_token_encrypted, refresh_token_encrypted, token_expires_at, last_login_at, created_at, updated_at
`

type CreateOIDCUserLinkParams struct {
	UserID                uuid.UUID          `json:"userId"`
	ProviderID            uuid.UUID          `json:"providerId"`
	Subject               string             `json:"subject"`
	Email                 *string            `json:"email"`
	Name                  *string            `json:"name"`
	PictureUrl            *string            `json:"pictureUrl"`
	AccessTokenEncrypted  []byte             `json:"accessTokenEncrypted"`
	RefreshTokenEncrypted []byte             `json:"refreshTokenEncrypted"`
	TokenExpiresAt        pgtype.Timestamptz `json:"tokenExpiresAt"`
}

// ============================================================================
// OIDC User Links
// ============================================================================
// Links a user to an OIDC provider
func (q *Queries) CreateOIDCUserLink(ctx context.Context, arg CreateOIDCUserLinkParams) (SharedOidcUserLink, error) {
	row := q.db.QueryRow(ctx, createOIDCUserLink,
		arg.UserID,
		arg.ProviderID,
		arg.Subject,
		arg.Email,
		arg.Name,
		arg.PictureUrl,
		arg.AccessTokenEncrypted,
		arg.RefreshTokenEncrypted,
		arg.TokenExpiresAt,
	)
	var i SharedOidcUserLink
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.ProviderID,
		&i.Subject,
		&i.Email,
		&i.Name,
		&i.PictureUrl,
		&i.AccessTokenEncrypted,
		&i.RefreshTokenEncrypted,
		&i.TokenExpiresAt,
		&i.LastLoginAt,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const deleteExpiredOIDCStates = `-- name: DeleteExpiredOIDCStates :execrows
DELETE FROM shared.oidc_states WHERE expires_at < NOW()
`

// Cleans up expired OAuth2 states
func (q *Queries) DeleteExpiredOIDCStates(ctx context.Context) (int64, error) {
	result, err := q.db.Exec(ctx, deleteExpiredOIDCStates)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected(), nil
}

const deleteOIDCProvider = `-- name: DeleteOIDCProvider :exec
DELETE FROM shared.oidc_providers WHERE id = $1
`

// Deletes an OIDC provider
func (q *Queries) DeleteOIDCProvider(ctx context.Context, id uuid.UUID) error {
	_, err := q.db.Exec(ctx, deleteOIDCProvider, id)
	return err
}

const deleteOIDCState = `-- name: DeleteOIDCState :exec
DELETE FROM shared.oidc_states WHERE state = $1
`

// Deletes an OAuth2 state (after use or expiration)
func (q *Queries) DeleteOIDCState(ctx context.Context, state string) error {
	_, err := q.db.Exec(ctx, deleteOIDCState, state)
	return err
}

const deleteOIDCStatesByProvider = `-- name: DeleteOIDCStatesByProvider :exec
DELETE FROM shared.oidc_states WHERE provider_id = $1
`

// Deletes all states for a provider (when disabling)
func (q *Queries) DeleteOIDCStatesByProvider(ctx context.Context, providerID uuid.UUID) error {
	_, err := q.db.Exec(ctx, deleteOIDCStatesByProvider, providerID)
	return err
}

const deleteOIDCUserLink = `-- name: DeleteOIDCUserLink :exec
DELETE FROM shared.oidc_user_links WHERE id = $1
`

// Unlinks a user from an OIDC provider
func (q *Queries) DeleteOIDCUserLink(ctx context.Context, id uuid.UUID) error {
	_, err := q.db.Exec(ctx, deleteOIDCUserLink, id)
	return err
}

const deleteOIDCUserLinkByUserAndProvider = `-- name: DeleteOIDCUserLinkByUserAndProvider :exec
DELETE FROM shared.oidc_user_links WHERE user_id = $1 AND provider_id = $2
`

type DeleteOIDCUserLinkByUserAndProviderParams struct {
	UserID     uuid.UUID `json:"userId"`
	ProviderID uuid.UUID `json:"providerId"`
}

// Unlinks a user from an OIDC provider by user and provider ID
func (q *Queries) DeleteOIDCUserLinkByUserAndProvider(ctx context.Context, arg DeleteOIDCUserLinkByUserAndProviderParams) error {
	_, err := q.db.Exec(ctx, deleteOIDCUserLinkByUserAndProvider, arg.UserID, arg.ProviderID)
	return err
}

const disableOIDCProvider = `-- name: DisableOIDCProvider :exec
UPDATE shared.oidc_providers SET is_enabled = false WHERE id = $1
`

// Disables an OIDC provider
func (q *Queries) DisableOIDCProvider(ctx context.Context, id uuid.UUID) error {
	_, err := q.db.Exec(ctx, disableOIDCProvider, id)
	return err
}

const enableOIDCProvider = `-- name: EnableOIDCProvider :exec
UPDATE shared.oidc_providers SET is_enabled = true WHERE id = $1
`

// Enables an OIDC provider
func (q *Queries) EnableOIDCProvider(ctx context.Context, id uuid.UUID) error {
	_, err := q.db.Exec(ctx, enableOIDCProvider, id)
	return err
}

const getDefaultOIDCProvider = `-- name: GetDefaultOIDCProvider :one
SELECT id, name, display_name, provider_type, issuer_url, client_id, client_secret_encrypted, authorization_endpoint, token_endpoint, userinfo_endpoint, jwks_uri, end_session_endpoint, scopes, claim_mappings, role_mappings, auto_create_users, update_user_info, allow_linking, is_enabled, is_default, created_at, updated_at FROM shared.oidc_providers WHERE is_default = true AND is_enabled = true
`

// Gets the default OIDC provider
func (q *Queries) GetDefaultOIDCProvider(ctx context.Context) (SharedOidcProvider, error) {
	row := q.db.QueryRow(ctx, getDefaultOIDCProvider)
	var i SharedOidcProvider
	err := row.Scan(
		&i.ID,
		&i.Name,
		&i.DisplayName,
		&i.ProviderType,
		&i.IssuerUrl,
		&i.ClientID,
		&i.ClientSecretEncrypted,
		&i.AuthorizationEndpoint,
		&i.TokenEndpoint,
		&i.UserinfoEndpoint,
		&i.JwksUri,
		&i.EndSessionEndpoint,
		&i.Scopes,
		&i.ClaimMappings,
		&i.RoleMappings,
		&i.AutoCreateUsers,
		&i.UpdateUserInfo,
		&i.AllowLinking,
		&i.IsEnabled,
		&i.IsDefault,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getOIDCProvider = `-- name: GetOIDCProvider :one
SELECT id, name, display_name, provider_type, issuer_url, client_id, client_secret_encrypted, authorization_endpoint, token_endpoint, userinfo_endpoint, jwks_uri, end_session_endpoint, scopes, claim_mappings, role_mappings, auto_create_users, update_user_info, allow_linking, is_enabled, is_default, created_at, updated_at FROM shared.oidc_providers WHERE id = $1
`

// Gets an OIDC provider by ID
func (q *Queries) GetOIDCProvider(ctx context.Context, id uuid.UUID) (SharedOidcProvider, error) {
	row := q.db.QueryRow(ctx, getOIDCProvider, id)
	var i SharedOidcProvider
	err := row.Scan(
		&i.ID,
		&i.Name,
		&i.DisplayName,
		&i.ProviderType,
		&i.IssuerUrl,
		&i.ClientID,
		&i.ClientSecretEncrypted,
		&i.AuthorizationEndpoint,
		&i.TokenEndpoint,
		&i.UserinfoEndpoint,
		&i.JwksUri,
		&i.EndSessionEndpoint,
		&i.Scopes,
		&i.ClaimMappings,
		&i.RoleMappings,
		&i.AutoCreateUsers,
		&i.UpdateUserInfo,
		&i.AllowLinking,
		&i.IsEnabled,
		&i.IsDefault,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getOIDCProviderByName = `-- name: GetOIDCProviderByName :one
SELECT id, name, display_name, provider_type, issuer_url, client_id, client_secret_encrypted, authorization_endpoint, token_endpoint, userinfo_endpoint, jwks_uri, end_session_endpoint, scopes, claim_mappings, role_mappings, auto_create_users, update_user_info, allow_linking, is_enabled, is_default, created_at, updated_at FROM shared.oidc_providers WHERE name = $1
`

// Gets an OIDC provider by name
func (q *Queries) GetOIDCProviderByName(ctx context.Context, name string) (SharedOidcProvider, error) {
	row := q.db.QueryRow(ctx, getOIDCProviderByName, name)
	var i SharedOidcProvider
	err := row.Scan(
		&i.ID,
		&i.Name,
		&i.DisplayName,
		&i.ProviderType,
		&i.IssuerUrl,
		&i.ClientID,
		&i.ClientSecretEncrypted,
		&i.AuthorizationEndpoint,
		&i.TokenEndpoint,
		&i.UserinfoEndpoint,
		&i.JwksUri,
		&i.EndSessionEndpoint,
		&i.Scopes,
		&i.ClaimMappings,
		&i.RoleMappings,
		&i.AutoCreateUsers,
		&i.UpdateUserInfo,
		&i.AllowLinking,
		&i.IsEnabled,
		&i.IsDefault,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getOIDCState = `-- name: GetOIDCState :one
SELECT id, state, code_verifier, provider_id, user_id, redirect_url, expires_at, created_at FROM shared.oidc_states WHERE state = $1
`

// Gets an OAuth2 state by state token
func (q *Queries) GetOIDCState(ctx context.Context, state string) (SharedOidcState, error) {
	row := q.db.QueryRow(ctx, getOIDCState, state)
	var i SharedOidcState
	err := row.Scan(
		&i.ID,
		&i.State,
		&i.CodeVerifier,
		&i.ProviderID,
		&i.UserID,
		&i.RedirectUrl,
		&i.ExpiresAt,
		&i.CreatedAt,
	)
	return i, err
}

const getOIDCUserLink = `-- name: GetOIDCUserLink :one
SELECT id, user_id, provider_id, subject, email, name, picture_url, access_token_encrypted, refresh_token_encrypted, token_expires_at, last_login_at, created_at, updated_at FROM shared.oidc_user_links WHERE id = $1
`

// Gets a user link by ID
func (q *Queries) GetOIDCUserLink(ctx context.Context, id uuid.UUID) (SharedOidcUserLink, error) {
	row := q.db.QueryRow(ctx, getOIDCUserLink, id)
	var i SharedOidcUserLink
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.ProviderID,
		&i.Subject,
		&i.Email,
		&i.Name,
		&i.PictureUrl,
		&i.AccessTokenEncrypted,
		&i.RefreshTokenEncrypted,
		&i.TokenExpiresAt,
		&i.LastLoginAt,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getOIDCUserLinkBySubject = `-- name: GetOIDCUserLinkBySubject :one
SELECT id, user_id, provider_id, subject, email, name, picture_url, access_token_encrypted, refresh_token_encrypted, token_expires_at, last_login_at, created_at, updated_at FROM shared.oidc_user_links
WHERE provider_id = $1 AND subject = $2
`

type GetOIDCUserLinkBySubjectParams struct {
	ProviderID uuid.UUID `json:"providerId"`
	Subject    string    `json:"subject"`
}

// Gets a user link by provider and subject
func (q *Queries) GetOIDCUserLinkBySubject(ctx context.Context, arg GetOIDCUserLinkBySubjectParams) (SharedOidcUserLink, error) {
	row := q.db.QueryRow(ctx, getOIDCUserLinkBySubject, arg.ProviderID, arg.Subject)
	var i SharedOidcUserLink
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.ProviderID,
		&i.Subject,
		&i.Email,
		&i.Name,
		&i.PictureUrl,
		&i.AccessTokenEncrypted,
		&i.RefreshTokenEncrypted,
		&i.TokenExpiresAt,
		&i.LastLoginAt,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getOIDCUserLinkByUserAndProvider = `-- name: GetOIDCUserLinkByUserAndProvider :one
SELECT id, user_id, provider_id, subject, email, name, picture_url, access_token_encrypted, refresh_token_encrypted, token_expires_at, last_login_at, created_at, updated_at FROM shared.oidc_user_links
WHERE user_id = $1 AND provider_id = $2
`

type GetOIDCUserLinkByUserAndProviderParams struct {
	UserID     uuid.UUID `json:"userId"`
	ProviderID uuid.UUID `json:"providerId"`
}

// Gets a user link by user and provider
func (q *Queries) GetOIDCUserLinkByUserAndProvider(ctx context.Context, arg GetOIDCUserLinkByUserAndProviderParams) (SharedOidcUserLink, error) {
	row := q.db.QueryRow(ctx, getOIDCUserLinkByUserAndProvider, arg.UserID, arg.ProviderID)
	var i SharedOidcUserLink
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.ProviderID,
		&i.Subject,
		&i.Email,
		&i.Name,
		&i.PictureUrl,
		&i.AccessTokenEncrypted,
		&i.RefreshTokenEncrypted,
		&i.TokenExpiresAt,
		&i.LastLoginAt,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const listEnabledOIDCProviders = `-- name: ListEnabledOIDCProviders :many
SELECT id, name, display_name, provider_type, issuer_url, client_id, client_secret_encrypted, authorization_endpoint, token_endpoint, userinfo_endpoint, jwks_uri, end_session_endpoint, scopes, claim_mappings, role_mappings, auto_create_users, update_user_info, allow_linking, is_enabled, is_default, created_at, updated_at FROM shared.oidc_providers WHERE is_enabled = true ORDER BY display_name
`

// Lists all enabled OIDC providers
func (q *Queries) ListEnabledOIDCProviders(ctx context.Context) ([]SharedOidcProvider, error) {
	rows, err := q.db.Query(ctx, listEnabledOIDCProviders)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []SharedOidcProvider{}
	for rows.Next() {
		var i SharedOidcProvider
		if err := rows.Scan(
			&i.ID,
			&i.Name,
			&i.DisplayName,
			&i.ProviderType,
			&i.IssuerUrl,
			&i.ClientID,
			&i.ClientSecretEncrypted,
			&i.AuthorizationEndpoint,
			&i.TokenEndpoint,
			&i.UserinfoEndpoint,
			&i.JwksUri,
			&i.EndSessionEndpoint,
			&i.Scopes,
			&i.ClaimMappings,
			&i.RoleMappings,
			&i.AutoCreateUsers,
			&i.UpdateUserInfo,
			&i.AllowLinking,
			&i.IsEnabled,
			&i.IsDefault,
			&i.CreatedAt,
			&i.UpdatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listOIDCProviders = `-- name: ListOIDCProviders :many
SELECT id, name, display_name, provider_type, issuer_url, client_id, client_secret_encrypted, authorization_endpoint, token_endpoint, userinfo_endpoint, jwks_uri, end_session_endpoint, scopes, claim_mappings, role_mappings, auto_create_users, update_user_info, allow_linking, is_enabled, is_default, created_at, updated_at FROM shared.oidc_providers ORDER BY display_name
`

// Lists all OIDC providers
func (q *Queries) ListOIDCProviders(ctx context.Context) ([]SharedOidcProvider, error) {
	rows, err := q.db.Query(ctx, listOIDCProviders)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []SharedOidcProvider{}
	for rows.Next() {
		var i SharedOidcProvider
		if err := rows.Scan(
			&i.ID,
			&i.Name,
			&i.DisplayName,
			&i.ProviderType,
			&i.IssuerUrl,
			&i.ClientID,
			&i.ClientSecretEncrypted,
			&i.AuthorizationEndpoint,
			&i.TokenEndpoint,
			&i.UserinfoEndpoint,
			&i.JwksUri,
			&i.EndSessionEndpoint,
			&i.Scopes,
			&i.ClaimMappings,
			&i.RoleMappings,
			&i.AutoCreateUsers,
			&i.UpdateUserInfo,
			&i.AllowLinking,
			&i.IsEnabled,
			&i.IsDefault,
			&i.CreatedAt,
			&i.UpdatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listUserOIDCLinks = `-- name: ListUserOIDCLinks :many
SELECT l.id, l.user_id, l.provider_id, l.subject, l.email, l.name, l.picture_url, l.access_token_encrypted, l.refresh_token_encrypted, l.token_expires_at, l.last_login_at, l.created_at, l.updated_at, p.name as provider_name, p.display_name as provider_display_name
FROM shared.oidc_user_links l
JOIN shared.oidc_providers p ON l.provider_id = p.id
WHERE l.user_id = $1
ORDER BY l.created_at
`

type ListUserOIDCLinksRow struct {
	ID                    uuid.UUID          `json:"id"`
	UserID                uuid.UUID          `json:"userId"`
	ProviderID            uuid.UUID          `json:"providerId"`
	Subject               string             `json:"subject"`
	Email                 *string            `json:"email"`
	Name                  *string            `json:"name"`
	PictureUrl            *string            `json:"pictureUrl"`
	AccessTokenEncrypted  []byte             `json:"accessTokenEncrypted"`
	RefreshTokenEncrypted []byte             `json:"refreshTokenEncrypted"`
	TokenExpiresAt        pgtype.Timestamptz `json:"tokenExpiresAt"`
	LastLoginAt           pgtype.Timestamptz `json:"lastLoginAt"`
	CreatedAt             time.Time          `json:"createdAt"`
	UpdatedAt             time.Time          `json:"updatedAt"`
	ProviderName          string             `json:"providerName"`
	ProviderDisplayName   string             `json:"providerDisplayName"`
}

// Lists all OIDC links for a user
func (q *Queries) ListUserOIDCLinks(ctx context.Context, userID uuid.UUID) ([]ListUserOIDCLinksRow, error) {
	rows, err := q.db.Query(ctx, listUserOIDCLinks, userID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []ListUserOIDCLinksRow{}
	for rows.Next() {
		var i ListUserOIDCLinksRow
		if err := rows.Scan(
			&i.ID,
			&i.UserID,
			&i.ProviderID,
			&i.Subject,
			&i.Email,
			&i.Name,
			&i.PictureUrl,
			&i.AccessTokenEncrypted,
			&i.RefreshTokenEncrypted,
			&i.TokenExpiresAt,
			&i.LastLoginAt,
			&i.CreatedAt,
			&i.UpdatedAt,
			&i.ProviderName,
			&i.ProviderDisplayName,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const setDefaultOIDCProvider = `-- name: SetDefaultOIDCProvider :exec
UPDATE shared.oidc_providers SET is_default = false WHERE is_default = true
`

// Sets a provider as default (clears other defaults first)
func (q *Queries) SetDefaultOIDCProvider(ctx context.Context) error {
	_, err := q.db.Exec(ctx, setDefaultOIDCProvider)
	return err
}

const updateOIDCProvider = `-- name: UpdateOIDCProvider :one
UPDATE shared.oidc_providers SET
    display_name = COALESCE($2, display_name),
    provider_type = COALESCE($3, provider_type),
    issuer_url = COALESCE($4, issuer_url),
    client_id = COALESCE($5, client_id),
    client_secret_encrypted = COALESCE($6, client_secret_encrypted),
    authorization_endpoint = COALESCE($7, authorization_endpoint),
    token_endpoint = COALESCE($8, token_endpoint),
    userinfo_endpoint = COALESCE($9, userinfo_endpoint),
    jwks_uri = COALESCE($10, jwks_uri),
    end_session_endpoint = COALESCE($11, end_session_endpoint),
    scopes = COALESCE($12, scopes),
    claim_mappings = COALESCE($13, claim_mappings),
    role_mappings = COALESCE($14, role_mappings),
    auto_create_users = COALESCE($15, auto_create_users),
    update_user_info = COALESCE($16, update_user_info),
    allow_linking = COALESCE($17, allow_linking),
    is_enabled = COALESCE($18, is_enabled),
    is_default = COALESCE($19, is_default)
WHERE id = $1
RETURNING id, name, display_name, provider_type, issuer_url, client_id, client_secret_encrypted, authorization_endpoint, token_endpoint, userinfo_endpoint, jwks_uri, end_session_endpoint, scopes, claim_mappings, role_mappings, auto_create_users, update_user_info, allow_linking, is_enabled, is_default, created_at, updated_at
`

type UpdateOIDCProviderParams struct {
	ID                    uuid.UUID `json:"id"`
	DisplayName           *string   `json:"displayName"`
	ProviderType          *string   `json:"providerType"`
	IssuerUrl             *string   `json:"issuerUrl"`
	ClientID              *string   `json:"clientId"`
	ClientSecretEncrypted []byte    `json:"clientSecretEncrypted"`
	AuthorizationEndpoint *string   `json:"authorizationEndpoint"`
	TokenEndpoint         *string   `json:"tokenEndpoint"`
	UserinfoEndpoint      *string   `json:"userinfoEndpoint"`
	JwksUri               *string   `json:"jwksUri"`
	EndSessionEndpoint    *string   `json:"endSessionEndpoint"`
	Scopes                []string  `json:"scopes"`
	ClaimMappings         []byte    `json:"claimMappings"`
	RoleMappings          []byte    `json:"roleMappings"`
	AutoCreateUsers       *bool     `json:"autoCreateUsers"`
	UpdateUserInfo        *bool     `json:"updateUserInfo"`
	AllowLinking          *bool     `json:"allowLinking"`
	IsEnabled             *bool     `json:"isEnabled"`
	IsDefault             *bool     `json:"isDefault"`
}

// Updates an OIDC provider
func (q *Queries) UpdateOIDCProvider(ctx context.Context, arg UpdateOIDCProviderParams) (SharedOidcProvider, error) {
	row := q.db.QueryRow(ctx, updateOIDCProvider,
		arg.ID,
		arg.DisplayName,
		arg.ProviderType,
		arg.IssuerUrl,
		arg.ClientID,
		arg.ClientSecretEncrypted,
		arg.AuthorizationEndpoint,
		arg.TokenEndpoint,
		arg.UserinfoEndpoint,
		arg.JwksUri,
		arg.EndSessionEndpoint,
		arg.Scopes,
		arg.ClaimMappings,
		arg.RoleMappings,
		arg.AutoCreateUsers,
		arg.UpdateUserInfo,
		arg.AllowLinking,
		arg.IsEnabled,
		arg.IsDefault,
	)
	var i SharedOidcProvider
	err := row.Scan(
		&i.ID,
		&i.Name,
		&i.DisplayName,
		&i.ProviderType,
		&i.IssuerUrl,
		&i.ClientID,
		&i.ClientSecretEncrypted,
		&i.AuthorizationEndpoint,
		&i.TokenEndpoint,
		&i.UserinfoEndpoint,
		&i.JwksUri,
		&i.EndSessionEndpoint,
		&i.Scopes,
		&i.ClaimMappings,
		&i.RoleMappings,
		&i.AutoCreateUsers,
		&i.UpdateUserInfo,
		&i.AllowLinking,
		&i.IsEnabled,
		&i.IsDefault,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const updateOIDCUserLink = `-- name: UpdateOIDCUserLink :one
UPDATE shared.oidc_user_links SET
    email = COALESCE($2, email),
    name = COALESCE($3, name),
    picture_url = COALESCE($4, picture_url),
    access_token_encrypted = COALESCE($5, access_token_encrypted),
    refresh_token_encrypted = COALESCE($6, refresh_token_encrypted),
    token_expires_at = COALESCE($7, token_expires_at),
    last_login_at = COALESCE($8, last_login_at)
WHERE id = $1
RETURNING id, user_id, provider_id, subject, email, name, picture_url, access_token_encrypted, refresh_token_encrypted, token_expires_at, last_login_at, created_at, updated_at
`

type UpdateOIDCUserLinkParams struct {
	ID                    uuid.UUID          `json:"id"`
	Email                 *string            `json:"email"`
	Name                  *string            `json:"name"`
	PictureUrl            *string            `json:"pictureUrl"`
	AccessTokenEncrypted  []byte             `json:"accessTokenEncrypted"`
	RefreshTokenEncrypted []byte             `json:"refreshTokenEncrypted"`
	TokenExpiresAt        pgtype.Timestamptz `json:"tokenExpiresAt"`
	LastLoginAt           pgtype.Timestamptz `json:"lastLoginAt"`
}

// Updates a user link (tokens, user info)
func (q *Queries) UpdateOIDCUserLink(ctx context.Context, arg UpdateOIDCUserLinkParams) (SharedOidcUserLink, error) {
	row := q.db.QueryRow(ctx, updateOIDCUserLink,
		arg.ID,
		arg.Email,
		arg.Name,
		arg.PictureUrl,
		arg.AccessTokenEncrypted,
		arg.RefreshTokenEncrypted,
		arg.TokenExpiresAt,
		arg.LastLoginAt,
	)
	var i SharedOidcUserLink
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.ProviderID,
		&i.Subject,
		&i.Email,
		&i.Name,
		&i.PictureUrl,
		&i.AccessTokenEncrypted,
		&i.RefreshTokenEncrypted,
		&i.TokenExpiresAt,
		&i.LastLoginAt,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const updateOIDCUserLinkLastLogin = `-- name: UpdateOIDCUserLinkLastLogin :exec
UPDATE shared.oidc_user_links SET last_login_at = NOW() WHERE id = $1
`

// Updates the last login timestamp
func (q *Queries) UpdateOIDCUserLinkLastLogin(ctx context.Context, id uuid.UUID) error {
	_, err := q.db.Exec(ctx, updateOIDCUserLinkLastLogin, id)
	return err
}
