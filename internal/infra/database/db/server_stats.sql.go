// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: server_stats.sql

package db

import (
	"context"
)

const countActiveUsers = `-- name: CountActiveUsers :one

SELECT COUNT(*) FROM shared.users WHERE deleted_at IS NULL
`

// =============================================================================
// Aggregate queries used by the stats aggregation worker
// =============================================================================
// Count total active (non-deleted) users
func (q *Queries) CountActiveUsers(ctx context.Context) (int64, error) {
	row := q.db.QueryRow(ctx, countActiveUsers)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const countActiveUsersLast24h = `-- name: CountActiveUsersLast24h :one
SELECT COUNT(DISTINCT user_id)
FROM shared.sessions
WHERE
    last_activity_at > NOW() - INTERVAL '24 hours'
`

// Count users active in the last 24 hours (by session activity)
func (q *Queries) CountActiveUsersLast24h(ctx context.Context) (int64, error) {
	row := q.db.QueryRow(ctx, countActiveUsersLast24h)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const countTotalEpisodeWatches = `-- name: CountTotalEpisodeWatches :one
SELECT COALESCE(SUM(watch_count), 0)::bigint FROM tvshow.episode_watched
`

// Count total episode watch records
func (q *Queries) CountTotalEpisodeWatches(ctx context.Context) (int64, error) {
	row := q.db.QueryRow(ctx, countTotalEpisodeWatches)
	var column_1 int64
	err := row.Scan(&column_1)
	return column_1, err
}

const countTotalEpisodes = `-- name: CountTotalEpisodes :one
SELECT COUNT(*) FROM tvshow.episodes
`

// Count total TV episodes
func (q *Queries) CountTotalEpisodes(ctx context.Context) (int64, error) {
	row := q.db.QueryRow(ctx, countTotalEpisodes)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const countTotalLibraries = `-- name: CountTotalLibraries :one
SELECT COUNT(*) FROM public.libraries WHERE enabled = true
`

// Count total enabled libraries
func (q *Queries) CountTotalLibraries(ctx context.Context) (int64, error) {
	row := q.db.QueryRow(ctx, countTotalLibraries)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const countTotalMovieWatches = `-- name: CountTotalMovieWatches :one
SELECT COALESCE(SUM(watch_count), 0)::bigint FROM movie.movie_watched
`

// Count total movie watch records
func (q *Queries) CountTotalMovieWatches(ctx context.Context) (int64, error) {
	row := q.db.QueryRow(ctx, countTotalMovieWatches)
	var column_1 int64
	err := row.Scan(&column_1)
	return column_1, err
}

const countTotalMovies = `-- name: CountTotalMovies :one
SELECT COUNT(*) FROM movie.movies
`

// Count total movies across all libraries
func (q *Queries) CountTotalMovies(ctx context.Context) (int64, error) {
	row := q.db.QueryRow(ctx, countTotalMovies)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const countTotalSeries = `-- name: CountTotalSeries :one
SELECT COUNT(*) FROM tvshow.series
`

// Count total TV series
func (q *Queries) CountTotalSeries(ctx context.Context) (int64, error) {
	row := q.db.QueryRow(ctx, countTotalSeries)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const getAllServerStats = `-- name: GetAllServerStats :many
SELECT
    stat_key,
    stat_value,
    computed_at
FROM shared.server_stats
ORDER BY stat_key
`

// Get all server statistics
func (q *Queries) GetAllServerStats(ctx context.Context) ([]SharedServerStat, error) {
	rows, err := q.db.Query(ctx, getAllServerStats)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []SharedServerStat{}
	for rows.Next() {
		var i SharedServerStat
		if err := rows.Scan(&i.StatKey, &i.StatValue, &i.ComputedAt); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getServerStat = `-- name: GetServerStat :one
SELECT
    stat_key,
    stat_value,
    computed_at
FROM shared.server_stats
WHERE
    stat_key = $1
`

// Get a single server statistic by key
func (q *Queries) GetServerStat(ctx context.Context, statKey string) (SharedServerStat, error) {
	row := q.db.QueryRow(ctx, getServerStat, statKey)
	var i SharedServerStat
	err := row.Scan(&i.StatKey, &i.StatValue, &i.ComputedAt)
	return i, err
}

const sumEpisodeWatchDurationSeconds = `-- name: SumEpisodeWatchDurationSeconds :one
SELECT COALESCE(SUM(duration_seconds::bigint * watch_count::bigint), 0)::bigint
FROM tvshow.episode_watched
WHERE is_completed = true
`

// Sum total episode watch duration in seconds
func (q *Queries) SumEpisodeWatchDurationSeconds(ctx context.Context) (int64, error) {
	row := q.db.QueryRow(ctx, sumEpisodeWatchDurationSeconds)
	var column_1 int64
	err := row.Scan(&column_1)
	return column_1, err
}

const sumMovieWatchDurationSeconds = `-- name: SumMovieWatchDurationSeconds :one
SELECT COALESCE(SUM(duration_seconds::bigint * watch_count::bigint), 0)::bigint
FROM movie.movie_watched
WHERE is_completed = true
`

// Sum total movie watch duration in seconds
func (q *Queries) SumMovieWatchDurationSeconds(ctx context.Context) (int64, error) {
	row := q.db.QueryRow(ctx, sumMovieWatchDurationSeconds)
	var column_1 int64
	err := row.Scan(&column_1)
	return column_1, err
}

const upsertServerStat = `-- name: UpsertServerStat :exec
INSERT INTO
    shared.server_stats (
        stat_key,
        stat_value,
        computed_at
    )
VALUES ($1, $2, NOW()) ON CONFLICT (stat_key) DO
UPDATE
SET
    stat_value = EXCLUDED.stat_value,
    computed_at = NOW()
`

type UpsertServerStatParams struct {
	StatKey   string `json:"statKey"`
	StatValue int64  `json:"statValue"`
}

// Upsert a single server statistic
func (q *Queries) UpsertServerStat(ctx context.Context, arg UpsertServerStatParams) error {
	_, err := q.db.Exec(ctx, upsertServerStat, arg.StatKey, arg.StatValue)
	return err
}
