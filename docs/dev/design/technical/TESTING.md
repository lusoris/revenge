# Testing

<!-- DESIGN: technical -->

**Test files**: 157 (excluding generated ogen code)
**Framework**: Go testing + testify + mockery
**Integration**: testcontainers-go (PostgreSQL, Dragonfly, Typesense)

> Unit and integration testing infrastructure

---

## Running Tests

```bash
make test               # Unit tests with race detection + coverage
make test-short         # Fast unit tests (skip slow)
make test-integration   # Integration tests (requires Docker)
make test-all           # Unit + integration
make test-coverage      # Run tests and open coverage report
```

## Unit Tests

Table-driven tests with testify assertions. Mocks generated by mockery.

### Patterns

```go
func TestService_Method(t *testing.T) {
    tests := []struct {
        name    string
        input   InputType
        want    OutputType
        wantErr bool
    }{
        {name: "success", input: validInput, want: expected},
        {name: "not found", input: missing, wantErr: true},
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            // Arrange: set up mocks
            // Act: call method
            // Assert: verify with testify
        })
    }
}
```

### Key Test Files

| Package | Test Files | Tests |
|---------|-----------|-------|
| internal/api/ | handler_*_test.go | API handler unit tests |
| internal/service/auth/ | service_test.go, service_unit_test.go | Auth logic |
| internal/service/session/ | service_test.go | Session management |
| internal/service/rbac/ | service_test.go | RBAC policies |
| internal/service/apikeys/ | service_test.go | API key CRUD |
| internal/service/oidc/ | service_test.go, service_unit_test.go | OIDC flows |
| internal/infra/database/ | pool_test.go, migrate_test.go, migrations_test.go | DB infrastructure |
| internal/content/movie/ | service_test.go, repository_test.go | Movie domain |
| internal/content/tvshow/ | service_test.go | TV show domain |

## Integration Tests

Located in `tests/integration/`. Require Docker for testcontainers.

### Test Suites

| Directory | Tests | Containers |
|-----------|-------|------------|
| database/ | database_test.go, constraints_test.go | PostgreSQL 18 |
| cache/ | cache_test.go, cache_advanced_test.go | Dragonfly |
| search/ | search_test.go | Typesense |
| service/ | Service-level integration tests | PostgreSQL + Dragonfly |
| (root) | auth_flow_test.go, health_test.go, server_test.go | Full stack |

### Helpers

- `tests/integration/helpers_test.go` — Shared test utilities, container setup
- `tests/integration/api_client_test.go.skip` — API client tests (currently skipped)
- `internal/infra/database/testing.go` — Database test helpers

## Code Generation for Tests

- **mockery**: Generates mock implementations from interfaces
- **sqlc**: Generates query code tested against real PostgreSQL
- **ogen**: Generated code tested via handler integration tests

Regenerate: `make generate`

## CI Integration

- `ci.yml`: Runs `make test` (unit) and `make test-integration` (integration)
- `coverage.yml`: Generates coverage report, posts as PR comment via Codecov
- Race detection enabled by default (`-race` flag)

## Related Documentation

- [../operations/DEVELOPMENT.md](../operations/DEVELOPMENT.md) - Development setup and make targets
- [../operations/CI_CD.md](../operations/CI_CD.md) - CI/CD pipeline
- [../architecture/DESIGN_PRINCIPLES.md](../architecture/DESIGN_PRINCIPLES.md) - Testing patterns
