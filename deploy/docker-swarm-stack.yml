# Auto-generated from SOURCE_OF_TRUTH.md
# Do not edit directly. Run: python scripts/deploy-pipeline/01-generate.py
# Generated: 2026-02-01

version: '3.8'
services:
  revenge:
    image: ghcr.io/lusoris/revenge:${REVENGE_VERSION:-latest}
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      restart_policy:
        condition: on-failure
        max_attempts: 3
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    environment:
      REVENGE_SERVER_PORT: '8080'
      REVENGE_DATABASE_HOST: db
      REVENGE_DATABASE_PORT: '5432'
      REVENGE_DATABASE_NAME: revenge
      REVENGE_DATABASE_USER: revenge
      REVENGE_DATABASE_PASSWORD_FILE: /run/secrets/db_password
      REVENGE_CACHE_HOST: dragonfly
      REVENGE_CACHE_PORT: '6379'
    secrets:
    - db_password
    volumes:
    - media:/media:ro
    networks:
    - revenge-net
    healthcheck:
      test:
      - CMD
      - wget
      - --no-verbose
      - --tries=1
      - --spider
      - http://localhost:8080/health/ready
      interval: 30s
      timeout: 10s
      retries: 3
  db:
    image: postgres:18-alpine
    deploy:
      replicas: 1
      placement:
        constraints:
        - node.role == manager
    environment:
      POSTGRES_DB: revenge
      POSTGRES_USER: revenge
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
    secrets:
    - db_password
    volumes:
    - pgdata:/var/lib/postgresql/data
    networks:
    - revenge-net
  dragonfly:
    image: docker.dragonflydb.io/dragonflydb/dragonfly:latest
    deploy:
      replicas: 1
      placement:
        constraints:
        - node.role == manager
    command: dragonfly --logtostderr
    volumes:
    - dfdata:/data
    networks:
    - revenge-net
secrets:
  db_password:
    external: true
volumes:
  media:
    driver: local
    driver_opts:
      type: nfs
      o: addr=${NFS_SERVER:-nas.local},rw
      device: :${NFS_PATH:-/volume1/media}
  pgdata: null
  dfdata: null
networks:
  revenge-net:
    driver: overlay
