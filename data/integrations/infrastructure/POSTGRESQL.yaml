doc_title: PostgreSQL Integration
doc_category: integration
created_date: '2026-01-31'
overall_status: âœ… Complete
status_design: âœ…
status_design_notes: '-'
status_sources: âœ…
status_sources_notes: '-'
status_instructions: âœ…
status_instructions_notes: '-'
status_code: ðŸ”´
status_code_notes: '-'
status_linting: ðŸ”´
status_linting_notes: '-'
status_unit_testing: ðŸ”´
status_unit_testing_notes: '-'
status_integration_testing: ðŸ”´
status_integration_testing_notes: '-'
technical_summary: '> Primary database for all Revenge data'
wiki_tagline: '> PostgreSQL stores all your media data'
wiki_overview: PostgreSQL is the only supported database for Revenge (no SQLite).
  Stores all metadata, user data, watch history, and configuration. Version 18+ required
  for modern features. Supports automatic schema migrations on upgrade. Backup your
  database regularly using standard PostgreSQL tools.
sources:
- name: Dragonfly Documentation
  url: https://www.dragonflydb.io/docs
  note: Auto-resolved from dragonfly
- name: pgx PostgreSQL Driver
  url: https://pkg.go.dev/github.com/jackc/pgx/v5
  note: Auto-resolved from pgx
- name: PostgreSQL Arrays
  url: https://www.postgresql.org/docs/current/arrays.html
  note: Auto-resolved from postgresql-arrays
- name: PostgreSQL JSON Functions
  url: https://www.postgresql.org/docs/current/functions-json.html
  note: Auto-resolved from postgresql-json
- name: Prometheus Go Client
  url: https://pkg.go.dev/github.com/prometheus/client_golang/prometheus
  note: Auto-resolved from prometheus
- name: Prometheus Metric Types
  url: https://prometheus.io/docs/concepts/metric_types/
  note: Auto-resolved from prometheus-metrics
- name: River Job Queue
  url: https://pkg.go.dev/github.com/riverqueue/river
  note: Auto-resolved from river
- name: River Documentation
  url: https://riverqueue.com/docs
  note: Auto-resolved from river-docs
- name: sqlc
  url: https://docs.sqlc.dev/en/stable/
  note: Auto-resolved from sqlc
- name: sqlc Configuration
  url: https://docs.sqlc.dev/en/stable/reference/config.html
  note: Auto-resolved from sqlc-config
- name: Typesense API
  url: https://typesense.org/docs/latest/api/
  note: Auto-resolved from typesense
- name: Typesense Go Client
  url: https://github.com/typesense/typesense-go
  note: Auto-resolved from typesense-go
design_refs:
- title: 01_ARCHITECTURE
  path: ../../architecture/01_ARCHITECTURE.md
- title: 02_DESIGN_PRINCIPLES
  path: ../../architecture/02_DESIGN_PRINCIPLES.md
- title: 03_METADATA_SYSTEM
  path: ../../architecture/03_METADATA_SYSTEM.md
integration_name: PostgreSQL
integration_id: postgresql
external_service: PostgreSQL

architecture_diagram: |
  ```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   Server    â”‚â”€â”€â”€â”€â–¶â”‚   pgxpool    â”‚â”€â”€â”€â”€â–¶â”‚ PostgreSQL  â”‚
  â”‚ (Services)  â”‚â—€â”€â”€â”€â”€â”‚ (Connection  â”‚â—€â”€â”€â”€â”€â”‚  Server 18+ â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚     Pool)    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚   sqlc       â”‚
                      â”‚ (Query Gen)  â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```

connection_details: |
  **Driver**: pgx v5 (pure Go PostgreSQL driver)
  **Connection Pool**: pgxpool with automatic connection management
  **Query Generation**: sqlc for type-safe SQL queries
  **Minimum Version**: PostgreSQL 18.0+

  **Connection String Format**:
  ```
  postgres://username:password@host:port/database?sslmode=require
  ```

database_schema: |
  **Primary Schemas**:
  - `public` - Default schema for main tables (users, libraries, content)
  - `qar` - QAR (adult content) isolation schema with pirate-themed tables
  - `river_job` - River job queue tables (managed by River)
  - `river_leader` - River leadership election tables

  **Key Features Used**:
  - JSONB columns for flexible metadata storage
  - Array columns for multi-value fields (genres, tags)
  - Full-text search with tsvector for EPG programs
  - Partial indexes for performance optimization
  - Foreign keys with CASCADE for referential integrity
  - gen_random_uuid() for UUID generation
  - Triggers for updated_at timestamps

module_structure: |
  ```
  internal/database/
  â”œâ”€â”€ module.go                    # fx module
  â”œâ”€â”€ postgres.go                  # PostgreSQL connection
  â”œâ”€â”€ pool.go                      # Connection pool config
  â”œâ”€â”€ migrations/                  # SQL migration files
  â”‚   â”œâ”€â”€ 001_initial_schema.sql
  â”‚   â”œâ”€â”€ 002_add_qar.sql
  â”‚   â””â”€â”€ ...
  â””â”€â”€ sqlc/                        # Generated code
      â”œâ”€â”€ db.go
      â”œâ”€â”€ models.go
      â””â”€â”€ queries.sql.go
  ```

key_interfaces: |
  ```go
  // Database connection interface
  type Database interface {
    Pool() *pgxpool.Pool
    BeginTx(ctx context.Context) (pgx.Tx, error)
    Close() error
  }

  // Configuration
  type PostgresConfig struct {
    Host            string        `yaml:"host"`
    Port            int           `yaml:"port"`
    User            string        `yaml:"user"`
    Password        string        `yaml:"password"`
    Database        string        `yaml:"database"`
    SSLMode         string        `yaml:"ssl_mode"`
    MaxConns        int32         `yaml:"max_conns"`
    MinConns        int32         `yaml:"min_conns"`
    MaxConnLifetime time.Duration `yaml:"max_conn_lifetime"`
    MaxConnIdleTime time.Duration `yaml:"max_conn_idle_time"`
  }
  ```

dependencies: |
  **Go Packages**:
  - `github.com/jackc/pgx/v5` - PostgreSQL driver
  - `github.com/jackc/pgx/v5/pgxpool` - Connection pooling
  - `github.com/jackc/pgx/v5/pgtype` - PostgreSQL type handling
  - `github.com/kyleconroy/sqlc` - SQL query code generation
  - `go.uber.org/fx` - Dependency injection

  **External Services**:
  - PostgreSQL 18.0+ server (required)

env_vars: |
  ```bash
  # Connection
  POSTGRES_HOST=localhost
  POSTGRES_PORT=5432
  POSTGRES_USER=revenge
  POSTGRES_PASSWORD=secret
  POSTGRES_DATABASE=revenge
  POSTGRES_SSL_MODE=require

  # Pool configuration
  POSTGRES_MAX_CONNS=25
  POSTGRES_MIN_CONNS=5
  POSTGRES_MAX_CONN_LIFETIME=1h
  POSTGRES_MAX_CONN_IDLE_TIME=30m
  ```

config_keys: |
  ```yaml
  database:
    postgres:
      host: localhost
      port: 5432
      user: revenge
      password: ${POSTGRES_PASSWORD}
      database: revenge
      ssl_mode: require
      max_conns: 25
      min_conns: 5
      max_conn_lifetime: 1h
      max_conn_idle_time: 30m
  ```

component_interaction: |
  **Application Startup**:
  1. fx lifecycle starts
  2. Database module creates pgxpool.Pool
  3. Connection pool initialized with config
  4. Run migrations (if needed)
  5. Services inject *pgxpool.Pool dependency
  6. sqlc-generated repositories use pool

  **Query Execution** (with sqlc):
  1. Service calls repository method
  2. sqlc-generated code prepares query
  3. Execute via pgxpool with context
  4. Map results to Go structs
  5. Return typed data to service

  **Transaction Example**:
  ```go
  tx, err := db.Pool().Begin(ctx)
  if err != nil {
    return err
  }
  defer tx.Rollback(ctx)

  // Execute queries within transaction
  qtx := queries.New(tx)

  if err := tx.Commit(ctx); err != nil {
    return err
  }
  ```

api_endpoints: |
  **Health Check**:
  ```
  GET /api/v1/health/database
  ```

  **Response**:
  ```json
  {
    "status": "healthy",
    "version": "18.1",
    "pool_stats": {
      "total_conns": 10,
      "idle_conns": 5,
      "acquired_conns": 5
    }
  }
  ```

migration_strategy: |
  **Migration Tool**: golang-migrate or custom SQL migration runner

  **File Naming**: `{version}_{description}.{up|down}.sql`

  **Example**:
  ```sql
  -- 001_initial_schema.up.sql
  CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(255) UNIQUE NOT NULL,
    created_at TIMESTAMPTZ DEFAULT now()
  );
  ```

  **Execution**: Migrations run automatically on server startup, idempotent

unit_tests: |
  ```go
  func TestPostgresConnection(t *testing.T) {
    // Test connection establishment
  }

  func TestConnectionPool(t *testing.T) {
    // Test pool configuration
  }
  ```

integration_tests: |
  ```go
  func TestPostgres_FullWorkflow(t *testing.T) {
    // Use testcontainers to spin up PostgreSQL
    // Test migrations, queries, transactions
  }
  ```

backup_restore: |
  **Backup**:
  ```bash
  pg_dump -h localhost -U revenge -d revenge > backup.sql
  ```

  **Restore**:
  ```bash
  psql -h localhost -U revenge -d revenge < backup.sql
  ```

  **Automated Backups**: Configure via cron or Kubernetes CronJob for daily backups

performance_tuning: |
  **Connection Pool Sizing**:
  - `max_conns` should be ~2-3x CPU cores
  - `min_conns` should be ~25% of max_conns
  - Tune based on workload monitoring

  **Query Optimization**:
  - Use EXPLAIN ANALYZE for slow queries
  - Add indexes for frequent WHERE/JOIN columns
  - Use partial indexes for filtered queries
  - Monitor query performance with pg_stat_statements
