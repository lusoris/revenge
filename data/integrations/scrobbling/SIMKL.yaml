doc_title: Simkl Integration
doc_category: integration
created_date: '2026-01-31'
overall_status: âœ… Complete
status_design: âœ…
status_design_notes: '-'
status_sources: âœ…
status_sources_notes: '-'
status_instructions: ðŸŸ¡
status_instructions_notes: '-'
status_code: ðŸ”´
status_code_notes: '-'
status_linting: ðŸ”´
status_linting_notes: '-'
status_unit_testing: ðŸ”´
status_unit_testing_notes: '-'
status_integration_testing: ðŸ”´
status_integration_testing_notes: '-'
technical_summary: '> TV tracker and movie scrobbler (alternative to Trakt)'
wiki_tagline: '> Track TV and movies with Simkl'
wiki_overview: Simkl provides TV and movie tracking as an alternative to Trakt. Automatic scrobbling records what you watch.
  Strong anime support with AniList integration. Sync your watchlist and watched history. View detailed statistics about your
  viewing habits. Free account with no limits.
sources:
- name: Last.fm API
  url: https://www.last.fm/api/intro
  note: Auto-resolved from lastfm-api
- name: River Job Queue
  url: https://pkg.go.dev/github.com/riverqueue/river
  note: Auto-resolved from river
- name: Simkl API
  url: https://simkl.docs.apiary.io/
  note: Auto-resolved from simkl
design_refs:
- title: 01_ARCHITECTURE
  path: ../../architecture/01_ARCHITECTURE.md
- title: 02_DESIGN_PRINCIPLES
  path: ../../architecture/02_DESIGN_PRINCIPLES.md
- title: 03_METADATA_SYSTEM
  path: ../../architecture/03_METADATA_SYSTEM.md
integration_name: Simkl
integration_id: simkl
external_service: Simkl
api_base_url: https://api.simkl.com
auth_method: oauth
architecture_diagram: |-
  ```mermaid
  flowchart TD
      subgraph row1[ ]
          direction LR
          node1["Revenge<br/>Playback<br/>Events"]
          node2["Simkl<br/>Integration"]
          node3[["Simkl<br/>API"]]
      end
      node4["Scrobble<br/>Queue (River)"]
      node1 --> node2
      node2 --> node3
      node3 --> node4

      %% Hide row subgraph borders
      style row1 fill:transparent,stroke:transparent
  ```
api_details: |
  **API Version**: v2
  **Base URL**: `https://api.simkl.com`
  **Authentication**: OAuth 2.0 (Pin-based or Device Code)
  **Rate Limit**: 1000 requests per hour per user

  **Key Endpoints**:
  - `/oauth/pin` - Generate PIN for authorization
  - `/oauth/pin/{user_code}` - Check PIN status
  - `/sync/history` - Get/add watch history
  - `/sync/all-items` - Get all tracked items
  - `/sync/add-to-list` - Add to watchlist/plan-to-watch
  - `/sync/ratings` - Get/set ratings
  - `/checkin` - Check in (currently watching)
  - `/users/settings` - Get user settings

  **Required Headers**:
  - `Content-Type: application/json`
  - `simkl-api-key: {client_id}`
  - `Authorization: Bearer {access_token}`
database_schema: |
  **Schema**: `public`

  ```sql
  -- Simkl OAuth connections
  CREATE TABLE simkl_connections (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    access_token TEXT NOT NULL,

    simkl_user_id INTEGER NOT NULL,
    simkl_username VARCHAR(255),

    last_sync_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now(),

    UNIQUE(user_id)
  );

  -- Scrobble queue
  CREATE TABLE simkl_scrobble_queue (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    connection_id UUID NOT NULL REFERENCES simkl_connections(id) ON DELETE CASCADE,

    content_type VARCHAR(50) NOT NULL,              -- 'movie', 'episode', 'anime'
    content_id UUID NOT NULL,

    action VARCHAR(20) NOT NULL,                    -- 'checkin', 'scrobble'

    simkl_id INTEGER,
    tmdb_id INTEGER,
    imdb_id VARCHAR(50),
    anilist_id INTEGER,

    watched_at TIMESTAMPTZ,
    scheduled_at TIMESTAMPTZ DEFAULT now(),
    completed_at TIMESTAMPTZ,
    failed_at TIMESTAMPTZ,
    error_message TEXT
  );
  CREATE INDEX idx_simkl_scrobble_user ON simkl_scrobble_queue(user_id);

  -- Watch history sync
  CREATE TABLE simkl_watch_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    connection_id UUID NOT NULL REFERENCES simkl_connections(id) ON DELETE CASCADE,

    content_type VARCHAR(50) NOT NULL,
    content_id UUID,

    watched_at TIMESTAMPTZ NOT NULL,
    simkl_id INTEGER,

    synced_to_simkl BOOLEAN DEFAULT true,
    synced_from_simkl BOOLEAN DEFAULT false,

    UNIQUE(connection_id, content_type, simkl_id)
  );

  -- Watchlist sync
  CREATE TABLE simkl_watchlist (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    connection_id UUID NOT NULL REFERENCES simkl_connections(id) ON DELETE CASCADE,

    content_type VARCHAR(50) NOT NULL,
    content_id UUID,

    simkl_id INTEGER NOT NULL,
    status VARCHAR(50),                             -- 'plantowatch', 'watching', 'hold'

    added_at TIMESTAMPTZ NOT NULL,

    UNIQUE(connection_id, content_type, simkl_id)
  );
  ```
module_structure: |
  ```
  internal/integrations/simkl/
  â”œâ”€â”€ module.go                    # fx module
  â”œâ”€â”€ client.go                    # Simkl API client
  â”œâ”€â”€ oauth.go                     # OAuth 2.0 (PIN-based)
  â”œâ”€â”€ scrobble.go                  # Scrobbling service
  â”œâ”€â”€ sync.go                      # History/watchlist sync
  â”œâ”€â”€ jobs.go                      # River jobs
  â”œâ”€â”€ types.go                     # Simkl API types
  â””â”€â”€ simkl_test.go
  ```
key_interfaces: |
  ```go
  // Simkl integration service
  type SimklService interface {
    // OAuth (PIN-based)
    GeneratePIN(ctx context.Context, userID uuid.UUID) (*PINResponse, error)
    CheckPINStatus(ctx context.Context, userID uuid.UUID, userCode string) (*SimklConnection, error)

    // Scrobbling
    Checkin(ctx context.Context, userID uuid.UUID, contentType string, contentID uuid.UUID) error
    Scrobble(ctx context.Context, userID uuid.UUID, contentType string, contentID uuid.UUID, watchedAt time.Time) error

    // Sync
    SyncHistory(ctx context.Context, connectionID uuid.UUID, direction string) error
    SyncWatchlist(ctx context.Context, connectionID uuid.UUID) error

    // Ratings
    SetRating(ctx context.Context, connectionID uuid.UUID, contentType string, contentID uuid.UUID, rating int) error
  }

  // PIN OAuth response
  type PINResponse struct {
    DeviceCode       string `json:"device_code"`
    UserCode         string `json:"user_code"`
    VerificationURL  string `json:"verification_url"`
    ExpiresIn        int    `json:"expires_in"`
    Interval         int    `json:"interval"`
  }

  // Scrobble item
  type ScrobbleItem struct {
    Title  string                 `json:"title,omitempty"`
    Year   int                    `json:"year,omitempty"`
    IDs    map[string]interface{} `json:"ids"`
    To     string                 `json:"to,omitempty"`  // Status: "watchlist", "watching", "completed"
  }
  ```
dependencies: |
  **Go Packages**:
  - `net/http` - HTTP client
  - `github.com/google/uuid` - UUID support
  - `github.com/jackc/pgx/v5` - PostgreSQL driver
  - `github.com/riverqueue/river` - Background jobs
  - `go.uber.org/fx` - Dependency injection

  **External Services**:
  - Simkl account (free tier available)
env_vars: |
  ```bash
  # Simkl OAuth app credentials
  SIMKL_CLIENT_ID=your_client_id
  SIMKL_CLIENT_SECRET=your_client_secret

  # Sync settings
  SIMKL_AUTO_SCROBBLE=true
  ```
config_keys: |
  ```yaml
  integrations:
    simkl:
      client_id: ${SIMKL_CLIENT_ID}
      client_secret: ${SIMKL_CLIENT_SECRET}

      auto_scrobble: true
      auto_sync_watchlist: true
      sync_interval: 3600            # 1 hour
  ```
component_interaction: |
  **PIN-Based OAuth Flow**:
  1. User clicks "Connect Simkl" in Revenge
  2. POST /oauth/pin to generate user_code and device_code
  3. Display user_code and verification_url to user
  4. User visits https://simkl.com/pin and enters user_code
  5. Poll GET /oauth/pin/{user_code} every 5 seconds
  6. When authorized, response includes access_token
  7. Store access_token in simkl_connections (no refresh token needed)

  **Scrobbling**:
  1. User watches movie/episode
  2. On completion, queue scrobble in simkl_scrobble_queue
  3. POST /sync/history with movie/episode IDs
  4. Simkl marks as watched in user's history

  **Check-in** (currently watching):
  1. Playback starts
  2. POST /checkin with content IDs
  3. Simkl shows "currently watching" on user's profile
  4. Auto-expires after 1 hour if not completed

  **Anime Support**:
  - Simkl has strong anime catalog
  - Accepts anilist_id alongside tmdb_id/imdb_id
  - Can sync with AniList via Simkl's native integration
oauth_flow: |
  **PIN-Based Authorization** (no redirect needed):

  **Step 1 - Generate PIN**:
  ```
  POST https://api.simkl.com/oauth/pin
  Content-Type: application/json

  {
    "client_id": "{client_id}",
    "redirect": "https://your-domain.com/oauth/simkl/callback"
  }
  ```

  **Response**:
  ```json
  {
    "device_code": "abc123...",
    "user_code": "XYZABC",
    "verification_url": "https://simkl.com/pin",
    "expires_in": 300,
    "interval": 5
  }
  ```

  **Step 2 - User Enters PIN**:
  User navigates to https://simkl.com/pin and enters "XYZABC"

  **Step 3 - Poll for Authorization**:
  ```
  GET https://api.simkl.com/oauth/pin/{user_code}?
    client_id={client_id}
  ```

  **Response (pending)**:
  ```json
  {
    "result": "KO",
    "message": "waiting for the user to authorize"
  }
  ```

  **Response (authorized)**:
  ```json
  {
    "result": "OK",
    "access_token": "abc123...",
    "token_type": "bearer",
    "scope": "public"
  }
  ```
api_request_examples: |
  **Add to Watch History**:
  ```
  POST https://api.simkl.com/sync/history
  Content-Type: application/json
  simkl-api-key: {client_id}
  Authorization: Bearer {access_token}

  {
    "movies": [
      {
        "title": "Inception",
        "year": 2010,
        "ids": {
          "simkl": 12345,
          "imdb": "tt1375666",
          "tmdb": 27205
        },
        "watched_at": "2026-01-15T20:30:00Z"
      }
    ]
  }
  ```

  **Check-in** (currently watching):
  ```
  POST https://api.simkl.com/checkin
  Content-Type: application/json
  simkl-api-key: {client_id}
  Authorization: Bearer {access_token}

  {
    "episode": {
      "ids": {
        "simkl": 67890,
        "tvdb": 349232
      }
    },
    "expire_date": "2026-01-15T21:00:00Z"
  }
  ```

  **Get Watch History**:
  ```
  GET https://api.simkl.com/sync/all-items/movies,shows
  simkl-api-key: {client_id}
  Authorization: Bearer {access_token}
  ```

  **Response**:
  ```json
  {
    "movies": [
      {
        "last_watched_at": "2026-01-15T20:30:00Z",
        "status": "completed",
        "user_rating": 9,
        "movie": {
          "title": "Inception",
          "year": 2010,
          "ids": {
            "simkl": 12345,
            "imdb": "tt1375666",
            "tmdb": 27205
          }
        }
      }
    ],
    "shows": [...]
  }
  ```
anime_support: |
  **Anime Integration**:
  - Simkl has native anime support
  - Accepts anilist_id, mal_id (MyAnimeList ID), simkl_id
  - Can sync watchlist with AniList, Kitsu, MAL

  **Anime-Specific Features**:
  - Track watching, plan-to-watch, completed, on-hold, dropped
  - Episode-level tracking
  - Season vs absolute episode numbering

  **Example with AniList ID**:
  ```json
  {
    "shows": [
      {
        "ids": {
          "anilist": 21,
          "simkl": 100001,
          "mal": 21
        },
        "to": "watching"
      }
    ]
  }
  ```
watchlist_sync: |
  **Simkl List Statuses**:
  - **plantowatch**: Want to watch
  - **watching**: Currently watching
  - **completed**: Finished
  - **hold**: On hold
  - **notinteresting**: Not interested

  **Sync Logic**:
  1. GET /sync/all-items to fetch all tracked content
  2. For each item with status "plantowatch":
     - Add to Revenge requests if not in library
  3. For items with status "completed":
     - Mark as watched in Revenge
  4. Bidirectional: Add Revenge requests to Simkl watchlist
rating_sync: |
  **Simkl Rating System**:
  - Scale: 1-10 (integers)
  - POST /sync/ratings to set rating
  - Includes in sync response

  **Rating Payload**:
  ```json
  {
    "movies": [
      {
        "ids": {
          "simkl": 12345
        },
        "rating": 9
      }
    ]
  }
  ```
unit_tests: |
  ```go
  func TestSimklService_OAuth(t *testing.T) {
    // Test PIN generation
    // Test PIN polling
    // Test token storage
  }

  func TestSimklService_Scrobble(t *testing.T) {
    // Test movie scrobble
    // Test episode scrobble
    // Test check-in
  }

  func TestSimklService_HistorySync(t *testing.T) {
    // Test import from Simkl
    // Test export to Simkl
  }
  ```
integration_tests: |
  ```go
  func TestSimkl_FullWorkflow(t *testing.T) {
    // Use test Simkl account
    // Test PIN OAuth â†’ scrobble â†’ history sync
  }
  ```
