doc_title: Spotify Integration
doc_category: integration
created_date: '2026-01-31'
overall_status: âœ… Complete
status_design: âœ…
status_design_notes: '-'
status_sources: âœ…
status_sources_notes: '-'
status_instructions: âœ…
status_instructions_notes: '-'
status_code: ðŸ”´
status_code_notes: '-'
status_linting: ðŸ”´
status_linting_notes: '-'
status_unit_testing: ðŸ”´
status_unit_testing_notes: '-'
status_integration_testing: ðŸ”´
status_integration_testing_notes: '-'
technical_summary: '> SUPPLEMENTARY enrichment provider (high-quality images, popularity scores)'
wiki_tagline: '> High-quality artwork and popularity - Supplementary to Lidarr'
wiki_overview: 'SUPPLEMENTARY enrichment for music metadata. Provides: (1) High-quality album artwork, (2) Artist images (HD
  quality), (3) Popularity scores (trending/popular music), (4) Spotify URIs (for linking). OAuth authentication required.
  **Optional proxy/VPN routing** if needed (via HTTP_CLIENT service). Metadata-only (no playback/streaming).'
sources:
- name: go-blurhash
  url: https://pkg.go.dev/github.com/bbrks/go-blurhash
  note: Auto-resolved from go-blurhash
- name: Last.fm API
  url: https://www.last.fm/api/intro
  note: Auto-resolved from lastfm-api
- name: Spotify Web API
  url: https://developer.spotify.com/documentation/web-api
  note: Auto-resolved from spotify
design_refs:
- title: 03_METADATA_SYSTEM
  path: ../../../architecture/03_METADATA_SYSTEM.md
- title: LIDARR (PRIMARY for music)
  path: ../../servarr/LIDARR.md
- title: HTTP_CLIENT (proxy/VPN support)
  path: ../../../services/HTTP_CLIENT.md
- title: MUSIC_MODULE
  path: ../../../features/music/MUSIC_MODULE.md
integration_name: Spotify
integration_id: spotify
external_service: Spotify
api_base_url: https://api.spotify.com/v1
auth_method: oauth
architecture_diagram: |-
  ```mermaid
  flowchart TD
      node1[["Metadata<br/>Service"]]
      node2(["Spotify<br/>Provider"])
      node3(["Spotify<br/>Web API"])
      node4(["Client Creds<br/>OAuth 2.0"])
      node1 --> node2
      node2 --> node3
      node3 --> node4
  ```
api_details: |
  **API Version**: v1
  **Base URL**: `https://api.spotify.com/v1`
  **Authentication**: OAuth 2.0 Client Credentials flow (for metadata only, no user auth needed)
  **Rate Limit**: No published limit, but very generous

  **Key Endpoints**:
  - `/search` - Search for artists, albums, tracks
  - `/artists/{id}` - Get artist details
  - `/albums/{id}` - Get album details
  - `/tracks/{id}` - Get track details
  - `/artists/{id}/albums` - Get artist's albums
database_schema: |
  **Schema**: `public`

  ```sql
  -- Spotify ID mappings
  CREATE TABLE spotify_ids (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    content_type VARCHAR(50) NOT NULL,     -- 'artist', 'album', 'track'
    content_id UUID NOT NULL,

    spotify_id VARCHAR(255) NOT NULL,      -- Spotify URI (base62)

    -- Spotify-specific data
    popularity INTEGER,                     -- 0-100 popularity score
    images JSONB,                           -- Image URLs at different sizes

    fetched_at TIMESTAMPTZ DEFAULT now(),
    UNIQUE(content_type, content_id)
  );
  CREATE INDEX idx_spotify_id ON spotify_ids(spotify_id);
  ```
module_structure: |
  ```
  internal/metadata/providers/spotify/
  â”œâ”€â”€ module.go                    # fx module
  â”œâ”€â”€ client.go                    # Spotify API client
  â”œâ”€â”€ auth.go                      # OAuth 2.0 Client Credentials
  â”œâ”€â”€ provider.go                  # Metadata provider interface impl
  â”œâ”€â”€ search.go                    # Search methods
  â”œâ”€â”€ images.go                    # Image download
  â””â”€â”€ spotify_test.go
  ```
key_interfaces: |
  ```go
  // Spotify provider implementation
  type SpotifyProvider struct {
    client       *SpotifyClient
    clientID     string
    clientSecret string
    token        string
    tokenExpiry  time.Time
    cache        Cache
  }

  // Metadata provider interface
  type MetadataProvider interface {
    // Search
    SearchArtist(ctx context.Context, query string) ([]ArtistSearchResult, error)
    SearchAlbum(ctx context.Context, query string) ([]AlbumSearchResult, error)
    SearchTrack(ctx context.Context, query string) ([]TrackSearchResult, error)

    // Get by Spotify ID
    GetArtist(ctx context.Context, spotifyID string) (*ArtistDetails, error)
    GetAlbum(ctx context.Context, spotifyID string) (*AlbumDetails, error)

    // Images
    DownloadImage(ctx context.Context, url string) ([]byte, error)
  }

  // Artist details from Spotify
  type ArtistDetails struct {
    ID         string   `json:"id"`
    Name       string   `json:"name"`
    Genres     []string `json:"genres"`
    Popularity int      `json:"popularity"`  // 0-100
    Images     []Image  `json:"images"`
    Followers  int      `json:"followers.total"`
  }

  // Album details
  type AlbumDetails struct {
    ID          string   `json:"id"`
    Name        string   `json:"name"`
    Artists     []Artist `json:"artists"`
    ReleaseDate string   `json:"release_date"`
    TotalTracks int      `json:"total_tracks"`
    Popularity  int      `json:"popularity"`
    Images      []Image  `json:"images"`
    Genres      []string `json:"genres"`
  }

  // Image (multiple sizes)
  type Image struct {
    URL    string `json:"url"`
    Height int    `json:"height"`
    Width  int    `json:"width"`
  }
  ```
dependencies: |
  **Go Packages**:
  - `net/http` - HTTP client
  - `encoding/base64` - Base64 encoding for Client Credentials auth
  - `github.com/google/uuid` - UUID support
  - `github.com/jackc/pgx/v5` - PostgreSQL driver
  - `github.com/bbrks/go-blurhash` - Blurhash generation
  - `go.uber.org/fx` - Dependency injection

  **External APIs**:
  - Spotify Web API (free with Spotify Developer account)
env_vars: |
  ```bash
  # Spotify API
  SPOTIFY_CLIENT_ID=your_client_id_here
  SPOTIFY_CLIENT_SECRET=your_client_secret_here

  # Caching
  SPOTIFY_CACHE_TTL=168h  # 7 days
  ```
config_keys: |
  ```yaml
  metadata:
    providers:
      spotify:
        enabled: true
        client_id: ${SPOTIFY_CLIENT_ID}
        client_secret: ${SPOTIFY_CLIENT_SECRET}
        cache_ttl: 168h
  ```
oauth_flow: |
  **Client Credentials Flow** (no user auth):
  1. Encode client_id:client_secret as base64
  2. POST to /api/token with grant_type=client_credentials
  3. Receive access token (expires in 1 hour)
  4. Use token in Authorization: Bearer header
  5. Auto-refresh token before expiry

  **Token Request**:
  ```
  POST https://accounts.spotify.com/api/token
  Content-Type: application/x-www-form-urlencoded
  Authorization: Basic {base64(client_id:client_secret)}

  grant_type=client_credentials
  ```

  **Response**:
  ```json
  {
    "access_token": "NgCXRK...MzYjw",
    "token_type": "Bearer",
    "expires_in": 3600
  }
  ```
api_request_examples: |
  **Search Artist**:
  ```
  GET https://api.spotify.com/v1/search?q=Radiohead&type=artist&limit=1
  Authorization: Bearer {token}
  ```

  **Response**:
  ```json
  {
    "artists": {
      "items": [
        {
          "id": "4Z8W4fKeB5YxbusRsdQVPb",
          "name": "Radiohead",
          "genres": ["alternative rock", "art rock", "melancholia", "permanent wave", "rock"],
          "popularity": 81,
          "images": [
            {
              "url": "https://i.scdn.co/image/ab6761610000e5eb...",
              "height": 640,
              "width": 640
            },
            {
              "url": "https://i.scdn.co/image/ab67616100005174...",
              "height": 300,
              "width": 300
            }
          ],
          "followers": {
            "total": 10500000
          }
        }
      ]
    }
  }
  ```

  **Get Album**:
  ```
  GET https://api.spotify.com/v1/albums/6dVIqQ8qmQ5GBnJ9shOYGE
  Authorization: Bearer {token}
  ```
use_cases: |
  **Primary Use Cases**:
  1. **High-Quality Images**: Album artwork and artist photos (640x640, 300x300, 64x64)
  2. **Popularity Scores**: Trending and popular content (0-100 scale)
  3. **Genre Tags**: Curated genre classifications
  4. **Supplementary Metadata**: When MusicBrainz lacks data

  **Note**: Spotify API is for metadata only, NOT for music playback/streaming
image_quality: |
  **Image Sizes**:
  - Large: 640x640
  - Medium: 300x300
  - Small: 64x64

  **Advantages over other providers**:
  - Consistent high quality
  - Square aspect ratio (perfect for album covers)
  - Multiple sizes pre-generated
  - Modern, high-resolution

  **Download Strategy**:
  1. Fetch album details with images array
  2. Download largest size (640x640)
  3. Generate blurhash for lazy loading
  4. Store in local file system
  5. Use medium/small for thumbnails
popularity_score: |
  **Popularity Metric**:
  - 0-100 scale
  - Updated daily by Spotify
  - Based on recent play counts
  - Useful for "Trending" features

  **Usage**:
  ```sql
  -- Get popular albums in library
  SELECT a.title, s.popularity
  FROM albums a
  JOIN spotify_ids s ON s.content_id = a.id
  WHERE s.content_type = 'album'
  ORDER BY s.popularity DESC
  LIMIT 10;
  ```
unit_tests: |
  ```go
  func TestSpotifyProvider_ClientCredentials(t *testing.T) {
    // Test OAuth 2.0 token fetch and refresh
  }

  func TestSpotifyProvider_SearchArtist(t *testing.T) {
    // Test artist search with mock HTTP client
  }
  ```
integration_tests: |
  ```go
  func TestSpotify_FullWorkflow(t *testing.T) {
    // Use real Spotify API (with test credentials)
    // Test auth, search, image download
  }
  ```
