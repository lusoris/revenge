doc_title: Last.fm Integration
doc_category: integration
created_date: '2026-01-31'
overall_status: âœ… Complete
status_design: âœ…
status_design_notes: '-'
status_sources: âœ…
status_sources_notes: '-'
status_instructions: âœ…
status_instructions_notes: '-'
status_code: ðŸ”´
status_code_notes: '-'
status_linting: ðŸ”´
status_linting_notes: '-'
status_unit_testing: ðŸ”´
status_unit_testing_notes: '-'
status_integration_testing: ðŸ”´
status_integration_testing_notes: '-'
technical_summary: '> SUPPLEMENTARY enrichment provider (artist bios, tags, similar artists) + scrobbling'
wiki_tagline: '> Artist enrichment metadata (bios, tags, similar) - Supplementary to Lidarr'
wiki_overview: 'SUPPLEMENTARY enrichment for music metadata. Provides: (1) Artist biographies, (2) Community tags/genres,
  (3) Similar artist recommendations, (4) Album/track playcount stats. Also scrobbling service (see SCROBBLING.yaml). Free
  API key required. **Optional proxy/VPN routing** if needed (via HTTP_CLIENT service).'
sources:
- name: Go context
  url: https://pkg.go.dev/context
  note: Auto-resolved from go-context
- name: Last.fm API
  url: https://www.last.fm/api/intro
  note: Auto-resolved from lastfm-api
design_refs:
- title: 03_METADATA_SYSTEM
  path: ../../../architecture/03_METADATA_SYSTEM.md
- title: LIDARR (PRIMARY for music)
  path: ../../servarr/LIDARR.md
- title: HTTP_CLIENT (proxy/VPN support)
  path: ../../../services/HTTP_CLIENT.md
- title: MUSIC_MODULE
  path: ../../../features/music/MUSIC_MODULE.md
- title: SCROBBLING (Last.fm scrobbling)
  path: ../../../features/shared/SCROBBLING.md
integration_name: Last.fm
integration_id: lastfm
external_service: Last.fm
api_base_url: https://ws.audioscrobbler.com/2.0/
auth_method: api_key
architecture_diagram: |-
  ```mermaid
  flowchart LR
      subgraph Layer1["Layer 1"]
          node1[["Metadata<br/>Service"]]
          node2(["Last.fm<br/>Provider"])
          node3[["Last.fm<br/>API"]]
      end

      %% Connections

      %% Styling
      style Layer1 fill:#1976D2,stroke:#1976D2,color:#fff
  ```
api_details: |
  **API Version**: 2.0
  **Base URL**: `https://ws.audioscrobbler.com/2.0/`
  **Authentication**: API Key via query parameter
  **Rate Limit**: No official limit, respect fair use (~5 requests/second)

  **Key Endpoints (Methods)**:
  - `artist.getInfo` - Get artist details, bio, similar artists
  - `artist.getTags` - Get artist tags/genres
  - `artist.getSimilar` - Get similar artists
  - `album.getInfo` - Get album details
  - `track.getInfo` - Get track details
  - `track.getSimilar` - Get similar tracks
database_schema: |
  **Schema**: `public`

  ```sql
  -- Artist metadata enhancements from Last.fm
  CREATE TABLE artist_metadata_lastfm (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    artist_id UUID NOT NULL REFERENCES artists(id) ON DELETE CASCADE,

    -- Last.fm data
    bio_summary TEXT,
    bio_full TEXT,
    listeners INTEGER,
    play_count BIGINT,

    -- Tags
    tags JSONB,                                -- [{"name": "rock", "count": 100}]

    -- Similar artists (stored as MBIDs)
    similar_artists JSONB,                     -- [{"mbid": "...", "name": "...", "match": 0.95}]

    fetched_at TIMESTAMPTZ DEFAULT now(),
    UNIQUE(artist_id)
  );
  ```
module_structure: |
  ```
  internal/metadata/providers/lastfm/
  â”œâ”€â”€ module.go                    # fx module
  â”œâ”€â”€ client.go                    # Last.fm API client
  â”œâ”€â”€ provider.go                  # Metadata provider interface impl
  â”œâ”€â”€ artists.go                   # Artist metadata methods
  â”œâ”€â”€ tags.go                      # Tag/genre methods
  â”œâ”€â”€ similar.go                   # Similar artist/track methods
  â””â”€â”€ lastfm_test.go
  ```
key_interfaces: |
  ```go
  // Last.fm provider implementation
  type LastFMProvider struct {
    client      *LastFMClient
    apiKey      string
    cache       Cache
  }

  // Metadata provider interface
  type MetadataProvider interface {
    // Artist
    GetArtistInfo(ctx context.Context, artistName string, mbid *uuid.UUID) (*ArtistInfo, error)
    GetArtistTags(ctx context.Context, artistName string) ([]Tag, error)
    GetSimilarArtists(ctx context.Context, artistName string, limit int) ([]SimilarArtist, error)

    // Album
    GetAlbumInfo(ctx context.Context, artistName, albumName string, mbid *uuid.UUID) (*AlbumInfo, error)

    // Track
    GetTrackInfo(ctx context.Context, artistName, trackName string, mbid *uuid.UUID) (*TrackInfo, error)
    GetSimilarTracks(ctx context.Context, artistName, trackName string, limit int) ([]SimilarTrack, error)
  }

  // Artist info from Last.fm
  type ArtistInfo struct {
    Name       string         `xml:"name"`
    MBID       string         `xml:"mbid"`
    URL        string         `xml:"url"`
    Image      []Image        `xml:"image"`
    Listeners  int            `xml:"stats>listeners"`
    PlayCount  int64          `xml:"stats>playcount"`
    Bio        Bio            `xml:"bio"`
    Similar    []SimilarArtist `xml:"similar>artist"`
    Tags       []Tag          `xml:"tags>tag"`
  }

  type Bio struct {
    Summary string `xml:"summary"`
    Content string `xml:"content"`
  }

  type Tag struct {
    Name  string `xml:"name"`
    URL   string `xml:"url"`
    Count int    `xml:"count"`
  }

  type SimilarArtist struct {
    Name  string  `xml:"name"`
    MBID  string  `xml:"mbid"`
    Match float64 `xml:"match"`  // 0.0-1.0 similarity score
    Image []Image `xml:"image"`
  }
  ```
dependencies: |
  **Go Packages**:
  - `net/http` - HTTP client
  - `encoding/xml` - XML parsing (Last.fm uses XML by default)
  - `github.com/google/uuid` - UUID support
  - `github.com/jackc/pgx/v5` - PostgreSQL driver
  - `go.uber.org/fx` - Dependency injection

  **External APIs**:
  - Last.fm API 2.0 (free with API key)
env_vars: |
  ```bash
  # Last.fm API
  LASTFM_API_KEY=your_api_key_here
  LASTFM_API_SECRET=your_api_secret_here

  # Caching
  LASTFM_CACHE_TTL=168h  # 7 days
  ```
config_keys: |
  ```yaml
  metadata:
    providers:
      lastfm:
        enabled: true
        api_key: ${LASTFM_API_KEY}
        api_secret: ${LASTFM_API_SECRET}
        cache_ttl: 168h
  ```
component_interaction: |
  **Artist Bio Fetch**:
  1. Artist already in database (from MusicBrainz)
  2. Metadata service calls LastFMProvider.GetArtistInfo(name, mbid)
  3. Check cache for recent fetch (7 day TTL)
  4. If not cached, make API request: ?method=artist.getInfo&artist={name}
  5. Parse XML response
  6. Extract bio, tags, similar artists
  7. Store in artist_metadata_lastfm table
  8. Cache response for 7 days
  9. Display on artist page

  **Tag/Genre Enrichment**:
  1. Call GetArtistTags(artistName)
  2. Response: [{"name": "rock", "count": 100}, {"name": "alternative", "count": 85}]
  3. Store as JSONB in database
  4. Use tags for genre-based filtering and recommendations

  **Similar Artist Recommendations**:
  1. User views artist page
  2. Call GetSimilarArtists(artistName, limit=10)
  3. Response includes match score (0.0-1.0)
  4. Display "Similar Artists" section with top matches
  5. Link to other artists in library, or external Last.fm links
api_request_examples: |
  **Get Artist Info**:
  ```
  GET https://ws.audioscrobbler.com/2.0/?method=artist.getInfo&artist=Radiohead&api_key=xxx&format=json
  ```

  **Response** (JSON format):
  ```json
  {
    "artist": {
      "name": "Radiohead",
      "mbid": "a74b1b7f-71a5-4011-9441-d0b5e4122711",
      "url": "https://www.last.fm/music/Radiohead",
      "image": [
        {
          "size": "large",
          "#text": "https://lastfm.freetls.fastly.net/i/u/174s/2a96cbd8b46e442fc41c2b86b821562f.png"
        }
      ],
      "stats": {
        "listeners": "4800000",
        "playcount": "500000000"
      },
      "bio": {
        "summary": "Radiohead are an English rock band...",
        "content": "Radiohead are an English rock band from Abingdon, Oxfordshire..."
      },
      "tags": {
        "tag": [
          {"name": "alternative rock", "url": "..."},
          {"name": "rock", "url": "..."},
          {"name": "experimental", "url": "..."}
        ]
      },
      "similar": {
        "artist": [
          {
            "name": "Thom Yorke",
            "mbid": "8ed2e0b3-aa4c-4e13-bec3-dc7393ed4d6b",
            "match": "1.0",
            "image": [...]
          },
          {
            "name": "Muse",
            "match": "0.92"
          }
        ]
      }
    }
  }
  ```

  **Get Similar Artists**:
  ```
  GET https://ws.audioscrobbler.com/2.0/?method=artist.getSimilar&artist=Radiohead&limit=10&api_key=xxx&format=json
  ```
use_cases: |
  **Primary Use Cases**:
  1. **Artist Biographies**: Display rich text bios on artist pages
  2. **Genre Tags**: Community-curated tags for accurate genre classification
  3. **Similar Artists**: Recommendations for music discovery
  4. **Popularity Metrics**: Listener counts and play counts
  5. **Artist Images**: High-quality artist photos

  **Display Example**:
  ```
  Artist: Radiohead
  4.8M Listeners | 500M Plays

  Bio:
  Radiohead are an English rock band from Abingdon, Oxfordshire...

  Tags: alternative rock, rock, experimental, indie, progressive rock

  Similar Artists:
  ðŸŽµ Thom Yorke (100% match)
  ðŸŽµ Muse (92% match)
  ðŸŽµ Arcade Fire (87% match)
  ```
xml_parsing: |
  **XML Response Format**:
  - Last.fm returns XML by default (add `&format=json` for JSON)
  - Use `encoding/xml` package in Go
  - Define structs with xml tags

  **Example Parsing**:
  ```go
  type LastFMResponse struct {
    XMLName xml.Name   `xml:"lfm"`
    Status  string     `xml:"status,attr"`
    Artist  ArtistInfo `xml:"artist"`
  }

  var resp LastFMResponse
  err := xml.Unmarshal(body, &resp)
  ```
tag_system: |
  **Community Tags**:
  - Users tag artists/albums/tracks on Last.fm
  - Tags have counts (popularity)
  - More accurate than formal genre classifications

  **Tag Processing**:
  1. Fetch tags from API
  2. Store top 10 tags by count
  3. Use for filtering: "Show me all 'indie rock' artists"
  4. Generate genre recommendations

  **Example Tags**:
  - Artist: Radiohead â†’ [alternative rock, rock, experimental, indie, progressive rock]
  - Album: OK Computer â†’ [alternative rock, 90s, classic, art rock]
similar_artist_matching: |
  **Match Score**:
  - 1.0 = Perfect match (often solo projects of band members)
  - 0.8-0.99 = Very similar (same genre, style)
  - 0.6-0.79 = Somewhat similar
  - <0.6 = Loosely related

  **Storage**:
  ```json
  {
    "similar_artists": [
      {
        "name": "Thom Yorke",
        "mbid": "8ed2e0b3-aa4c-4e13-bec3-dc7393ed4d6b",
        "match": 1.0
      },
      {
        "name": "Muse",
        "mbid": "9c9f1380-2516-4fc9-a3e6-f9f61941d090",
        "match": 0.92
      }
    ]
  }
  ```
unit_tests: |
  ```go
  func TestLastFMProvider_GetArtistInfo(t *testing.T) {
    // Test artist info fetch with mock HTTP client
  }

  func TestLastFMProvider_XMLParsing(t *testing.T) {
    // Test XML response parsing
  }
  ```
integration_tests: |
  ```go
  func TestLastFM_FullWorkflow(t *testing.T) {
    // Use real Last.fm API (with test key)
    // Test artist info, tags, similar artists
  }
  ```
caching_strategy: |
  **Long TTL for Artist Data**:
  - Artist bios don't change frequently (7 day TTL)
  - Tags updated weekly, cache acceptable
  - Similar artists relatively stable

  **Cache Keys**:
  - `lastfm:artist:{mbid}` - Full artist info
  - `lastfm:tags:{mbid}` - Tags only
  - `lastfm:similar:{mbid}` - Similar artists
error_handling: |
  **API Error Codes**:
  - 6: Invalid parameters
  - 10: Invalid API key
  - 29: Rate limit exceeded

  **Error Handling**:
  - Invalid key: Log error, disable provider
  - Rate limit: Wait and retry with exponential backoff
  - Artist not found: Return nil, continue with MusicBrainz only
performance_optimization: |
  **Batch Fetching**:
  - Queue artist info requests
  - Process during library scan
  - Cache aggressively to reduce API calls

  **Selective Fetching**:
  - Only fetch for artists with >100 plays in library
  - Skip obscure artists to save API quota
