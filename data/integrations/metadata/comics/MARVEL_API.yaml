doc_title: Marvel API Integration
doc_category: integration
created_date: '2026-01-31'
overall_status: âœ… Complete
status_design: âœ…
status_design_notes: '-'
status_sources: âœ…
status_sources_notes: '-'
status_instructions: âœ…
status_instructions_notes: '-'
status_code: ğŸ”´
status_code_notes: '-'
status_linting: ğŸ”´
status_linting_notes: '-'
status_unit_testing: ğŸ”´
status_unit_testing_notes: '-'
status_integration_testing: ğŸ”´
status_integration_testing_notes: '-'
technical_summary: '> SUPPLEMENTARY official Marvel metadata - Marvel Universe content only'
wiki_tagline: '> Official Marvel Comics API for Marvel titles'
wiki_overview: 'SUPPLEMENTARY metadata source for Marvel comics ONLY. Official Marvel Developer API provides authoritative data for Marvel-published content. Character appearances, creator credits, event tie-ins. High-quality cover images directly from Marvel. **Only covers Marvel content** (not DC, indie, manga). Free developer account required. 3000 req/day rate limit.'
sources:
- name: Marvel Developer Portal
  url: https://developer.marvel.com/docs
  note: Official Marvel API documentation
- name: pgx PostgreSQL Driver
  url: https://pkg.go.dev/github.com/jackc/pgx/v5
  note: Auto-resolved from pgx
- name: golang.org/x/time
  url: https://pkg.go.dev/golang.org/x/time
  note: Rate limiting
- name: River Job Queue
  url: https://pkg.go.dev/github.com/riverqueue/river
  note: Auto-resolved from river
design_refs:
- title: 03_METADATA_SYSTEM
  path: ../../../architecture/03_METADATA_SYSTEM.md
- title: COMICS_MODULE
  path: ../../../features/comics/COMICS_MODULE.md
- title: COMICVINE (PRIMARY for comics)
  path: ./COMICVINE.md
- title: HTTP_CLIENT
  path: ../../../services/HTTP_CLIENT.md
integration_name: Marvel API
integration_id: marvel
external_service: Marvel Developer API
api_base_url: https://gateway.marvel.com/v1/public
auth_method: api_key_hash

architecture_diagram: |
  ```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Revenge     â”‚
  â”‚  Comics      â”‚
  â”‚  Library     â”‚
  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ PRIMARY                                  â”‚ SUPPLEMENTARY
         â–¼                                          â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  ComicVine   â”‚                           â”‚  Marvel API  â”‚
  â”‚  (all comics)â”‚                           â”‚ (Marvel only)â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                                             â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                                             â”‚  API Auth    â”‚
                                             â”‚ (hash-based) â”‚
                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Coverage:
  - Marvel Comics only (X-Men, Avengers, Spider-Man, etc.)
  - NOT: DC, Image, indie, manga
  - High-quality official images
  - Character/event relationships
  ```

api_details: |
  **API**: Marvel Developer Portal API v1
  **Base URL**: `https://gateway.marvel.com/v1/public`
  **Authentication**: API key + timestamp + MD5 hash
  **Rate Limit**: 3000 requests per day

  **Authentication Formula**:
  ```
  ts = current timestamp
  hash = md5(ts + privateKey + publicKey)
  url = base + endpoint + ?ts={ts}&apikey={publicKey}&hash={hash}
  ```

  **Key Endpoints**:
  - `GET /comics` - Search comics
  - `GET /comics/{id}` - Comic details
  - `GET /series` - Series list
  - `GET /series/{id}` - Series details
  - `GET /characters` - Characters
  - `GET /characters/{id}` - Character details
  - `GET /creators` - Creators
  - `GET /events` - Crossover events

  **Data Model**:
  ```
  Series â†’ Comics â†’ Stories
     â†“        â†“
  Characters, Creators, Events
  ```

database_schema: |
  ```sql
  -- Marvel comic cache
  CREATE TABLE marvel_comics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    marvel_id INT UNIQUE NOT NULL,
    title VARCHAR(500) NOT NULL,
    issue_number INT,
    description TEXT,
    upc VARCHAR(50),
    isbn VARCHAR(20),
    format VARCHAR(50),
    page_count INT,
    thumbnail_url TEXT,
    on_sale_date DATE,
    fetched_at TIMESTAMPTZ DEFAULT now(),
    expires_at TIMESTAMPTZ NOT NULL
  );
  CREATE INDEX idx_marvel_comics ON marvel_comics(marvel_id);

  -- Marvel character appearances
  CREATE TABLE marvel_comic_characters (
    comic_id UUID REFERENCES marvel_comics(id),
    marvel_character_id INT NOT NULL,
    character_name VARCHAR(255),
    PRIMARY KEY (comic_id, marvel_character_id)
  );

  -- Comic to Marvel mapping
  CREATE TABLE comic_marvel_mappings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    comic_issue_id UUID REFERENCES comic_issues(id),
    marvel_id INT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT now(),
    UNIQUE(comic_issue_id)
  );
  ```

module_structure: |
  ```
  internal/metadata/providers/marvel/
  â”œâ”€â”€ module.go                    # fx module
  â”œâ”€â”€ client.go                    # Marvel API client
  â”œâ”€â”€ auth.go                      # Hash-based authentication
  â”œâ”€â”€ provider.go                  # Supplementary provider
  â”œâ”€â”€ comics.go                    # Comic endpoints
  â”œâ”€â”€ characters.go                # Character endpoints
  â”œâ”€â”€ series.go                    # Series endpoints
  â””â”€â”€ marvel_test.go
  ```

key_interfaces: |
  ```go
  // Marvel API client
  type MarvelClient struct {
    publicKey   string
    privateKey  string
    httpClient  *http.Client
    rateLimiter *rate.Limiter
  }

  // Generate Marvel API authentication
  func (c *MarvelClient) generateAuth() (ts string, hash string) {
    ts = strconv.FormatInt(time.Now().Unix(), 10)
    data := ts + c.privateKey + c.publicKey
    hash = fmt.Sprintf("%x", md5.Sum([]byte(data)))
    return ts, hash
  }

  // Supplementary provider interface
  type MarvelProvider interface {
    SearchComics(ctx context.Context, title string) ([]Comic, error)
    GetComic(ctx context.Context, marvelID int) (*Comic, error)
    GetSeriesComics(ctx context.Context, seriesID int) ([]Comic, error)
    GetCharacter(ctx context.Context, characterID int) (*Character, error)
    GetEvent(ctx context.Context, eventID int) (*Event, error)
    Priority() int  // Returns 15 (between ComicVine and GCD)
  }

  // Marvel Comic
  type Comic struct {
    ID          int       `json:"id"`
    Title       string    `json:"title"`
    IssueNumber int       `json:"issueNumber"`
    Description string    `json:"description"`
    UPC         string    `json:"upc"`
    ISBN        string    `json:"isbn"`
    Format      string    `json:"format"`
    PageCount   int       `json:"pageCount"`
    Thumbnail   Image     `json:"thumbnail"`
    OnSaleDate  time.Time `json:"dates[0].date"`
    Creators    []Creator `json:"creators.items"`
    Characters  []Character `json:"characters.items"`
    Events      []Event   `json:"events.items"`
  }

  // Marvel Character
  type Character struct {
    ID          int    `json:"id"`
    Name        string `json:"name"`
    Description string `json:"description"`
    Thumbnail   Image  `json:"thumbnail"`
    ComicsAvailable int `json:"comics.available"`
  }
  ```

dependencies: |
  **Go Packages**:
  - `net/http` - HTTP client
  - `crypto/md5` - Hash generation for auth
  - `golang.org/x/time/rate` - Rate limiting
  - `github.com/jackc/pgx/v5` - PostgreSQL
  - `github.com/riverqueue/river` - Background jobs
  - `go.uber.org/fx` - DI

  **External**:
  - Marvel Developer API (free account required)

env_vars: |
  ```bash
  MARVEL_ENABLED=true
  MARVEL_PUBLIC_KEY=your_public_key
  MARVEL_PRIVATE_KEY=your_private_key
  MARVEL_CACHE_TTL=168h
  ```

config_keys: |
  ```yaml
  metadata:
    providers:
      marvel:
        enabled: true
        public_key: ${MARVEL_PUBLIC_KEY}
        private_key: ${MARVEL_PRIVATE_KEY}
        cache_ttl: 168h
        role: supplementary
        priority: 15          # Between ComicVine (10) and GCD (20)
        daily_limit: 3000     # API limit
  ```

component_interaction: |
  **Marvel Comic Enrichment**:
  1. Comic identified via ComicVine (PRIMARY)
  2. Check if publisher is Marvel
  3. If Marvel: query Marvel API for additional data
  4. Fetch official high-quality cover images
  5. Get character appearances and event tie-ins
  6. Store Marvel-specific data

  **Character Linking**:
  1. Marvel comic identified
  2. Fetch character list from Marvel API
  3. Store character appearances
  4. Display character info on comic detail page
  5. Link to Marvel Universe character profiles

supplementary_role: |
  **SUPPLEMENTARY Metadata Provider**

  **PRIMARY source**: ComicVine (covers all publishers)

  **Marvel API used as SUPPLEMENTARY**:
  1. **Enrichment** for Marvel comics with official data
  2. **High-quality images** directly from Marvel
  3. **Character/event relationships** for Marvel Universe

  **Limitations**:
  - ONLY Marvel-published content
  - No DC, Image, indie, manga coverage
  - 3000 requests/day limit

api_request_examples: |
  **Search for Comic**:
  ```bash
  ts=1234567890
  hash=md5(${ts}${PRIVATE_KEY}${PUBLIC_KEY})
  curl "https://gateway.marvel.com/v1/public/comics?title=Amazing%20Spider-Man&ts=${ts}&apikey=${PUBLIC_KEY}&hash=${hash}"
  ```

  **Response**:
  ```json
  {
    "data": {
      "results": [
        {
          "id": 12345,
          "title": "Amazing Spider-Man (2018) #1",
          "issueNumber": 1,
          "description": "...",
          "thumbnail": {
            "path": "https://i.annihil.us/u/prod/marvel/i/mg/...",
            "extension": "jpg"
          },
          "characters": {
            "items": [
              {"resourceURI": "...", "name": "Spider-Man"}
            ]
          }
        }
      ]
    }
  }
  ```

authentication: |
  **Marvel API Authentication**:
  ```go
  func (c *MarvelClient) request(ctx context.Context, endpoint string, params url.Values) (*http.Response, error) {
    ts, hash := c.generateAuth()

    params.Set("ts", ts)
    params.Set("apikey", c.publicKey)
    params.Set("hash", hash)

    url := c.baseURL + endpoint + "?" + params.Encode()
    return c.httpClient.Get(url)
  }
  ```

error_handling: |
  **HTTP Errors**:
  - 401 Unauthorized â†’ Invalid API keys
  - 403 Forbidden â†’ Rate limit exceeded
  - 404 Not Found â†’ Comic/character not found
  - 409 Conflict â†’ Missing timestamp/hash

unit_tests: |
  ```go
  func TestMarvel_GenerateAuth(t *testing.T) {
    client := NewMarvelClient("public", "private")

    ts, hash := client.generateAuth()
    assert.NotEmpty(t, ts)
    assert.Len(t, hash, 32)  // MD5 hex
  }

  func TestMarvel_SearchComics(t *testing.T) {
    mockResp := `{"data":{"results":[{"id":12345,"title":"Spider-Man #1"}]}}`
    provider := NewMarvelProvider(mockClient(mockResp))

    results, err := provider.SearchComics(ctx, "Spider-Man")
    require.NoError(t, err)
    assert.Len(t, results, 1)
  }
  ```

best_practices: |
  **API Usage**:
  - Monitor daily request count (3000 limit)
  - Cache aggressively (data rarely changes)
  - Only query for Marvel-published comics

  **Attribution**:
  - Display Marvel attribution per API terms
  - "Data provided by Marvel. Â© 2026 MARVEL"

  **Integration**:
  - Detect Marvel publisher from ComicVine
  - Use Marvel API for official images
  - Cross-reference character appearances
