doc_title: TVHeadend Integration
doc_category: integration
created_date: '2026-01-31'
overall_status: âœ… Complete
status_design: âœ…
status_design_notes: '-'
status_sources: âœ…
status_sources_notes: '-'
status_instructions: âœ…
status_instructions_notes: '-'
status_code: ğŸ”´
status_code_notes: '-'
status_linting: ğŸ”´
status_linting_notes: '-'
status_unit_testing: ğŸ”´
status_unit_testing_notes: '-'
status_integration_testing: ğŸ”´
status_integration_testing_notes: '-'
technical_summary: '> Open-source TV streaming server and DVR'
wiki_tagline: '> Live TV and DVR with TVHeadend'
wiki_overview: TVHeadend integration brings live TV and DVR to Revenge. Supports DVB,
  IPTV, and other broadcast sources. Watch live channels through the Revenge interface.
  Schedule recordings and manage the DVR queue. EPG data displays what is currently
  airing and coming up next.
sources:
- name: gohlslib (HLS)
  url: https://pkg.go.dev/github.com/bluenviron/gohlslib/v2
  note: Auto-resolved from gohlslib
- name: M3U8 Extended Format
  url: https://datatracker.ietf.org/doc/html/rfc8216
  note: Auto-resolved from m3u8
design_refs:
- title: 01_ARCHITECTURE
  path: ../../architecture/01_ARCHITECTURE.md
- title: 02_DESIGN_PRINCIPLES
  path: ../../architecture/02_DESIGN_PRINCIPLES.md
- title: 03_METADATA_SYSTEM
  path: ../../architecture/03_METADATA_SYSTEM.md
integration_name: TVHeadend
integration_id: tvheadend
external_service: TVHeadend
api_base_url: http://tvheadend.local:9981
auth_method: basic

architecture_diagram: |
  ```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    1. View EPG      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   Revenge    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   EPG Service   â”‚
  â”‚  Web Client  â”‚                     â”‚  (Revenge)      â”‚
  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                      â”‚
         â”‚ 2. Select channel                   â”‚ 3. Fetch EPG from
         â”‚                                      â”‚    TVHeadend
         â”‚                                      â–¼
         â”‚                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                             â”‚  TVHeadend API â”‚
         â”‚                             â”‚  /api/channel/ â”‚
         â”‚                             â”‚  /api/epg/     â”‚
         â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                      â”‚
         â”‚ 4. Play live/DVR                    â”‚ 5. Get stream
         â–¼                                      â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   Player     â”‚    6. Request       â”‚  TVHeadend     â”‚
  â”‚  (Vidstack)  â”‚â”€â”€â”€â”€HLS/MPEG-TSâ”€â”€â”€â”€â”€â–¶â”‚  Streaming     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚  /stream/...   â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                         7. Stream from
                                            adapter/DVR
                                                 â–¼
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚ DVB Adapter/   â”‚
                                        â”‚ IPTV/DVR Files â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```

protocol_details: |
  **TVHeadend REST API**:

  **Base URL**: `http://tvheadend.local:9981`
  **Format**: JSON
  **Authentication**: HTTP Basic Auth

  **Key Endpoints**:
  - `GET /api/channel/grid` - Get channels
  - `GET /api/epg/events/grid` - Get EPG events
  - `GET /api/dvr/entry/grid_finished` - Get recordings
  - `GET /api/dvr/entry/grid_upcoming` - Get scheduled
  - `POST /api/dvr/entry/create` - Schedule recording
  - `POST /api/dvr/entry/cancel` - Cancel recording
  - `GET /stream/channel/{uuid}` - Live stream
  - `GET /dvrfile/{uuid}` - Recording playback

  **Authentication**:
  - HTTP Basic Auth (username:password)
  - Base64 encoded in Authorization header

  **Streaming**:
  - Formats: HLS, MPEG-TS, Matroska, Pass-through
  - Profiles: Customizable streaming profiles
  - Transcode: Optional real-time transcoding

  **EPG**:
  - Integrated EPG grabbers (OTA, XMLTV, Schedules Direct)
  - Real-time EPG updates
  - Multi-day EPG cache

module_structure: |
  ```
  internal/
    livetv/
      tvheadend/
        client.go         # REST API client
        auth.go           # Basic auth handling
        channels.go       # Channel management
        epg.go            # EPG data fetching
        dvr.go            # DVR operations
        stream.go         # Stream handling
        types.go          # Response types
        module.go         # fx module
        client_test.go
  ```

key_interfaces: |
  ```go
  // TVHeadendClient manages TVHeadend REST API
  type TVHeadendClient interface {
      // Get all channels
      GetChannels(ctx context.Context) ([]Channel, error)

      // Get EPG events
      GetEPGEvents(ctx context.Context, startTime, endTime time.Time) ([]EPGEvent, error)

      // Get finished recordings
      GetRecordings(ctx context.Context) ([]DVREntry, error)

      // Get upcoming recordings
      GetUpcoming(ctx context.Context) ([]DVREntry, error)

      // Create DVR entry (schedule recording)
      CreateDVREntry(ctx context.Context, req *DVRRequest) error

      // Cancel recording
      CancelDVREntry(ctx context.Context, uuid string) error

      // Get channel stream URL
      GetStreamURL(channelUUID string, profile string) string

      // Get recording file URL
      GetRecordingURL(dvrUUID string) string
  }

  type TVHeadendConfig struct {
      BaseURL      string
      Username     string
      Password     string
      Enabled      bool
      SyncInterval time.Duration
      StreamProfile string  // Streaming profile to use
  }

  type Channel struct {
      UUID     string
      Number   int
      Name     string
      Icon     string
      IconPublicURL string
      Services []string
      Tags     []string
      Enabled  bool
  }

  type EPGEvent struct {
      EventID     int
      ChannelUUID string
      ChannelName string
      Title       string
      Subtitle    string
      Summary     string
      Description string
      Start       time.Time
      Stop        time.Time
      Genre       []int
      EpisodeURI  string
      SeasonNumber int
      EpisodeNumber int
      PartNumber  int
  }

  type DVREntry struct {
      UUID          string
      EventID       int
      ChannelName   string
      Title         string
      Subtitle      string
      Description   string
      Start         time.Time
      Stop          time.Time
      Duration      int  // Seconds
      FileSize      int64
      Status        string  // scheduled, recording, completed, missed, etc.
      Enabled       bool
      AutoRec       bool  // Auto-recorded
      TimeRec       bool  // Time-based recording
  }

  type DVRRequest struct {
      EventID   int    `json:"event_id,omitempty"`
      ChannelID string `json:"channelid,omitempty"`
      Start     int64  `json:"start,omitempty"`  // Unix timestamp
      Stop      int64  `json:"stop,omitempty"`   // Unix timestamp
      Title     string `json:"title,omitempty"`
      Comment   string `json:"comment,omitempty"`
  }

  type GridResponse struct {
      Entries []json.RawMessage `json:"entries"`
      Total   int               `json:"totalCount"`
  }
  ```

dependencies: |
  **Go Packages**:
  - `github.com/bluenviron/gohlslib/v2` - HLS handling
  - `github.com/riverqueue/river` - Background sync
  - `encoding/base64` - Basic auth
  - `net/http` - HTTP client

  **External Services**:
  - TVHeadend server (https://tvheadend.org)

env_vars: |
  ```bash
  REVENGE_TVHEADEND_ENABLED=true
  REVENGE_TVHEADEND_BASE_URL=http://tvheadend.local:9981
  REVENGE_TVHEADEND_USERNAME=admin
  REVENGE_TVHEADEND_PASSWORD=admin
  REVENGE_TVHEADEND_SYNC_INTERVAL=15m
  REVENGE_TVHEADEND_STREAM_PROFILE=pass
  ```

config_keys: |
  ```yaml
  livetv:
    tvheadend:
      enabled: true
      base_url: http://tvheadend.local:9981
      username: ${REVENGE_TVHEADEND_USERNAME}
      password: ${REVENGE_TVHEADEND_PASSWORD}
      sync_interval: 15m
      stream_profile: "pass"     # pass, webtv, htsp
      use_channel_icons: true
      epg_days: 7
  ```

authentication: |
  **HTTP Basic Authentication**:

  ```go
  func (c *TVHeadendClient) makeRequest(ctx context.Context, method, path string, body io.Reader) (*http.Response, error) {
      url := c.baseURL + path

      req, err := http.NewRequestWithContext(ctx, method, url, body)
      if err != nil {
          return nil, err
      }

      // Add Basic Auth
      auth := c.username + ":" + c.password
      encodedAuth := base64.StdEncoding.EncodeToString([]byte(auth))
      req.Header.Set("Authorization", "Basic "+encodedAuth)

      resp, err := c.httpClient.Do(req)
      if err != nil {
          return nil, err
      }

      if resp.StatusCode == 401 {
          return nil, fmt.Errorf("authentication failed: invalid credentials")
      }

      return resp, nil
  }
  ```

component_interaction: |
  **EPG Sync Workflow**:
  1. River cron job (every 15 minutes)
  2. GET /api/channel/grid - fetch channels
  3. GET /api/epg/events/grid with time range
  4. Parse and store EPG in database
  5. Update channel metadata and icons

  **Live TV Playback**:
  1. User selects channel
  2. Generate stream URL: /stream/channel/{uuid}?profile={profile}
  3. Pass URL to Vidstack player
  4. Player loads HLS/MPEG-TS stream

  **DVR Recording**:
  1. User schedules recording from EPG
  2. POST /api/dvr/entry/create with event details
  3. TVHeadend schedules recording
  4. Recording appears in upcoming list
  5. After recording, appears in finished list
  6. Playback via /dvrfile/{uuid}

api_endpoints: |
  **Revenge API Endpoints**:

  ```
  GET  /api/v1/livetv/tvheadend/channels
  GET  /api/v1/livetv/tvheadend/epg
  GET  /api/v1/livetv/tvheadend/recordings
  GET  /api/v1/livetv/tvheadend/upcoming
  POST /api/v1/livetv/tvheadend/record
  DELETE /api/v1/livetv/tvheadend/recordings/{uuid}
  POST /api/v1/livetv/tvheadend/sync
  ```

  **Example - Get Channels**:
  ```json
  GET /api/v1/livetv/tvheadend/channels

  Response:
  {
    "channels": [
      {
        "uuid": "abc123",
        "number": 1,
        "name": "BBC One",
        "icon": "http://tvheadend.local:9981/imagecache/123",
        "enabled": true
      }
    ]
  }
  ```

  **Example - Schedule Recording**:
  ```json
  POST /api/v1/livetv/tvheadend/record
  {
    "event_id": 12345,
    "title": "Doctor Who",
    "comment": "Series recording"
  }

  Response:
  {
    "success": true,
    "uuid": "dvr-xyz789"
  }
  ```

error_handling: |
  **Common Errors**:
  - **401 Unauthorized**: Invalid credentials
    - Solution: Check username/password config

  - **503 Service Unavailable**: No available tuners
    - Solution: Wait or cancel conflicting recording

  - **404 Not Found**: Channel/event doesn't exist
    - Solution: Refresh channel/EPG data

  - **400 Bad Request**: Invalid DVR request
    - Solution: Validate event_id and time range

unit_tests: |
  ```go
  func TestTVHeadendClient_GetChannels(t *testing.T) {
      mockServer := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
          // Verify Basic Auth
          auth := r.Header.Get("Authorization")
          assert.Contains(t, auth, "Basic")

          w.Header().Set("Content-Type", "application/json")
          json.NewEncoder(w).Encode(map[string]interface{}{
              "entries": []map[string]interface{}{
                  {
                      "uuid":   "abc123",
                      "name":   "BBC One",
                      "number": 1,
                  },
              },
              "totalCount": 1,
          })
      }))
      defer mockServer.Close()

      client := NewTVHeadendClient(mockServer.URL, "admin", "admin")
      channels, err := client.GetChannels(context.Background())

      require.NoError(t, err)
      assert.Len(t, channels, 1)
      assert.Equal(t, "BBC One", channels[0].Name)
  }

  func TestBasicAuth(t *testing.T) {
      auth := "admin:password"
      encoded := base64.StdEncoding.EncodeToString([]byte(auth))
      assert.NotEmpty(t, encoded)
  }
  ```

integration_tests: |
  ```go
  func TestTVHeadend_FullWorkflow(t *testing.T) {
      if testing.Short() {
          t.Skip("skipping integration test")
      }

      baseURL := os.Getenv("TVHEADEND_URL")
      username := os.Getenv("TVHEADEND_USERNAME")
      password := os.Getenv("TVHEADEND_PASSWORD")
      if baseURL == "" {
          t.Skip("no TVHeadend config provided")
      }

      client := NewTVHeadendClient(baseURL, username, password)

      // Test get channels
      channels, err := client.GetChannels(context.Background())
      require.NoError(t, err)
      require.NotEmpty(t, channels)

      // Test get EPG
      now := time.Now()
      events, err := client.GetEPGEvents(context.Background(), now, now.Add(24*time.Hour))
      require.NoError(t, err)
      // May be empty if no EPG data
  }
  ```

best_practices: |
  **Configuration**:
  - Use strong credentials (not default admin:admin)
  - Secure TVHeadend web interface (HTTPS recommended)
  - Configure appropriate user permissions
  - Set up EPG grabbers in TVHeadend first

  **EPG**:
  - Sync every 15 minutes for current data
  - Cache 7 days of EPG data
  - Index epg_events by channel_uuid + start
  - Clean up old EPG data (older than cache period)

  **DVR**:
  - Monitor disk space for recordings
  - Implement retention policies (auto-delete old recordings)
  - Handle recording conflicts (multiple programs, limited tuners)
  - Provide post-processing options

  **Streaming**:
  - Use "pass" profile for direct streaming (best quality)
  - Use "webtv" profile for transcoded HLS
  - Configure hardware acceleration in TVHeadend if available
  - Direct stream URLs when possible (no proxy)

  **Channel Management**:
  - Use TVHeadend's channel tagging for organization
  - Map channels to Revenge categories
  - Cache channel icons locally
  - Respect enabled/disabled channel state

  **Performance**:
  - HTTP connection pooling
  - Cache channel list (refresh hourly)
  - Batch EPG requests
  - Index database queries

  **Monitoring**:
  - Track tuner utilization
  - Monitor recording success rate
  - Log authentication failures
  - Alert on disk space issues
  - Track EPG sync failures
