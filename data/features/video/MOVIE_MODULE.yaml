doc_title: Movie Module
doc_category: feature
created_date: '2026-01-31'
overall_status: âœ… Complete
status_design: âœ… Complete
status_design_notes: '-'
status_sources: âœ… Complete
status_sources_notes: '-'
status_instructions: ðŸŸ¡ Partial
status_instructions_notes: '-'
status_code: ðŸ”´ Not Started
status_code_notes: '-'
status_linting: ðŸ”´ Not Started
status_linting_notes: '-'
status_unit_testing: ðŸ”´ Not Started
status_unit_testing_notes: '-'
status_integration_testing: ðŸ”´ Not Started
status_integration_testing_notes: '-'
technical_summary: '> Movie content management with metadata enrichment'
wiki_tagline: '> Your movie library with rich metadata and artwork'
wiki_overview: Manage your movie collection with automatic metadata from Radarr (PRIMARY source, aggregates from TMDb locally),
  with direct TMDb API as supplementary enrichment. Movies are organized with posters, backdrops, cast info, and trailers.
  Group movies into collections (like Marvel, Star Wars, or custom sets). Filter by genre, year, rating, or resolution. Track
  watched status per user. Radarr integration provides both metadata caching and download automation.
design_refs:
- title: 01_ARCHITECTURE
  path: ../../architecture/01_ARCHITECTURE.md
- title: 02_DESIGN_PRINCIPLES
  path: ../../architecture/02_DESIGN_PRINCIPLES.md
- title: 03_METADATA_SYSTEM
  path: ../../architecture/03_METADATA_SYSTEM.md
- title: RADARR (PRIMARY metadata + downloads)
  path: ../../integrations/servarr/RADARR.md
- title: TMDB (supplementary metadata)
  path: ../../integrations/metadata/TMDB.md
- title: OMDB (ratings enrichment)
  path: ../../integrations/metadata/OMDB.md
- title: TRAKT (scrobbling + metadata enrichment)
  path: ../../integrations/scrobbling/TRAKT.md
feature_name: Movie Module
module_name: movie
schema_name: public
content_types:
- Movies
- Collections
architecture_diagram: |-
  ```mermaid
  flowchart TD
      node1["Client<br/>(Web/App)"]
      node2["API Handler<br/>(ogen)"]
      node3["Service<br/>(Logic)"]
      node4["itory<br/>Metadata<br/>Cac"]
      node5["arr<br/>TMDb<br/>ARY)"]
      node6["TMDb<br/>(external)"]
      node1 --> node2
      node2 --> node3
      node3 --> node4
      node4 --> node5
      node5 --> node6
  ```
database_schema: |
  **Schema**: `public`

  **Tables**:
  - `movies`: Core movie metadata (title, year, runtime, etc.)
  - `movie_files`: Physical files associated with movies
  - `movie_credits`: Cast and crew information
  - `movie_collections`: Movie collection definitions
  - `movie_collection_members`: Movies in collections
  - `movie_genres`: Genre associations
  - `movie_watched`: Per-user watch history
  - `movie_metadata_cache`: Cached metadata from providers

  **Key Columns** (`movies`):
  - `id` (UUID): Primary key
  - `tmdb_id` (INTEGER): TMDb identifier
  - `imdb_id` (TEXT): IMDb identifier
  - `title` (TEXT): Movie title
  - `original_title` (TEXT): Original language title
  - `year` (INTEGER): Release year
  - `runtime` (INTEGER): Duration in minutes
  - `overview` (TEXT): Plot synopsis
  - `poster_path` (TEXT): Poster image path
  - `backdrop_path` (TEXT): Backdrop image path
  - `trailer_url` (TEXT): Trailer video URL
  - `rating` (DECIMAL): Average rating
  - `vote_count` (INTEGER): Number of votes
  - `budget` (BIGINT): Production budget
  - `revenue` (BIGINT): Box office revenue
  - `tagline` (TEXT): Movie tagline
  - `status` (TEXT): Release status (released, post-production, etc.)
  - `created_at` (TIMESTAMPTZ): Record creation time
  - `updated_at` (TIMESTAMPTZ): Last update time

  **Indexes**:
  - `idx_movies_tmdb_id` on `tmdb_id`
  - `idx_movies_imdb_id` on `imdb_id`
  - `idx_movies_year` on `year`
  - `idx_movies_title_trgm` (GIN trigram) for fuzzy search
  - `idx_movie_watched_user_movie` on (`user_id`, `movie_id`)
module_structure: |
  ```
  internal/content/movie/
  â”œâ”€â”€ module.go              # fx module definition
  â”œâ”€â”€ repository.go          # Database operations (sqlc generated)
  â”œâ”€â”€ service.go             # Business logic
  â”œâ”€â”€ handler.go             # HTTP handlers (ogen generated)
  â”œâ”€â”€ types.go               # Domain types
  â”œâ”€â”€ cache.go               # Caching layer (otter)
  â””â”€â”€ metadata/
      â”œâ”€â”€ provider.go        # Metadata provider interface
      â”œâ”€â”€ tmdb.go            # TMDb integration
      â””â”€â”€ enricher.go        # Metadata enrichment logic
  ```
component_interaction: |
  1. **Request Flow**:
     - Client sends HTTP request to `/api/v1/movies`
     - API handler (ogen) validates request and calls service
     - Service checks cache for existing data
     - If cache miss, service calls repository for database query
     - Repository executes SQL via sqlc-generated code
     - Results flow back through service â†’ handler â†’ client

  2. **Metadata Enrichment**:
     - Background job triggered on movie addition
     - Service calls metadata provider (TMDb)
     - Provider fetches movie details, cast, crew, images
     - Service updates database and invalidates cache
     - Cache warms up on next request

  3. **Collection Management**:
     - Service groups movies by collection ID
     - Repository uses JOIN queries for efficient fetching
     - Cache stores collection metadata separately
     - Updates propagate to all collection members
file_structure: |
  ```
  internal/content/movie/
  â”œâ”€â”€ module.go              # fx.Module with all providers
  â”œâ”€â”€ repository.go          # Database layer
  â”œâ”€â”€ repository_test.go     # Repository tests (testcontainers)
  â”œâ”€â”€ service.go             # Business logic
  â”œâ”€â”€ service_test.go        # Service tests (mocks)
  â”œâ”€â”€ handler.go             # HTTP handlers
  â”œâ”€â”€ handler_test.go        # Handler tests (httptest)
  â”œâ”€â”€ types.go               # Domain types
  â”œâ”€â”€ cache.go               # Caching logic
  â”œâ”€â”€ cache_test.go          # Cache tests
  â””â”€â”€ metadata/
      â”œâ”€â”€ provider.go        # Interface: MetadataProvider
      â”œâ”€â”€ tmdb.go            # TMDb implementation
      â”œâ”€â”€ tmdb_test.go       # TMDb integration tests
      â””â”€â”€ enricher.go        # Enrichment orchestration

  migrations/
  â””â”€â”€ 001_movies.sql         # Database schema migration

  api/
  â””â”€â”€ openapi.yaml           # OpenAPI spec (movies endpoints)
  ```
key_interfaces: |
  ```go
  // Repository defines database operations for movies
  type Repository interface {
      // Movie CRUD
      GetMovie(ctx context.Context, id uuid.UUID) (*Movie, error)
      ListMovies(ctx context.Context, filters ListFilters) ([]Movie, error)
      CreateMovie(ctx context.Context, movie *Movie) error
      UpdateMovie(ctx context.Context, movie *Movie) error
      DeleteMovie(ctx context.Context, id uuid.UUID) error

      // Collections
      GetCollection(ctx context.Context, id uuid.UUID) (*Collection, error)
      ListCollections(ctx context.Context) ([]Collection, error)
      AddMovieToCollection(ctx context.Context, movieID, collectionID uuid.UUID) error

      // Watch history
      MarkWatched(ctx context.Context, userID, movieID uuid.UUID) error
      GetWatchHistory(ctx context.Context, userID uuid.UUID) ([]WatchHistory, error)
  }

  // Service defines business logic for movies
  type Service interface {
      // Movie operations
      GetMovie(ctx context.Context, id uuid.UUID) (*Movie, error)
      SearchMovies(ctx context.Context, query string, filters SearchFilters) ([]Movie, error)
      EnrichMovie(ctx context.Context, id uuid.UUID) error

      // Collection operations
      GetCollection(ctx context.Context, id uuid.UUID) (*Collection, error)
      CreateCollection(ctx context.Context, name string, movieIDs []uuid.UUID) (*Collection, error)
  }

  // MetadataProvider fetches movie metadata from external sources
  type MetadataProvider interface {
      GetMovieByTMDbID(ctx context.Context, tmdbID int) (*MovieMetadata, error)
      SearchMovies(ctx context.Context, query string, year int) ([]MovieMetadata, error)
      GetMovieCredits(ctx context.Context, tmdbID int) (*Credits, error)
      GetMovieImages(ctx context.Context, tmdbID int) (*Images, error)
  }
  ```
dependencies: |
  **Go Dependencies**:
  - `github.com/jackc/pgx/v5/pgxpool` - PostgreSQL connection pool
  - `github.com/google/uuid` - UUID generation
  - `github.com/maypok86/otter` - In-memory cache
  - `github.com/go-resty/resty/v2` - HTTP client for external APIs
  - `go.uber.org/fx` - Dependency injection
  - `github.com/riverqueue/river` - Background job queue
  - `golang.org/x/net/proxy` - SOCKS5 proxy support for external metadata calls

  **External APIs** (priority order):
  - **Radarr API v3** - PRIMARY metadata source (local TMDb cache) + download automation
  - **TMDb API v3** - Supplementary metadata (via proxy/VPN when Radarr lacks data)
  - **TheTVDB API** - Additional fallback metadata source

  **Database**:
  - PostgreSQL 18+ with trigram extension for fuzzy search
env_vars: |
  **Environment Variables**:
  - `REVENGE_MOVIE_CACHE_TTL` - Cache TTL duration (default: 5m)
  - `REVENGE_MOVIE_CACHE_SIZE` - Cache size in MB (default: 100)
  - `REVENGE_METADATA_TMDB_API_KEY` - TMDb API key (required)
  - `REVENGE_METADATA_TMDB_RATE_LIMIT` - Rate limit per second (default: 40)
  - `REVENGE_RADARR_URL` - Radarr instance URL (optional)
  - `REVENGE_RADARR_API_KEY` - Radarr API key (optional)
config_keys: |
  **config.yaml keys**:
  ```yaml
  movie:
    cache:
      ttl: 5m
      size_mb: 100

    metadata:
      priority:
        - radarr      # PRIMARY: Local TMDb cache
        - tmdb        # Supplementary: Direct API (via proxy/VPN)
        - thetvdb     # Fallback
      tmdb:
        api_key: ${REVENGE_METADATA_TMDB_API_KEY}
        rate_limit: 40
        proxy: tor    # Route through proxy/VPN (see HTTP_CLIENT service)

    arr:
      radarr:
        enabled: true       # Should be enabled for PRIMARY metadata
        url: ${REVENGE_RADARR_URL}
        api_key: ${REVENGE_RADARR_API_KEY}
        sync_interval: 15m
  ```
defaults: |
  - Cache TTL: 5 minutes
  - Cache size: 100 MB
  - TMDb rate limit: 40 requests/second
  - Metadata priority: Radarr (PRIMARY) â†’ TMDb (via proxy) â†’ TheTVDB
  - Radarr sync: Enabled by default (required for PRIMARY metadata)
  - TMDb proxy: Uses tor proxy from HTTP_CLIENT service
endpoints: |
  **Movies**:
  - `GET /api/v1/movies` - List movies with filters
  - `GET /api/v1/movies/{id}` - Get movie details
  - `POST /api/v1/movies` - Create movie (admin)
  - `PUT /api/v1/movies/{id}` - Update movie (admin)
  - `DELETE /api/v1/movies/{id}` - Delete movie (admin)
  - `POST /api/v1/movies/{id}/enrich` - Trigger metadata enrichment
  - `POST /api/v1/movies/{id}/watch` - Mark as watched
  - `GET /api/v1/movies/{id}/similar` - Get similar movies

  **Collections**:
  - `GET /api/v1/collections` - List collections
  - `GET /api/v1/collections/{id}` - Get collection details
  - `POST /api/v1/collections` - Create collection
  - `PUT /api/v1/collections/{id}` - Update collection
  - `DELETE /api/v1/collections/{id}` - Delete collection
  - `POST /api/v1/collections/{id}/movies` - Add movie to collection
  - `DELETE /api/v1/collections/{id}/movies/{movieId}` - Remove from collection

  **Watch History**:
  - `GET /api/v1/movies/watched` - Get user's watched movies
  - `GET /api/v1/movies/{id}/watch-status` - Check if watched by user
request_examples: |
  **List movies with filters**:
  ```http
  GET /api/v1/movies?genre=action&year=2024&limit=20&offset=0
  Authorization: Bearer {token}
  ```

  **Get movie details**:
  ```http
  GET /api/v1/movies/550e8400-e29b-41d4-a716-446655440000
  Authorization: Bearer {token}
  ```

  **Mark movie as watched**:
  ```http
  POST /api/v1/movies/550e8400-e29b-41d4-a716-446655440000/watch
  Authorization: Bearer {token}
  Content-Type: application/json

  {
    "watched_at": "2024-01-15T20:30:00Z"
  }
  ```
response_examples: |
  **Movie details response**:
  ```json
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "tmdb_id": 550,
    "imdb_id": "tt0137523",
    "title": "Fight Club",
    "original_title": "Fight Club",
    "year": 1999,
    "runtime": 139,
    "overview": "A ticking-time-bomb insomniac...",
    "poster_path": "/posters/fight-club.jpg",
    "backdrop_path": "/backdrops/fight-club.jpg",
    "trailer_url": "https://youtube.com/watch?v=...",
    "rating": 8.8,
    "vote_count": 26000,
    "genres": ["Drama", "Thriller"],
    "collection": {
      "id": "...",
      "name": "Must Watch"
    },
    "watched": true,
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-15T20:30:00Z"
  }
  ```
unit_tests: |
  **Repository Tests** (with testcontainers):
  - Test CRUD operations for movies
  - Test collection management
  - Test watch history tracking
  - Test search with filters
  - Test concurrent access

  **Service Tests** (with mocks):
  - Test business logic with mocked repository
  - Test metadata enrichment flow
  - Test cache hit/miss scenarios
  - Test error handling
  - Test rate limiting

  **Handler Tests** (with httptest):
  - Test HTTP request/response handling
  - Test authentication/authorization
  - Test request validation
  - Test error responses
  - Test pagination
integration_tests: |
  **Full Stack Tests**:
  - Test complete request flow (client â†’ database)
  - Test metadata enrichment with real TMDb API (rate-limited)
  - Test Radarr integration
  - Test collection operations end-to-end
  - Test watch history across users
  - Test concurrent movie additions

  **Database Tests**:
  - Test migrations (up/down)
  - Test indexes performance
  - Test foreign key constraints
  - Test transaction isolation
  - Test database triggers (if any)
test_coverage_target: |
  - **Overall**: 80% minimum
  - **Repository**: 90% (critical path)
  - **Service**: 85% (business logic)
  - **Handler**: 75% (integration layer)
  - **Metadata providers**: 70% (external dependency)
