doc_title: TV Show Module
doc_category: feature
created_date: '2026-01-31'
overall_status: ‚úÖ Complete
status_design: ‚úÖ
status_design_notes: '-'
status_sources: ‚úÖ
status_sources_notes: '-'
status_instructions: ‚úÖ
status_instructions_notes: '-'
status_code: üî¥
status_code_notes: '-'
status_linting: üî¥
status_linting_notes: '-'
status_unit_testing: üî¥
status_unit_testing_notes: '-'
status_integration_testing: üî¥
status_integration_testing_notes: '-'
technical_summary: '> TV series, seasons, and episodes management'
wiki_tagline: '> Organize TV series with seasons, episodes, and watch progress'
wiki_overview: Manage TV shows organized by series, season, and episode. Automatic metadata from Sonarr (PRIMARY source, aggregates
  from TheTVDB locally) with direct TheTVDB/TMDb API as supplementary enrichment. Adds artwork, episode descriptions, and
  air dates. Track watch progress per user - see where you left off and what episodes are unwatched. Special episode handling
  for pilots, finales, and specials. Sonarr integration provides both metadata caching and download automation.
sources:
- name: Uber fx
  url: https://pkg.go.dev/go.uber.org/fx
  note: Auto-resolved from fx
- name: go-blurhash
  url: https://pkg.go.dev/github.com/bbrks/go-blurhash
  note: Auto-resolved from go-blurhash
- name: ogen OpenAPI Generator
  url: https://pkg.go.dev/github.com/ogen-go/ogen
  note: Auto-resolved from ogen
- name: pgx PostgreSQL Driver
  url: https://pkg.go.dev/github.com/jackc/pgx/v5
  note: Auto-resolved from pgx
- name: PostgreSQL Arrays
  url: https://www.postgresql.org/docs/current/arrays.html
  note: Auto-resolved from postgresql-arrays
- name: PostgreSQL JSON Functions
  url: https://www.postgresql.org/docs/current/functions-json.html
  note: Auto-resolved from postgresql-json
- name: River Job Queue
  url: https://pkg.go.dev/github.com/riverqueue/river
  note: Auto-resolved from river
- name: Sonarr API Docs
  url: https://sonarr.tv/docs/api/
  note: Auto-resolved from sonarr-docs
- name: sqlc
  url: https://docs.sqlc.dev/en/stable/
  note: Auto-resolved from sqlc
- name: sqlc Configuration
  url: https://docs.sqlc.dev/en/stable/reference/config.html
  note: Auto-resolved from sqlc-config
- name: TheTVDB API
  url: https://thetvdb.github.io/v4-api/
  note: Auto-resolved from thetvdb
design_refs:
- title: 01_ARCHITECTURE
  path: ../../architecture/01_ARCHITECTURE.md
- title: 02_DESIGN_PRINCIPLES
  path: ../../architecture/02_DESIGN_PRINCIPLES.md
- title: 03_METADATA_SYSTEM
  path: ../../architecture/03_METADATA_SYSTEM.md
- title: SONARR (PRIMARY metadata + downloads)
  path: ../../integrations/servarr/SONARR.md
- title: THETVDB (supplementary metadata)
  path: ../../integrations/metadata/THETVDB.md
- title: TMDB (fallback metadata)
  path: ../../integrations/metadata/TMDB.md
- title: TRAKT (scrobbling + metadata enrichment)
  path: ../../integrations/scrobbling/TRAKT.md
feature_name: TV Show Module
module_name: tv_show
schema_name: public
content_types:
- TV Shows
- Seasons
- Episodes
architecture_diagram: |-
  ```mermaid
  flowchart TD
      node1["Client<br/>(Web/App)"]
      node2["API Handler<br/>(ogen)"]
      node3["Service<br/>(Logic)"]
      node4["‚ñº                      ‚ñº                 ‚ñº<br/>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ<br/>itory"]
      node5["‚ñº                ‚ñº<br/>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ<br/>arr"]
      node6["TheTVDB<br/>(external)"]
      node1 --> node2
      node2 --> node3
      node3 --> node4
      node4 --> node5
      node5 --> node6
  ```
database_schema: |
  **Schema**: `public`

  **Tables**:
  - `tv_shows`: Series-level metadata (title, network, status)
  - `tv_seasons`: Season information (number, episode count, air dates)
  - `tv_episodes`: Individual episode details
  - `tv_show_files`: Physical files associated with episodes
  - `tv_show_credits`: Cast and crew for series/episodes
  - `tv_show_genres`: Genre associations
  - `tv_episode_watched`: Per-user watch progress tracking
  - `tv_show_metadata_cache`: Cached metadata from providers

  **Key Columns** (`tv_shows`):
  - `id` (UUID): Primary key
  - `tvdb_id` (INTEGER): TheTVDB identifier
  - `tmdb_id` (INTEGER): TMDb identifier
  - `imdb_id` (TEXT): IMDb identifier
  - `title` (TEXT): Show title
  - `original_title` (TEXT): Original language title
  - `year` (INTEGER): First air year
  - `status` (TEXT): Continuing, Ended, Upcoming
  - `network` (TEXT): Original broadcaster
  - `overview` (TEXT): Show synopsis
  - `poster_path` (TEXT): Poster image
  - `backdrop_path` (TEXT): Backdrop image
  - `rating` (DECIMAL): Average rating
  - `vote_count` (INTEGER): Number of votes
  - `created_at` (TIMESTAMPTZ): Record creation
  - `updated_at` (TIMESTAMPTZ): Last update

  **Key Columns** (`tv_episodes`):
  - `id` (UUID): Primary key
  - `show_id` (UUID): FK to tv_shows
  - `season_number` (INTEGER): Season number
  - `episode_number` (INTEGER): Episode number
  - `title` (TEXT): Episode title
  - `overview` (TEXT): Episode synopsis
  - `air_date` (DATE): Original air date
  - `runtime` (INTEGER): Episode duration
  - `still_path` (TEXT): Episode thumbnail
  - `rating` (DECIMAL): Episode rating

  **Indexes**:
  - `idx_tv_shows_tvdb_id` on `tvdb_id`
  - `idx_tv_shows_imdb_id` on `imdb_id`
  - `idx_tv_episodes_show_season` on (`show_id`, `season_number`)
  - `idx_tv_episode_watched_user_episode` on (`user_id`, `episode_id`)
  - `idx_tv_shows_title_trgm` (GIN trigram) for fuzzy search
module_structure: |
  ```
  internal/content/tv_show/
  ‚îú‚îÄ‚îÄ module.go              # fx module definition
  ‚îú‚îÄ‚îÄ repository.go          # Database operations (sqlc)
  ‚îú‚îÄ‚îÄ service.go             # Business logic
  ‚îú‚îÄ‚îÄ handler.go             # HTTP handlers (ogen)
  ‚îú‚îÄ‚îÄ types.go               # Domain types
  ‚îú‚îÄ‚îÄ cache.go               # Caching layer (otter)
  ‚îî‚îÄ‚îÄ metadata/
      ‚îú‚îÄ‚îÄ provider.go        # Metadata provider interface
      ‚îú‚îÄ‚îÄ thetvdb.go         # TheTVDB integration
      ‚îú‚îÄ‚îÄ tmdb.go            # TMDb integration (fallback)
      ‚îî‚îÄ‚îÄ enricher.go        # Metadata enrichment
  ```
component_interaction: |
  1. **Request Flow**:
     - Client requests TV show/episode via HTTP
     - Handler validates request, calls service
     - Service checks cache for series/episode data
     - If cache miss, repository queries database
     - Repository uses sqlc for type-safe SQL
     - Results return through layers to client

  2. **Metadata Enrichment**:
     - Background job triggered on series addition
     - Service calls TheTVDB for series metadata
     - Provider fetches all seasons and episodes
     - Service updates database with full series data
     - Cache invalidated and warmed on next request

  3. **Watch Progress Tracking**:
     - User marks episode as watched via API
     - Service updates tv_episode_watched table
     - Service calculates series/season progress percentages
     - Frontend shows "Continue Watching" and progress bars

  4. **Episode Monitoring**:
     - Sonarr integration checks for new episodes
     - Background job syncs episode list daily
     - New episodes added to database automatically
     - Users notified of new unwatched episodes
file_structure: |
  ```
  internal/content/tv_show/
  ‚îú‚îÄ‚îÄ module.go              # fx.Module with all providers
  ‚îú‚îÄ‚îÄ repository.go          # Database layer (sqlc generated)
  ‚îú‚îÄ‚îÄ repository_test.go     # Repository tests
  ‚îú‚îÄ‚îÄ service.go             # Business logic
  ‚îú‚îÄ‚îÄ service_test.go        # Service tests (mocks)
  ‚îú‚îÄ‚îÄ handler.go             # HTTP handlers (ogen generated)
  ‚îú‚îÄ‚îÄ handler_test.go        # Handler tests (httptest)
  ‚îú‚îÄ‚îÄ types.go               # Domain types
  ‚îú‚îÄ‚îÄ cache.go               # Caching logic
  ‚îú‚îÄ‚îÄ cache_test.go          # Cache tests
  ‚îî‚îÄ‚îÄ metadata/
      ‚îú‚îÄ‚îÄ provider.go        # Interface: MetadataProvider
      ‚îú‚îÄ‚îÄ thetvdb.go         # TheTVDB implementation
      ‚îú‚îÄ‚îÄ thetvdb_test.go    # TheTVDB integration tests
      ‚îú‚îÄ‚îÄ tmdb.go            # TMDb fallback
      ‚îî‚îÄ‚îÄ enricher.go        # Enrichment orchestration

  migrations/
  ‚îî‚îÄ‚îÄ 002_tv_shows.sql       # Database schema migration

  api/
  ‚îî‚îÄ‚îÄ openapi.yaml           # OpenAPI spec (TV endpoints)
  ```
key_interfaces: |
  ```go
  // Repository defines database operations for TV shows
  type Repository interface {
      // Series CRUD
      GetShow(ctx context.Context, id uuid.UUID) (*TVShow, error)
      ListShows(ctx context.Context, filters ListFilters) ([]TVShow, error)
      CreateShow(ctx context.Context, show *TVShow) error
      UpdateShow(ctx context.Context, show *TVShow) error
      DeleteShow(ctx context.Context, id uuid.UUID) error

      // Seasons
      GetSeason(ctx context.Context, showID uuid.UUID, seasonNum int) (*Season, error)
      ListSeasons(ctx context.Context, showID uuid.UUID) ([]Season, error)

      // Episodes
      GetEpisode(ctx context.Context, id uuid.UUID) (*Episode, error)
      ListEpisodes(ctx context.Context, showID uuid.UUID, seasonNum int) ([]Episode, error)
      GetNextUnwatched(ctx context.Context, userID, showID uuid.UUID) (*Episode, error)

      // Watch tracking
      MarkEpisodeWatched(ctx context.Context, userID, episodeID uuid.UUID) error
      GetWatchProgress(ctx context.Context, userID, showID uuid.UUID) (*Progress, error)
  }

  // Service defines business logic for TV shows
  type Service interface {
      // Show operations
      GetShow(ctx context.Context, id uuid.UUID) (*TVShow, error)
      SearchShows(ctx context.Context, query string, filters SearchFilters) ([]TVShow, error)
      EnrichShow(ctx context.Context, id uuid.UUID) error

      // Episode operations
      GetEpisode(ctx context.Context, id uuid.UUID) (*Episode, error)
      GetContinueWatching(ctx context.Context, userID uuid.UUID) ([]ContinueWatching, error)

      // Watch progress
      MarkWatched(ctx context.Context, userID, episodeID uuid.UUID) error
      GetProgress(ctx context.Context, userID, showID uuid.UUID) (*Progress, error)
  }

  // MetadataProvider fetches TV show metadata from external sources
  type MetadataProvider interface {
      GetShowByTVDBID(ctx context.Context, tvdbID int) (*ShowMetadata, error)
      SearchShows(ctx context.Context, query string) ([]ShowMetadata, error)
      GetSeasons(ctx context.Context, tvdbID int) ([]SeasonMetadata, error)
      GetEpisodes(ctx context.Context, tvdbID int, season int) ([]EpisodeMetadata, error)
      GetShowImages(ctx context.Context, tvdbID int) (*Images, error)
  }
  ```
dependencies: |
  **Go Dependencies**:
  - `github.com/jackc/pgx/v5/pgxpool` - PostgreSQL connection pool
  - `github.com/google/uuid` - UUID generation
  - `github.com/maypok86/otter` - In-memory cache
  - `github.com/go-resty/resty/v2` - HTTP client for external APIs
  - `go.uber.org/fx` - Dependency injection
  - `github.com/riverqueue/river` - Background jobs
  - `golang.org/x/net/proxy` - SOCKS5 proxy support for external metadata calls

  **External APIs** (priority order):
  - **Sonarr API v3** - PRIMARY metadata source (local TheTVDB cache) + download automation
  - **TheTVDB API v4** - Supplementary metadata (via proxy/VPN when Sonarr lacks data)
  - **TMDb API v3** - Additional fallback metadata source

  **Database**:
  - PostgreSQL 18+ with trigram extension
env_vars: |
  **Environment Variables**:
  - `REVENGE_TV_CACHE_TTL` - Cache TTL duration (default: 10m)
  - `REVENGE_TV_CACHE_SIZE` - Cache size in MB (default: 150)
  - `REVENGE_METADATA_THETVDB_API_KEY` - TheTVDB API key (required)
  - `REVENGE_METADATA_TMDB_API_KEY` - TMDb API key (required)
  - `REVENGE_SONARR_URL` - Sonarr instance URL (optional)
  - `REVENGE_SONARR_API_KEY` - Sonarr API key (optional)
config_keys: |
  **config.yaml keys**:
  ```yaml
  tv:
    cache:
      ttl: 10m
      size_mb: 150

    metadata:
      priority:
        - sonarr     # PRIMARY: Local TheTVDB cache
        - thetvdb    # Supplementary: Direct API (via proxy/VPN)
        - tmdb       # Fallback
      thetvdb:
        api_key: ${REVENGE_METADATA_THETVDB_API_KEY}
        proxy: tor   # Route through proxy/VPN (see HTTP_CLIENT service)
      tmdb:
        api_key: ${REVENGE_METADATA_TMDB_API_KEY}
        proxy: tor

    arr:
      sonarr:
        enabled: true       # Should be enabled for PRIMARY metadata
        url: ${REVENGE_SONARR_URL}
        api_key: ${REVENGE_SONARR_API_KEY}
        sync_interval: 30m
  ```
defaults: |
  - Cache TTL: 10 minutes (longer than movies due to episode data)
  - Cache size: 150 MB (more data than movies)
  - Metadata priority: Sonarr (PRIMARY) ‚Üí TheTVDB (via proxy) ‚Üí TMDb
  - Sonarr sync: Enabled by default (required for PRIMARY metadata)
  - TheTVDB/TMDb proxy: Uses tor proxy from HTTP_CLIENT service
endpoints: |
  **Shows**:
  - `GET /api/v1/tv/shows` - List TV shows with filters
  - `GET /api/v1/tv/shows/{id}` - Get show details with all seasons
  - `POST /api/v1/tv/shows` - Create show (admin)
  - `PUT /api/v1/tv/shows/{id}` - Update show (admin)
  - `DELETE /api/v1/tv/shows/{id}` - Delete show (admin)
  - `POST /api/v1/tv/shows/{id}/enrich` - Trigger metadata enrichment

  **Seasons**:
  - `GET /api/v1/tv/shows/{id}/seasons` - List all seasons
  - `GET /api/v1/tv/shows/{id}/seasons/{num}` - Get season details

  **Episodes**:
  - `GET /api/v1/tv/shows/{id}/seasons/{num}/episodes` - List episodes
  - `GET /api/v1/tv/episodes/{id}` - Get episode details
  - `POST /api/v1/tv/episodes/{id}/watch` - Mark as watched
  - `GET /api/v1/tv/episodes/next-unwatched/{showId}` - Get next unwatched

  **Watch Progress**:
  - `GET /api/v1/tv/continue-watching` - Get user's continue watching list
  - `GET /api/v1/tv/shows/{id}/progress` - Get show watch progress
request_examples: |
  **List TV shows**:
  ```http
  GET /api/v1/tv/shows?genre=drama&status=continuing&limit=20
  Authorization: Bearer {token}
  ```

  **Get show with seasons**:
  ```http
  GET /api/v1/tv/shows/550e8400-e29b-41d4-a716-446655440000
  Authorization: Bearer {token}
  ```

  **Mark episode watched**:
  ```http
  POST /api/v1/tv/episodes/660e8400-e29b-41d4-a716-446655440000/watch
  Authorization: Bearer {token}
  Content-Type: application/json

  {
    "watched_at": "2024-01-15T20:30:00Z"
  }
  ```
response_examples: |
  **Show details response**:
  ```json
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "tvdb_id": 121361,
    "imdb_id": "tt0903747",
    "title": "Breaking Bad",
    "year": 2008,
    "status": "Ended",
    "network": "AMC",
    "overview": "A high school chemistry teacher...",
    "poster_path": "/posters/breaking-bad.jpg",
    "rating": 9.5,
    "seasons": [
      {
        "season_number": 1,
        "episode_count": 7,
        "air_date": "2008-01-20",
        "watched_episodes": 7,
        "progress": 100.0
      }
    ],
    "overall_progress": 87.5,
    "next_unwatched": {
      "season": 5,
      "episode": 10,
      "title": "Buried"
    },
    "created_at": "2024-01-01T00:00:00Z"
  }
  ```
unit_tests: |
  **Repository Tests** (with testcontainers):
  - Test CRUD for shows, seasons, episodes
  - Test watch progress tracking
  - Test next unwatched episode query
  - Test season progress calculation
  - Test concurrent episode marking

  **Service Tests** (with mocks):
  - Test show enrichment with all seasons
  - Test episode watch progress updates
  - Test continue watching list generation
  - Test cache invalidation on updates
  - Test metadata provider fallback (TheTVDB ‚Üí TMDb)

  **Handler Tests** (with httptest):
  - Test show listing with filters
  - Test episode marking with auth
  - Test progress calculations
  - Test next unwatched endpoint
integration_tests: |
  **Full Stack Tests**:
  - Test complete show addition flow
  - Test multi-season enrichment
  - Test watch progress across users
  - Test Sonarr integration sync
  - Test continue watching updates

  **Database Tests**:
  - Test migrations (3 tables)
  - Test foreign key cascades
  - Test season/episode ordering
  - Test progress calculation queries
test_coverage_target: |
  - **Overall**: 80% minimum
  - **Repository**: 90% (complex queries)
  - **Service**: 85% (business logic)
  - **Handler**: 75% (API layer)
  - **Metadata providers**: 70% (external)
