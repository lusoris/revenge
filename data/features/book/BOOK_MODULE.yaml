doc_title: Book Module
doc_category: feature
created_date: '2026-01-31'
overall_status: âœ… Complete
status_design: âœ…
status_design_notes: Complete book module design
status_sources: âœ…
status_sources_notes: All book APIs documented
status_instructions: âœ…
status_instructions_notes: Generated from design
status_code: ðŸ”´
status_code_notes: '-'
status_linting: ðŸ”´
status_linting_notes: '-'
status_unit_testing: ðŸ”´
status_unit_testing_notes: '-'
status_integration_testing: ðŸ”´
status_integration_testing_notes: '-'
technical_summary: |-
  > Book/eBook content management with metadata enrichment from Chaptarr and external providers

  Complete eBook library:
  - **Metadata Sources**: Chaptarr (PRIMARY - aggregates OpenLibrary/Goodreads), with direct APIs as supplementary
  - **Supported Formats**: EPUB, PDF, MOBI, AZW3, CBZ (comics)
  - **Reading Features**: Web reader, progress tracking, bookmarks, highlights
  - **Collections**: Reading lists, series tracking, genre collections
  - **Sync**: Multi-device reading progress synchronization
wiki_tagline: '> Your digital library with reading progress and recommendations'
wiki_overview: The Book Module provides a comprehensive eBook library with support for multiple formats including EPUB, PDF,
  and MOBI. Uses Chaptarr as the PRIMARY metadata source (aggregates from OpenLibrary/Goodreads locally), with direct APIs
  as supplementary enrichment. Chaptarr integration provides both metadata caching and download automation. Track your reading
  progress across devices, create custom reading lists, and discover new books. The built-in web reader lets you read anywhere
  without additional software.
sources:
- name: Uber fx
  url: https://pkg.go.dev/go.uber.org/fx
  note: Auto-resolved from fx
- name: Google Books API
  url: https://developers.google.com/books/docs/v1/using
  note: Auto-resolved from google-books
- name: ogen OpenAPI Generator
  url: https://pkg.go.dev/github.com/ogen-go/ogen
  note: Auto-resolved from ogen
- name: Open Library API
  url: https://openlibrary.org/developers/api
  note: Auto-resolved from openlibrary
- name: pgx PostgreSQL Driver
  url: https://pkg.go.dev/github.com/jackc/pgx/v5
  note: Auto-resolved from pgx
- name: PostgreSQL Arrays
  url: https://www.postgresql.org/docs/current/arrays.html
  note: Auto-resolved from postgresql-arrays
- name: PostgreSQL JSON Functions
  url: https://www.postgresql.org/docs/current/functions-json.html
  note: Auto-resolved from postgresql-json
- name: River Job Queue
  url: https://pkg.go.dev/github.com/riverqueue/river
  note: Auto-resolved from river
- name: sqlc
  url: https://docs.sqlc.dev/en/stable/
  note: Auto-resolved from sqlc
- name: sqlc Configuration
  url: https://docs.sqlc.dev/en/stable/reference/config.html
  note: Auto-resolved from sqlc-config
design_refs:
- title: 01_ARCHITECTURE
  path: ../../architecture/01_ARCHITECTURE.md
- title: 02_DESIGN_PRINCIPLES
  path: ../../architecture/02_DESIGN_PRINCIPLES.md
- title: 03_METADATA_SYSTEM
  path: ../../architecture/03_METADATA_SYSTEM.md
- title: CHAPTARR (PRIMARY metadata + downloads)
  path: ../../integrations/servarr/CHAPTARR.md
- title: OPENLIBRARY (supplementary metadata)
  path: ../../integrations/metadata/OPENLIBRARY.md
- title: GOOGLE_BOOKS (supplemental metadata)
  path: ../../integrations/metadata/GOOGLE_BOOKS.md
- title: GOODREADS (ratings + reviews)
  path: ../../integrations/metadata/GOODREADS.md
feature_name: Book Module
module_name: book
schema_name: public
content_types:
- Books
- Authors
- Series
supported_formats:
- format: EPUB
  description: Electronic Publication (industry standard)
  reader: Built-in web reader with Epub.js
  features: Reflowable text, font customization, night mode
  preferred: true
- format: PDF
  description: Portable Document Format
  reader: PDF.js web reader
  features: Page navigation, zoom, search
  notes: Fixed layout, not reflowable
- format: MOBI
  description: Mobipocket eBook format (Amazon Kindle)
  reader: Convert to EPUB or serve as-is
  features: Basic reading, limited styling
- format: AZW3
  description: Amazon Kindle Format 8
  reader: Convert to EPUB for web reading
  features: Enhanced formatting vs MOBI
- format: CBZ
  description: Comic Book Archive (ZIP)
  reader: Image-based comic reader
  features: Page-by-page image viewing
  notes: See COMICS_MODULE for full comic support
metadata_sources:
- name: OpenLibrary
  purpose: Primary metadata source
  priority: 1
  fields: Title, author, ISBN, subjects, publication date, cover, description
  api_url: https://openlibrary.org/api/
- name: Google Books
  purpose: Supplemental metadata and previews
  priority: 2
  fields: Book details, preview pages, related books
  api_url: https://www.googleapis.com/books/v1/
- name: Goodreads
  purpose: Ratings, reviews, recommendations
  priority: 3
  fields: Average rating, ratings count, reviews, similar books
  api_url: https://www.goodreads.com/api/
- name: Hardcover
  purpose: Alternative metadata source
  priority: 4
  fields: Book details, community features
  api_url: https://hardcover.app/api/
database_schema: |
  **Schema**: `public`

  **Tables**:
  - `books`: Book metadata
  - `book_files`: Physical eBook files
  - `authors`: Book authors/writers
  - `book_authors`: Book-author associations (many-to-many)
  - `book_series`: Book series
  - `book_series_members`: Books in series with position
  - `book_subjects`: Genre/subject tags
  - `book_identifiers`: ISBN, ASIN, and other identifiers
  - `reading_progress`: Per-user reading progress
  - `bookmarks`: User bookmarks with notes
  - `highlights`: Text highlights with notes
  - `reading_lists`: User-created reading lists
  - `reading_list_items`: Books in reading lists
  - `book_metadata_cache`: Cached metadata from providers

  **Key Columns** (`books`):
  - `id` (UUID): Primary key
  - `title` (TEXT): Book title
  - `subtitle` (TEXT): Book subtitle
  - `description` (TEXT): Book description/synopsis
  - `publisher` (TEXT): Publisher name
  - `publish_date` (DATE): Publication date
  - `language` (TEXT): Language code (ISO 639-1)
  - `page_count` (INTEGER): Number of pages
  - `cover_path` (TEXT): Cover image path
  - `series_id` (UUID): Series foreign key (nullable)
  - `series_position` (DECIMAL): Position in series (e.g., 1.5 for 1.5)
  - `openlibrary_id` (TEXT): OpenLibrary identifier
  - `goodreads_id` (TEXT): Goodreads identifier
  - `google_books_id` (TEXT): Google Books identifier
  - `rating` (DECIMAL): Average rating (0-5)
  - `ratings_count` (INTEGER): Number of ratings
  - `created_at` (TIMESTAMPTZ): Record creation time
  - `updated_at` (TIMESTAMPTZ): Last update time

  **Key Columns** (`authors`):
  - `id` (UUID): Primary key
  - `name` (TEXT): Author name
  - `sort_name` (TEXT): Name for alphabetical sorting
  - `biography` (TEXT): Author biography
  - `birth_date` (DATE): Date of birth
  - `death_date` (DATE): Date of death (nullable)
  - `photo_path` (TEXT): Author photo path
  - `openlibrary_id` (TEXT): OpenLibrary author ID
  - `goodreads_id` (TEXT): Goodreads author ID
  - `created_at` (TIMESTAMPTZ): Record creation time
  - `updated_at` (TIMESTAMPTZ): Last update time

  **Key Columns** (`book_files`):
  - `id` (UUID): Primary key
  - `book_id` (UUID): Book foreign key
  - `file_path` (TEXT): Absolute file path
  - `file_size` (BIGINT): Size in bytes
  - `format` (TEXT): File format (EPUB, PDF, MOBI, etc.)
  - `checksum` (TEXT): File checksum (SHA256)
  - `created_at` (TIMESTAMPTZ): Record creation time

  **Key Columns** (`reading_progress`):
  - `id` (UUID): Primary key
  - `user_id` (UUID): User foreign key
  - `book_id` (UUID): Book foreign key
  - `progress_percent` (DECIMAL): Completion percentage (0-100)
  - `current_page` (INTEGER): Current page number
  - `current_cfi` (TEXT): EPUB CFI location (for EPUB files)
  - `last_read_at` (TIMESTAMPTZ): Last reading timestamp
  - `created_at` (TIMESTAMPTZ): Record creation time
  - `updated_at` (TIMESTAMPTZ): Last update time

  **Key Columns** (`highlights`):
  - `id` (UUID): Primary key
  - `user_id` (UUID): User foreign key
  - `book_id` (UUID): Book foreign key
  - `text` (TEXT): Highlighted text
  - `cfi_range` (TEXT): EPUB CFI range (start-end)
  - `page_number` (INTEGER): Page number (for PDF)
  - `color` (TEXT): Highlight color
  - `note` (TEXT): Optional user note
  - `created_at` (TIMESTAMPTZ): Record creation time

  **Indexes**:
  - `idx_books_openlibrary_id` on `openlibrary_id`
  - `idx_books_goodreads_id` on `goodreads_id`
  - `idx_books_google_books_id` on `google_books_id`
  - `idx_books_series_id` on `series_id`
  - `idx_books_title_trgm` (GIN trigram) for fuzzy search
  - `idx_authors_name_trgm` (GIN trigram) for fuzzy search
  - `idx_book_authors_book_id` on `book_id`
  - `idx_book_authors_author_id` on `author_id`
  - `idx_reading_progress_user_book` on (`user_id`, `book_id`)
  - `idx_highlights_user_book` on (`user_id`, `book_id`)
  - `idx_bookmarks_user_book` on (`user_id`, `book_id`)
reading_features:
  web_reader:
    epub_library: Epub.js
    pdf_library: PDF.js
    features:
    - Font size customization
    - Font family selection
    - Line height adjustment
    - Margin customization
    - Night mode / Dark theme
    - Sepia mode
    - Column layout (1 or 2 columns)
    - Full-screen mode
  navigation:
  - Table of contents
  - Page navigation
  - Search within book
  - Jump to page/location
  - Previous/next chapter
  reading_progress:
    tracking: Automatic page/location tracking
    sync: Real-time across devices
    granularity: Per-page or CFI (Canonical Fragment Identifier) for EPUB
  bookmarks:
    creation: Click to bookmark current location
    notes: Optional note per bookmark
    management: View all bookmarks for a book
  highlights:
    selection: Select text to highlight
    colors: Yellow, green, blue, pink, purple
    notes: Optional note per highlight
    export: Export highlights to Markdown/JSON
collection_features:
  reading_lists:
    types:
    - Want to Read
    - Currently Reading
    - Completed
    - Favorites
    - Custom lists
    sharing: Public or private lists
  series_tracking:
    auto_detection: Group books by series from metadata
    progress: Track series completion percentage
    next_book: Suggest next book in series
  genre_collections:
    auto_tagging: From metadata subjects
    browsing: Browse by genre/subject
    filters: Filter by publication date, rating, etc.
recommendations:
  similar_books: Based on metadata (genre, author, series)
  collaborative_filtering: You might also like (if enough users)
  trending: Popular books across all users
  new_releases: Recently added books
api_endpoints:
- method: GET
  path: /api/v1/books
  description: List all books with pagination and filters
- method: GET
  path: /api/v1/books/:id
  description: Get book details by ID
- method: GET
  path: /api/v1/books/:id/read
  description: Get book content for web reader
- method: GET
  path: /api/v1/books/:id/download
  description: Download book file in original format
- method: GET
  path: /api/v1/books/:id/progress
  description: Get user reading progress for a book
- method: PUT
  path: /api/v1/books/:id/progress
  description: Update user reading progress
- method: POST
  path: /api/v1/books/:id/bookmarks
  description: Create a bookmark at current position
- method: GET
  path: /api/v1/books/:id/bookmarks
  description: Get all user bookmarks for a book
- method: POST
  path: /api/v1/books/:id/highlights
  description: Create a text highlight with optional note
- method: GET
  path: /api/v1/books/:id/highlights
  description: Get all user highlights for a book
- method: GET
  path: /api/v1/books/authors
  description: List all book authors
- method: GET
  path: /api/v1/books/series
  description: List all book series
- method: GET
  path: /api/v1/books/collections
  description: List all book collections
architecture_diagram: |-
  ```mermaid
  flowchart TD
      node1([Client<br/>[Web/App]])
      node2[[API Handler<br/>[ogen]]]
      node3[[Service<br/>[Logic]]]
      node4["Repository<br/>[sqlc]"]
      node5[[Metadata<br/>Service]]
      node6[(Cache<br/>[otter])]
      node7[(PostgreSQL<br/>[pgx])]
      node8([External<br/>APIs])
      node1 --> node2
      node2 --> node3
      node4 --> node5
      node5 --> node6
      node7 --> node8
      node3 --> node4
      node6 --> node7
  ```
module_structure: |-
  ```
    internal/content/book/
    â”œâ”€â”€ module.go              # fx module definition
    â”œâ”€â”€ repository.go          # Database operations (sqlc)
    â”œâ”€â”€ service.go             # Business logic
    â”œâ”€â”€ handler.go             # HTTP handlers (ogen)
    â”œâ”€â”€ types.go               # Domain types
    â””â”€â”€ cache.go               # Caching layer (otter)
    ```
component_interaction: |
  1. **Request Flow**:
     - Client sends HTTP request to `/api/v1/books/*`
     - API handler (ogen) validates request and calls service
     - Service checks cache for existing data
     - If cache miss, service calls repository for database query
     - Repository executes SQL via sqlc-generated code
     - Results flow back through service â†’ handler â†’ client

  2. **Metadata Enrichment**:
     - New book scan triggers metadata enrichment job
     - Service extracts ISBN from book file metadata
     - Service queries OpenLibrary API with ISBN
     - If no results, fallback to Google Books, then Goodreads
     - Service stores book, author, and series data
     - Service downloads cover image
     - Cache is populated with enriched metadata

  3. **Web Reader Flow**:
     - Client requests book content via `/api/v1/books/{id}/read`
     - Service checks user permissions and file format
     - For EPUB: Service extracts and serves book content via Epub.js-compatible API
     - For PDF: Service serves PDF for PDF.js rendering
     - Client renders book in web reader
     - Progress updates sent periodically via WebSocket

  4. **Reading Progress Sync**:
     - Client sends progress updates via WebSocket or REST API
     - Service updates reading_progress table
     - Progress synced to all user's devices in real-time
     - Last read position restored when opening book
file_structure: |
  ```
  internal/content/book/
  â”œâ”€â”€ module.go              # fx.Module with all providers
  â”œâ”€â”€ repository.go          # Database layer
  â”œâ”€â”€ repository_test.go     # Repository tests (testcontainers)
  â”œâ”€â”€ service.go             # Business logic
  â”œâ”€â”€ service_test.go        # Service tests (mocks)
  â”œâ”€â”€ handler.go             # HTTP handlers
  â”œâ”€â”€ handler_test.go        # Handler tests (httptest)
  â”œâ”€â”€ types.go               # Domain types
  â”œâ”€â”€ cache.go               # Caching logic
  â”œâ”€â”€ cache_test.go          # Cache tests
  â”œâ”€â”€ reader/
  â”‚   â”œâ”€â”€ epub.go            # EPUB processing and serving
  â”‚   â”œâ”€â”€ epub_test.go       # EPUB tests
  â”‚   â”œâ”€â”€ pdf.go             # PDF processing and serving
  â”‚   â””â”€â”€ pdf_test.go        # PDF tests
  â”œâ”€â”€ metadata/
  â”‚   â”œâ”€â”€ provider.go        # Interface: MetadataProvider
  â”‚   â”œâ”€â”€ openlibrary.go     # OpenLibrary API integration
  â”‚   â”œâ”€â”€ googlebooks.go     # Google Books API integration
  â”‚   â”œâ”€â”€ goodreads.go       # Goodreads API integration
  â”‚   â”œâ”€â”€ hardcover.go       # Hardcover API integration
  â”‚   â””â”€â”€ enricher.go        # Enrichment orchestration
  â””â”€â”€ progress/
      â”œâ”€â”€ tracker.go         # Reading progress tracking
      â”œâ”€â”€ sync.go            # Multi-device sync logic
      â””â”€â”€ tracker_test.go    # Progress tracking tests

  migrations/
  â””â”€â”€ books/
      â”œâ”€â”€ 001_books.sql      # Books and authors schema
      â”œâ”€â”€ 002_progress.sql   # Reading progress schema
      â”œâ”€â”€ 003_highlights.sql # Highlights and bookmarks schema
      â””â”€â”€ 004_lists.sql      # Reading lists schema

  api/
  â””â”€â”€ openapi.yaml           # OpenAPI spec (books/* endpoints)
  ```
key_interfaces: |
  ```go
  // Repository defines database operations for books
  type Repository interface {
      // Book CRUD
      GetBook(ctx context.Context, id uuid.UUID) (*Book, error)
      ListBooks(ctx context.Context, filters ListFilters) ([]Book, error)
      CreateBook(ctx context.Context, book *Book) error
      UpdateBook(ctx context.Context, book *Book) error
      DeleteBook(ctx context.Context, id uuid.UUID) error

      // Author CRUD
      GetAuthor(ctx context.Context, id uuid.UUID) (*Author, error)
      ListAuthors(ctx context.Context, filters ListFilters) ([]Author, error)
      ListBooksByAuthor(ctx context.Context, authorID uuid.UUID) ([]Book, error)

      // Series CRUD
      GetSeries(ctx context.Context, id uuid.UUID) (*Series, error)
      ListSeries(ctx context.Context) ([]Series, error)
      ListBooksBySeries(ctx context.Context, seriesID uuid.UUID) ([]Book, error)

      // Reading Progress
      GetProgress(ctx context.Context, userID, bookID uuid.UUID) (*ReadingProgress, error)
      UpdateProgress(ctx context.Context, progress *ReadingProgress) error
      GetRecentlyRead(ctx context.Context, userID uuid.UUID, limit int) ([]Book, error)

      // Highlights and Bookmarks
      CreateHighlight(ctx context.Context, highlight *Highlight) error
      ListHighlights(ctx context.Context, userID, bookID uuid.UUID) ([]Highlight, error)
      CreateBookmark(ctx context.Context, bookmark *Bookmark) error
      ListBookmarks(ctx context.Context, userID, bookID uuid.UUID) ([]Bookmark, error)

      // Reading Lists
      CreateReadingList(ctx context.Context, list *ReadingList) error
      AddBookToList(ctx context.Context, listID, bookID uuid.UUID) error
      RemoveBookFromList(ctx context.Context, listID, bookID uuid.UUID) error
  }

  // Service defines business logic for books
  type Service interface {
      // Book operations
      GetBook(ctx context.Context, id uuid.UUID) (*Book, error)
      SearchBooks(ctx context.Context, query string, filters SearchFilters) ([]Book, error)
      EnrichBook(ctx context.Context, id uuid.UUID) error

      // Reading operations
      GetBookContent(ctx context.Context, bookID uuid.UUID, format string) (io.ReadCloser, error)
      UpdateReadingProgress(ctx context.Context, userID, bookID uuid.UUID, progress ProgressUpdate) error

      // Highlights and bookmarks
      CreateHighlight(ctx context.Context, userID, bookID uuid.UUID, highlight HighlightCreate) error
      ExportHighlights(ctx context.Context, userID, bookID uuid.UUID, format string) (string, error)
  }

  // MetadataProvider fetches book metadata from external sources
  type MetadataProvider interface {
      GetBookByISBN(ctx context.Context, isbn string) (*BookMetadata, error)
      GetBookByID(ctx context.Context, providerID string) (*BookMetadata, error)
      GetAuthorByID(ctx context.Context, providerID string) (*AuthorMetadata, error)
      SearchBooks(ctx context.Context, query string) ([]BookMetadata, error)
      SearchAuthors(ctx context.Context, query string) ([]AuthorMetadata, error)
  }

  // BookReader processes and serves eBook content
  type BookReader interface {
      // GetContent returns book content for web reader
      GetContent(ctx context.Context, filePath string) (*BookContent, error)

      // GetCoverImage extracts cover image from book file
      GetCoverImage(ctx context.Context, filePath string) (image.Image, error)

      // SupportedFormats returns formats this reader can handle
      SupportedFormats() []string

      // GetTableOfContents extracts TOC from book
      GetTableOfContents(ctx context.Context, filePath string) ([]TOCItem, error)
  }

  // ProgressTracker manages reading progress synchronization
  type ProgressTracker interface {
      // UpdateProgress updates user's reading position
      UpdateProgress(ctx context.Context, update ProgressUpdate) error

      // GetProgress retrieves current reading position
      GetProgress(ctx context.Context, userID, bookID uuid.UUID) (*ReadingProgress, error)

      // SyncProgress synchronizes progress across devices
      SyncProgress(ctx context.Context, userID uuid.UUID) error
  }
  ```
dependencies: |
  **Go Dependencies**:
  - `github.com/jackc/pgx/v5/pgxpool` - PostgreSQL connection pool
  - `github.com/google/uuid` - UUID generation
  - `github.com/maypok86/otter` - In-memory cache
  - `github.com/go-resty/resty/v2` - HTTP client for external APIs
  - `github.com/bmaupin/go-epub` - EPUB parsing and manipulation
  - `github.com/pdfcpu/pdfcpu` - PDF processing
  - `go.uber.org/fx` - Dependency injection
  - `github.com/riverqueue/river` - Background job queue
  - `golang.org/x/net/proxy` - SOCKS5 proxy support for external metadata calls

  **External APIs** (priority order):
  - **Chaptarr API** - PRIMARY metadata source (local OpenLibrary/Goodreads cache) + download automation
  - **OpenLibrary API** - Supplementary metadata (via proxy/VPN when Chaptarr lacks data)
  - **Google Books API v1** - Supplemental metadata (via proxy/VPN)
  - **Goodreads API** - Ratings and reviews (via proxy/VPN)
  - **Hardcover API** - Alternative metadata source (via proxy/VPN)

  **Frontend Libraries** (for web reader):
  - Epub.js - EPUB rendering in browser
  - PDF.js - PDF rendering in browser

  **Database**:
  - PostgreSQL 18+ with trigram extension for fuzzy search
env_vars: |
  **Environment Variables**:
  - `REVENGE_BOOK_CACHE_TTL` - Cache TTL duration (default: 30m)
  - `REVENGE_BOOK_CACHE_SIZE` - Cache size in MB (default: 100)
  - `REVENGE_METADATA_OPENLIBRARY_RATE_LIMIT` - Rate limit per second (default: 5)
  - `REVENGE_METADATA_GOOGLE_BOOKS_API_KEY` - Google Books API key (optional)
  - `REVENGE_METADATA_GOODREADS_API_KEY` - Goodreads API key (optional)
  - `REVENGE_METADATA_HARDCOVER_API_KEY` - Hardcover API key (optional)
  - `REVENGE_BOOK_READER_MAX_FILE_SIZE` - Max file size for web reader in MB (default: 100)
  - `REVENGE_BOOK_PROGRESS_SYNC_INTERVAL` - Progress sync interval in seconds (default: 30)
  - `REVENGE_BOOK_COVER_CACHE_PATH` - Path for cached cover images
config_keys: |
  **config.yaml keys**:
  ```yaml
  book:
    cache:
      ttl: 30m
      size_mb: 100

    metadata:
      priority:
        - chaptarr       # PRIMARY: Local OpenLibrary/Goodreads cache
        - openlibrary    # Supplementary: Direct API (via proxy/VPN)
        - google_books   # Supplemental (via proxy/VPN)
        - goodreads      # Ratings/reviews (via proxy/VPN)
        - hardcover      # Alternative (via proxy/VPN)

      chaptarr:
        url: ${REVENGE_CHAPTARR_URL}
        api_key: ${REVENGE_CHAPTARR_API_KEY}
        enabled: true       # Should be enabled for PRIMARY metadata
        sync_interval: 30m

      openlibrary:
        rate_limit: 5  # Requests per second
        timeout: 10s
        proxy: tor  # Route through proxy/VPN (see HTTP_CLIENT service)

      google_books:
        api_key: ${REVENGE_METADATA_GOOGLE_BOOKS_API_KEY}
        enabled: false
        proxy: tor

      goodreads:
        api_key: ${REVENGE_METADATA_GOODREADS_API_KEY}
        enabled: false
        proxy: tor

      hardcover:
        api_key: ${REVENGE_METADATA_HARDCOVER_API_KEY}
        enabled: false
        proxy: tor

    reader:
      max_file_size_mb: 100
      supported_formats:
        - epub
        - pdf
        - mobi
        - azw3
        - cbz
      epub:
        extract_images: true
        cache_extracted: true
      pdf:
        render_quality: high
        max_pages_cached: 50

    progress:
      sync_interval: 30s
      autosave_interval: 10s
      track_reading_time: true

    features:
      highlights_enabled: true
      bookmarks_enabled: true
      reading_lists_enabled: true
      recommendations_enabled: true
      export_highlights: true
  ```
defaults: |
  - Cache TTL: 30 minutes
  - Cache size: 100 MB
  - OpenLibrary rate limit: 5 requests/second
  - Max file size for web reader: 100 MB
  - Progress sync interval: 30 seconds
  - Progress autosave interval: 10 seconds
  - Metadata priority: OpenLibrary â†’ Google Books â†’ Goodreads â†’ Hardcover
  - PDF render quality: high
  - Highlights/bookmarks/reading lists: all enabled
request_examples: |
  **List books with filters**:
  ```http
  GET /api/v1/books?author=author-uuid&series=series-uuid&limit=20&offset=0
  Authorization: Bearer {token}
  ```

  **Get book with full details**:
  ```http
  GET /api/v1/books/550e8400-e29b-41d4-a716-446655440000?include=authors,series
  Authorization: Bearer {token}
  ```

  **Get book content for web reader**:
  ```http
  GET /api/v1/books/550e8400-e29b-41d4-a716-446655440000/read
  Authorization: Bearer {token}
  ```

  **Update reading progress**:
  ```http
  PUT /api/v1/books/550e8400-e29b-41d4-a716-446655440000/progress
  Authorization: Bearer {token}
  Content-Type: application/json

  {
    "progress_percent": 45.5,
    "current_page": 123,
    "current_cfi": "epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:3)"
  }
  ```

  **Create highlight**:
  ```http
  POST /api/v1/books/550e8400-e29b-41d4-a716-446655440000/highlights
  Authorization: Bearer {token}
  Content-Type: application/json

  {
    "text": "To be or not to be, that is the question",
    "cfi_range": "epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:3,/2/1:43)",
    "color": "yellow",
    "note": "Famous quote from Hamlet"
  }
  ```
response_examples: |
  **Book details response**:
  ```json
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "title": "The Great Gatsby",
    "subtitle": null,
    "description": "A classic American novel...",
    "publisher": "Scribner",
    "publish_date": "1925-04-10",
    "language": "en",
    "page_count": 180,
    "cover_path": "/books/covers/great-gatsby.jpg",
    "authors": [
      {
        "id": "...",
        "name": "F. Scott Fitzgerald",
        "photo_path": "/authors/photos/fitzgerald.jpg"
      }
    ],
    "series": null,
    "identifiers": {
      "isbn_10": "0743273567",
      "isbn_13": "9780743273565",
      "openlibrary": "OL24364699M"
    },
    "subjects": ["Fiction", "Classic Literature", "American Literature"],
    "rating": 4.2,
    "ratings_count": 42500,
    "formats_available": ["EPUB", "PDF", "MOBI"],
    "user_progress": {
      "progress_percent": 45.5,
      "last_read_at": "2024-01-15T20:30:00Z"
    },
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-15T20:30:00Z"
  }
  ```

  **Reading progress response**:
  ```json
  {
    "book_id": "550e8400-e29b-41d4-a716-446655440000",
    "progress_percent": 45.5,
    "current_page": 123,
    "current_cfi": "epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:3)",
    "total_reading_time_seconds": 7200,
    "last_read_at": "2024-01-15T20:30:00Z",
    "started_at": "2024-01-10T18:00:00Z"
  }
  ```

  **Highlights list response**:
  ```json
  {
    "highlights": [
      {
        "id": "...",
        "text": "To be or not to be, that is the question",
        "cfi_range": "epubcfi(...)",
        "color": "yellow",
        "note": "Famous quote from Hamlet",
        "created_at": "2024-01-15T20:30:00Z"
      }
    ],
    "total": 12
  }
  ```
unit_tests: |
  **Repository Tests** (with testcontainers):
  - Test CRUD operations for books
  - Test CRUD operations for authors
  - Test series management
  - Test reading progress tracking
  - Test highlights and bookmarks
  - Test reading lists
  - Test search with filters
  - Test concurrent access

  **Service Tests** (with mocks):
  - Test business logic with mocked repository
  - Test metadata enrichment flow (OpenLibrary â†’ fallbacks)
  - Test cache hit/miss scenarios
  - Test error handling
  - Test rate limiting for metadata APIs

  **Handler Tests** (with httptest):
  - Test HTTP request/response handling
  - Test authentication/authorization
  - Test request validation
  - Test error responses
  - Test pagination

  **Reader Tests**:
  - Test EPUB extraction and serving
  - Test PDF processing
  - Test TOC extraction
  - Test cover image extraction
  - Test format detection

  **Progress Tracking Tests**:
  - Test progress update logic
  - Test multi-device sync
  - Test concurrent progress updates
  - Test progress restoration
integration_tests: |
  **Full Stack Tests**:
  - Test complete request flow (client â†’ database)
  - Test metadata enrichment with real APIs (rate-limited)
  - Test book content serving end-to-end
  - Test progress sync across simulated devices
  - Test highlight creation and export
  - Test reading list operations

  **Database Tests**:
  - Test migrations (up/down)
  - Test indexes performance
  - Test foreign key constraints
  - Test transaction isolation
  - Test trigram search performance

  **Web Reader Tests**:
  - Test EPUB rendering (integration with Epub.js)
  - Test PDF rendering (integration with PDF.js)
  - Test progress tracking during reading
  - Test highlight creation UX
  - Test bookmark functionality
test_coverage_target: |
  - **Overall**: 80% minimum
  - **Repository**: 90% (critical path)
  - **Service**: 85% (business logic)
  - **Handler**: 75% (integration layer)
  - **Metadata providers**: 70% (external dependency)
  - **Reader components**: 80% (format processing)
  - **Progress tracking**: 90% (critical for user experience)
