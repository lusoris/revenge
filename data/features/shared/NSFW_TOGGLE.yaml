doc_title: Revenge - NSFW Toggle
doc_category: feature
created_date: '2026-01-31'
overall_status: âœ… Complete
status_design: âœ…
status_design_notes: '-'
status_sources: ðŸŸ¡
status_sources_notes: '-'
status_instructions: âœ…
status_instructions_notes: '-'
status_code: ðŸ”´
status_code_notes: '-'
status_linting: ðŸ”´
status_linting_notes: '-'
status_unit_testing: ðŸ”´
status_unit_testing_notes: '-'
status_integration_testing: ðŸ”´
status_integration_testing_notes: '-'
technical_summary: '> User preference component for adult content visibility. > Referenced by [WHISPARR_STASHDB_SCHEMA.md](../adult/WHISPARR_STASHDB_SCHEMA.md)
  and [ADULT_CONTENT_SYSTEM.md](../adult/ADULT_CONTENT_SYSTEM.md).'
wiki_tagline: '> Show or hide adult libraries with a simple toggle'
wiki_overview: Control adult content visibility per user. When disabled, adult libraries are completely hidden from the UI.
  Toggle requires PIN confirmation for security. Quick toggle in the header for users with permission. Server admins control
  who can enable the toggle. Works with the RBAC system to enforce content access policies.
sources:
- name: Casbin
  url: https://pkg.go.dev/github.com/casbin/casbin/v2
  note: Auto-resolved from casbin
- name: Dragonfly Documentation
  url: https://www.dragonflydb.io/docs
  note: Auto-resolved from dragonfly
- name: Uber fx
  url: https://pkg.go.dev/go.uber.org/fx
  note: Auto-resolved from fx
- name: ogen OpenAPI Generator
  url: https://pkg.go.dev/github.com/ogen-go/ogen
  note: Auto-resolved from ogen
- name: pgx PostgreSQL Driver
  url: https://pkg.go.dev/github.com/jackc/pgx/v5
  note: Auto-resolved from pgx
- name: PostgreSQL Arrays
  url: https://www.postgresql.org/docs/current/arrays.html
  note: Auto-resolved from postgresql-arrays
- name: PostgreSQL JSON Functions
  url: https://www.postgresql.org/docs/current/functions-json.html
  note: Auto-resolved from postgresql-json
- name: River Job Queue
  url: https://pkg.go.dev/github.com/riverqueue/river
  note: Auto-resolved from river
- name: rueidis
  url: https://pkg.go.dev/github.com/redis/rueidis
  note: Auto-resolved from rueidis
- name: rueidis GitHub README
  url: https://github.com/redis/rueidis
  note: Auto-resolved from rueidis-docs
- name: sqlc
  url: https://docs.sqlc.dev/en/stable/
  note: Auto-resolved from sqlc
- name: sqlc Configuration
  url: https://docs.sqlc.dev/en/stable/reference/config.html
  note: Auto-resolved from sqlc-config
- name: Svelte 5 Runes
  url: https://svelte.dev/docs/svelte/$state
  note: Auto-resolved from svelte-runes
- name: Svelte 5 Documentation
  url: https://svelte.dev/docs/svelte/overview
  note: Auto-resolved from svelte5
- name: SvelteKit Documentation
  url: https://svelte.dev/docs/kit/introduction
  note: Auto-resolved from sveltekit
design_refs:
- title: 01_ARCHITECTURE
  path: ../../architecture/01_ARCHITECTURE.md
- title: 02_DESIGN_PRINCIPLES
  path: ../../architecture/02_DESIGN_PRINCIPLES.md
- title: 03_METADATA_SYSTEM
  path: ../../architecture/03_METADATA_SYSTEM.md
feature_name: Revenge - NSFW Toggle
module_name: revenge___nsfw_toggle
schema_name: public
architecture_diagram: |-
  ```mermaid
  flowchart LR
      subgraph Layer1["Layer 1"]
          node1(["Client<br/>(Web/App)"])
          node2[["API Handler<br/>(ogen)"]]
          node3[["Service<br/>(Logic)"]]
      end

      subgraph Layer2["Layer 2"]
          node4["Repository<br/>(sqlc)"]
          node5[["Metadata<br/>Service"]]
          node6[("Cache<br/>(otter)")]
      end

      subgraph Layer3["Layer 3"]
          node7[("PostgreSQL<br/>(pgx)")]
          node8(["External<br/>APIs"])
      end

      %% Connections
      node3 --> node4
      node6 --> node7

      %% Styling
      style Layer1 fill:#1976D2,stroke:#1976D2,color:#fff
      style Layer2 fill:#388E3C,stroke:#388E3C,color:#fff
      style Layer3 fill:#7B1FA2,stroke:#7B1FA2,color:#fff
  ```
database_schema: |
  **Schema**: `public`

  ```sql
  -- User NSFW/QAR toggle preferences
  CREATE TABLE user_nsfw_preferences (
    user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

    -- Toggle state
    nsfw_enabled BOOLEAN DEFAULT false,
    requires_pin BOOLEAN DEFAULT true,             -- Require PIN to enable
    pin_hash TEXT,                                 -- Hashed PIN for verification

    -- Session timeout
    session_timeout_minutes INTEGER DEFAULT 60,    -- Auto-disable after X minutes

    updated_at TIMESTAMPTZ DEFAULT now()
  );

  -- NSFW session tracking (temporary enable)
  CREATE TABLE nsfw_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    enabled_at TIMESTAMPTZ DEFAULT now(),
    expires_at TIMESTAMPTZ NOT NULL
  );
  CREATE INDEX idx_nsfw_sessions_user ON nsfw_sessions(user_id);
  CREATE INDEX idx_nsfw_sessions_expires ON nsfw_sessions(expires_at);
  ```
module_structure: |
  ```
  internal/nsfw/
  â”œâ”€â”€ module.go                    # fx module
  â”œâ”€â”€ types.go                     # Domain types
  â”œâ”€â”€ repository.go                # Database operations (sqlc)
  â”œâ”€â”€ service.go                   # NSFW toggle logic
  â”œâ”€â”€ middleware.go                # HTTP middleware for filtering
  â”œâ”€â”€ handler.go                   # HTTP API handlers
  â””â”€â”€ nsfw_test.go
  ```
key_interfaces: |
  ```go
  type NSFWService interface {
    EnableNSFW(ctx context.Context, userID uuid.UUID, pin string) error
    DisableNSFW(ctx context.Context, userID uuid.UUID) error
    IsNSFWEnabled(ctx context.Context, userID uuid.UUID) (bool, error)
    SetPIN(ctx context.Context, userID uuid.UUID, pin string) error
    VerifyPIN(ctx context.Context, userID uuid.UUID, pin string) (bool, error)
  }
  ```
dependencies: |
  **Go Packages**:
  - `github.com/google/uuid`
  - `github.com/jackc/pgx/v5`
  - `golang.org/x/crypto/bcrypt` - PIN hashing
  - `go.uber.org/fx`
env_vars: |
  ```bash
  NSFW_DEFAULT_SESSION_TIMEOUT=60
  ```
config_keys: |
  ```yaml
  nsfw:
    default_session_timeout_minutes: 60
    require_pin_by_default: true
  ```
component_interaction: |
  **Toggle Flow**:
  1. User clicks NSFW toggle in header
  2. If requires_pin, prompt for PIN
  3. Service verifies PIN hash
  4. Create nsfw_sessions record with expiry
  5. Frontend shows QAR/adult libraries

  **Middleware Filter**:
  1. HTTP request for QAR content
  2. Middleware checks nsfw_sessions
  3. If not enabled or expired, return 403
  4. If enabled, allow access to qar.* schema
api_endpoints: |
  ```
  POST /api/v1/nsfw/enable          # Enable NSFW mode
  POST /api/v1/nsfw/disable         # Disable NSFW mode
  GET  /api/v1/nsfw/status          # Get NSFW status
  PUT  /api/v1/nsfw/pin             # Set/update PIN
  ```
unit_tests: |
  ```go
  func TestNSFWService_EnableDisable(t *testing.T) {
    // Test enable/disable flow with PIN
  }
  ```
integration_tests: |
  ```go
  func TestNSFW_EndToEnd(t *testing.T) {
    // Test full toggle workflow with session expiry
  }
  ```
