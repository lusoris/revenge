doc_title: Revenge - Client Support & Device Capabilities
doc_category: feature
created_date: '2026-01-31'
overall_status: ‚úÖ Complete
status_design: ‚úÖ
status_design_notes: '-'
status_sources: üü°
status_sources_notes: '-'
status_instructions: ‚úÖ
status_instructions_notes: '-'
status_code: üî¥
status_code_notes: '-'
status_linting: üî¥
status_linting_notes: '-'
status_unit_testing: üî¥
status_unit_testing_notes: '-'
status_integration_testing: üî¥
status_integration_testing_notes: '-'
technical_summary: '> Multi-platform client support with intelligent capability detection.'
wiki_tagline: '> Watch on any device with automatic quality adjustment'
wiki_overview: Revenge works on phones, tablets, smart TVs, web browsers, and streaming devices. The server detects each client
  type and capabilities automatically. Direct play when the device supports the format, transcode when needed. Per-device
  quality settings let you optimize for mobile data or big screen viewing. Sync downloads for offline playback on mobile devices.
sources:
- name: Casbin
  url: https://pkg.go.dev/github.com/casbin/casbin/v2
  note: Auto-resolved from casbin
- name: Uber fx
  url: https://pkg.go.dev/go.uber.org/fx
  note: Auto-resolved from fx
- name: gohlslib (HLS)
  url: https://pkg.go.dev/github.com/bluenviron/gohlslib/v2
  note: Auto-resolved from gohlslib
- name: ogen OpenAPI Generator
  url: https://pkg.go.dev/github.com/ogen-go/ogen
  note: Auto-resolved from ogen
- name: pgx PostgreSQL Driver
  url: https://pkg.go.dev/github.com/jackc/pgx/v5
  note: Auto-resolved from pgx
- name: PostgreSQL Arrays
  url: https://www.postgresql.org/docs/current/arrays.html
  note: Auto-resolved from postgresql-arrays
- name: PostgreSQL JSON Functions
  url: https://www.postgresql.org/docs/current/functions-json.html
  note: Auto-resolved from postgresql-json
- name: River Job Queue
  url: https://pkg.go.dev/github.com/riverqueue/river
  note: Auto-resolved from river
- name: Svelte 5 Runes
  url: https://svelte.dev/docs/svelte/$state
  note: Auto-resolved from svelte-runes
- name: Svelte 5 Documentation
  url: https://svelte.dev/docs/svelte/overview
  note: Auto-resolved from svelte5
- name: SvelteKit Documentation
  url: https://svelte.dev/docs/kit/introduction
  note: Auto-resolved from sveltekit
design_refs:
- title: 01_ARCHITECTURE
  path: ../../architecture/01_ARCHITECTURE.md
- title: 02_DESIGN_PRINCIPLES
  path: ../../architecture/02_DESIGN_PRINCIPLES.md
- title: 03_METADATA_SYSTEM
  path: ../../architecture/03_METADATA_SYSTEM.md
feature_name: Revenge - Client Support & Device Capabilities
module_name: revenge___client_support_&_device_capabilities
schema_name: public
architecture_diagram: |-
  ```mermaid
  flowchart TD
      node1["Client<br/>(Web/App)"]
      node2["API Handler<br/>(ogen)"]
      node3["Service<br/>(Logic)"]
      node4["‚ñº                      ‚ñº            ‚ñº<br/>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ<br/>itory"]
      node5["PostgreSQL<br/>(pgx)"]
      node6["External<br/>APIs"]
      node1 --> node2
      node2 --> node3
      node5 --> node6
      node3 --> node4
      node4 --> node5
  ```
database_schema: |
  **Schema**: `public`

  ```sql
  -- Registered client devices
  CREATE TABLE client_devices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    -- Device identification
    device_id VARCHAR(255) NOT NULL UNIQUE,        -- Client-generated unique ID
    device_name TEXT,                              -- User-friendly name
    client_name VARCHAR(100),                      -- 'Web', 'iOS', 'Android', 'Roku', etc.
    client_version VARCHAR(50),

    -- Capabilities (detected or reported)
    capabilities JSONB,                            -- {\"directPlay\": [\"h264\", \"hevc\"], \"maxResolution\": \"4K\"}

    -- Network info
    ip_address INET,
    user_agent TEXT,

    -- Status
    last_seen_at TIMESTAMPTZ DEFAULT now(),
    is_active BOOLEAN DEFAULT true,

    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
  );
  CREATE INDEX idx_client_devices_user ON client_devices(user_id);
  CREATE INDEX idx_client_devices_device_id ON client_devices(device_id);
  CREATE INDEX idx_client_devices_active ON client_devices(is_active) WHERE is_active = true;

  -- Device quality profiles
  CREATE TABLE device_quality_profiles (
    device_id UUID NOT NULL REFERENCES client_devices(id) ON DELETE CASCADE,

    -- Quality settings
    max_resolution VARCHAR(20),                    -- '4K', '1080p', '720p', '480p'
    max_bitrate_mbps INTEGER,                      -- Max bitrate in Mbps
    prefer_direct_play BOOLEAN DEFAULT true,
    allow_transcoding BOOLEAN DEFAULT true,

    -- Audio preferences
    preferred_audio_codec VARCHAR(20),             -- 'aac', 'ac3', 'eac3', 'dts'
    max_audio_channels INTEGER DEFAULT 2,          -- 2, 6 (5.1), 8 (7.1)

    -- Subtitle preferences
    burn_subtitles BOOLEAN DEFAULT false,          -- Burn subtitles into video

    updated_at TIMESTAMPTZ DEFAULT now(),
    PRIMARY KEY (device_id)
  );

  -- Device codec support (detected capabilities)
  CREATE TABLE device_codec_support (
    device_id UUID NOT NULL REFERENCES client_devices(id) ON DELETE CASCADE,

    -- Video codecs
    video_codecs TEXT[] DEFAULT '{}',              -- ['h264', 'hevc', 'vp9', 'av1']

    -- Audio codecs
    audio_codecs TEXT[] DEFAULT '{}',              -- ['aac', 'mp3', 'opus', 'flac']

    -- Container formats
    containers TEXT[] DEFAULT '{}',                -- ['mp4', 'mkv', 'webm']

    -- Subtitle formats
    subtitle_formats TEXT[] DEFAULT '{}',          -- ['srt', 'vtt', 'ass']

    -- HLS/DASH support
    supports_hls BOOLEAN DEFAULT false,
    supports_dash BOOLEAN DEFAULT false,

    updated_at TIMESTAMPTZ DEFAULT now(),
    PRIMARY KEY (device_id)
  );
  ```
module_structure: |
  ```
  internal/clients/
  ‚îú‚îÄ‚îÄ module.go                    # fx module
  ‚îú‚îÄ‚îÄ types.go                     # Domain types
  ‚îú‚îÄ‚îÄ repository.go                # Database operations (sqlc)
  ‚îú‚îÄ‚îÄ service.go                   # Client detection logic
  ‚îú‚îÄ‚îÄ capabilities.go              # Capability detection
  ‚îú‚îÄ‚îÄ profiles.go                  # Quality profile management
  ‚îú‚îÄ‚îÄ handler.go                   # HTTP API handlers
  ‚îî‚îÄ‚îÄ clients_test.go
  ```
key_interfaces: |
  ```go
  type ClientService interface {
    RegisterDevice(ctx context.Context, userID uuid.UUID, device ClientDeviceRegister) (*ClientDevice, error)
    GetDevice(ctx context.Context, deviceID string) (*ClientDevice, error)
    UpdateCapabilities(ctx context.Context, deviceID string, capabilities DeviceCapabilities) error
    GetQualityProfile(ctx context.Context, deviceID string) (*QualityProfile, error)
    UpdateQualityProfile(ctx context.Context, deviceID string, profile QualityProfile) error
    DetectCapabilities(ctx context.Context, userAgent string) (*DeviceCapabilities, error)
  }
  ```
dependencies: |
  **Go Packages**:
  - `github.com/google/uuid`
  - `github.com/jackc/pgx/v5`
  - `github.com/mssola/user_agent` - User agent parsing
  - `go.uber.org/fx`
env_vars: |
  ```bash
  CLIENTS_AUTO_DETECT_CAPABILITIES=true
  ```
config_keys: |
  ```yaml
  clients:
    auto_detect_capabilities: true
    default_max_resolution: 1080p
    default_max_bitrate_mbps: 20
  ```
component_interaction: |
  **Device Registration**:
  1. Client connects with User-Agent header
  2. Service parses UA and detects client type
  3. Create or update client_devices record
  4. Auto-detect codec capabilities based on client type
  5. Return device profile

  **Capability Detection**:
  1. Client reports supported codecs via API
  2. Service stores in device_codec_support
  3. Used for direct play vs transcode decisions
  4. Fallback to common codecs if not reported
api_endpoints: |
  ```
  POST /api/v1/clients/register     # Register device
  GET  /api/v1/clients/:id           # Get device info
  PUT  /api/v1/clients/:id/profile   # Update quality profile
  ```
unit_tests: |
  ```go
  func TestClientService_DetectCapabilities(t *testing.T) {
    // Test UA parsing and capability detection
  }
  ```
integration_tests: |
  ```go
  func TestClients_EndToEnd(t *testing.T) {
    // Test device registration and profile management
  }
  ```
