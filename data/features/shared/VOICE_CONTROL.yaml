doc_title: Voice Control
doc_category: feature
created_date: '2026-01-31'
overall_status: âœ… Complete
status_design: âœ…
status_design_notes: '-'
status_sources: ðŸŸ¡
status_sources_notes: '-'
status_instructions: âœ…
status_instructions_notes: '-'
status_code: ðŸ”´
status_code_notes: '-'
status_linting: ðŸ”´
status_linting_notes: '-'
status_unit_testing: ðŸ”´
status_unit_testing_notes: '-'
status_integration_testing: ðŸ”´
status_integration_testing_notes: '-'
technical_summary: '> Voice assistant integration (Alexa, Google Assistant)'
wiki_tagline: '> Control playback with Alexa and Google Assistant'
wiki_overview: Use your voice to control Revenge through smart assistants. Ask Alexa or Google to play a specific movie, pause,
  skip forward, or turn on subtitles. Browse by genre or actor with natural language. Works with Echo devices, Google Home,
  and compatible smart speakers. Requires linking your account in the assistant app.
sources:
- name: Uber fx
  url: https://pkg.go.dev/go.uber.org/fx
  note: Auto-resolved from fx
- name: ogen OpenAPI Generator
  url: https://pkg.go.dev/github.com/ogen-go/ogen
  note: Auto-resolved from ogen
- name: pgx PostgreSQL Driver
  url: https://pkg.go.dev/github.com/jackc/pgx/v5
  note: Auto-resolved from pgx
- name: PostgreSQL Arrays
  url: https://www.postgresql.org/docs/current/arrays.html
  note: Auto-resolved from postgresql-arrays
- name: PostgreSQL JSON Functions
  url: https://www.postgresql.org/docs/current/functions-json.html
  note: Auto-resolved from postgresql-json
- name: River Job Queue
  url: https://pkg.go.dev/github.com/riverqueue/river
  note: Auto-resolved from river
- name: sqlc
  url: https://docs.sqlc.dev/en/stable/
  note: Auto-resolved from sqlc
- name: sqlc Configuration
  url: https://docs.sqlc.dev/en/stable/reference/config.html
  note: Auto-resolved from sqlc-config
design_refs:
- title: 01_ARCHITECTURE
  path: ../../architecture/01_ARCHITECTURE.md
- title: 02_DESIGN_PRINCIPLES
  path: ../../architecture/02_DESIGN_PRINCIPLES.md
- title: 03_METADATA_SYSTEM
  path: ../../architecture/03_METADATA_SYSTEM.md
feature_name: Voice Control
module_name: voice_control
schema_name: public
architecture_diagram: |-
  ```mermaid
  flowchart TD
      node1([Client<br/>(Web/App)])
      node2[[API Handler<br/>(ogen)]]
      node3[[Service<br/>(Logic)]]
      node4["Repository<br/>(sqlc)"]
      node5[[Metadata<br/>Service]]
      node6[(Cache<br/>(otter))]
      node7[(PostgreSQL<br/>(pgx))]
      node8([External<br/>APIs])
      node1 --> node2
      node2 --> node3
      node4 --> node5
      node5 --> node6
      node7 --> node8
      node3 --> node4
      node6 --> node7
  ```
database_schema: |
  **Schema**: `public`

  ```sql
  -- Voice assistant integrations
  CREATE TABLE voice_assistant_connections (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    -- Assistant type
    assistant_type VARCHAR(50) NOT NULL,           -- 'alexa', 'google', 'siri'

    -- OAuth tokens (encrypted)
    access_token TEXT,
    refresh_token TEXT,
    token_expires_at TIMESTAMPTZ,

    -- Device info
    device_id TEXT,
    device_name TEXT,

    -- Status
    is_active BOOLEAN DEFAULT true,

    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
  );
  CREATE INDEX idx_voice_connections_user ON voice_assistant_connections(user_id);
  CREATE INDEX idx_voice_connections_type ON voice_assistant_connections(assistant_type);

  -- Voice command history
  CREATE TABLE voice_commands (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    connection_id UUID REFERENCES voice_assistant_connections(id) ON DELETE SET NULL,

    -- Command details
    assistant_type VARCHAR(50) NOT NULL,
    raw_command TEXT NOT NULL,                     -- Original voice input
    intent VARCHAR(100),                           -- 'play_media', 'pause', 'search', 'control_playback'
    entities JSONB,                                -- Extracted entities: {"title": "Inception", "type": "movie"}

    -- Execution
    was_successful BOOLEAN DEFAULT false,
    error_message TEXT,
    response_text TEXT,                            -- Response sent to user

    created_at TIMESTAMPTZ DEFAULT now()
  );
  CREATE INDEX idx_voice_commands_user ON voice_commands(user_id, created_at DESC);
  CREATE INDEX idx_voice_commands_intent ON voice_commands(intent);

  -- Voice-enabled devices
  CREATE TABLE voice_devices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    -- Device info
    device_type VARCHAR(50) NOT NULL,              -- 'echo_dot', 'google_home', 'homepod'
    device_name TEXT NOT NULL,
    device_id TEXT UNIQUE NOT NULL,

    -- Capabilities
    supports_playback BOOLEAN DEFAULT true,
    supports_search BOOLEAN DEFAULT true,
    supports_navigation BOOLEAN DEFAULT false,

    last_used_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT now()
  );
  CREATE INDEX idx_voice_devices_user ON voice_devices(user_id);
  ```
module_structure: |
  ```
  internal/voice/
  â”œâ”€â”€ module.go                    # fx module
  â”œâ”€â”€ types.go                     # Domain types
  â”œâ”€â”€ repository.go                # Database operations (sqlc)
  â”œâ”€â”€ service.go                   # Voice control logic
  â”œâ”€â”€ alexa.go                     # Alexa skill handler
  â”œâ”€â”€ google.go                    # Google Actions handler
  â”œâ”€â”€ intent_parser.go             # Natural language parsing
  â”œâ”€â”€ handler.go                   # HTTP API handlers
  â””â”€â”€ voice_test.go

  skills/
  â”œâ”€â”€ alexa/
  â”‚   â”œâ”€â”€ skill.json               # Alexa skill manifest
  â”‚   â”œâ”€â”€ interactionModel.json    # Alexa intents
  â”‚   â””â”€â”€ lambda/                  # Lambda function (optional)
  â””â”€â”€ google/
      â”œâ”€â”€ action.json              # Google Action manifest
      â””â”€â”€ intents.json             # Google intents
  ```
key_interfaces: |
  ```go
  type VoiceService interface {
    // Connections
    ConnectAssistant(ctx context.Context, userID uuid.UUID, assistantType string, tokens OAuth2Tokens) error
    DisconnectAssistant(ctx context.Context, connectionID uuid.UUID) error
    GetConnections(ctx context.Context, userID uuid.UUID) ([]VoiceConnection, error)

    // Command handling
    ProcessAlexaRequest(ctx context.Context, request AlexaRequest) (*AlexaResponse, error)
    ProcessGoogleRequest(ctx context.Context, request GoogleActionRequest) (*GoogleActionResponse, error)

    // Intent parsing
    ParseIntent(ctx context.Context, rawCommand string) (*VoiceIntent, error)
    ExecuteIntent(ctx context.Context, userID uuid.UUID, intent VoiceIntent) (*IntentResult, error)
  }

  type VoiceIntent struct {
    Intent   string                 `json:"intent"`    // 'play_media', 'pause', 'skip'
    Entities map[string]interface{} `json:"entities"`  // {"title": "Inception", "type": "movie"}
    Raw      string                 `json:"raw"`
  }

  type AlexaRequest struct {
    Version string      `json:"version"`
    Session AlexaSession `json:"session"`
    Request struct {
      Type   string `json:"type"`
      Intent struct {
        Name  string               `json:"name"`
        Slots map[string]AlexaSlot `json:"slots"`
      } `json:"intent"`
    } `json:"request"`
  }
  ```
dependencies: |
  **Go Packages**:
  - `github.com/google/uuid`
  - `github.com/jackc/pgx/v5`
  - `github.com/aws/aws-sdk-go-v2` - Alexa skill verification
  - `google.golang.org/api/dialogflow/v2` - Google Assistant integration
  - `go.uber.org/fx`

  **External APIs**:
  - Amazon Alexa Skills Kit (ASK)
  - Google Assistant SDK / Dialogflow
  - Apple HomeKit (future)
env_vars: |
  ```bash
  VOICE_ALEXA_SKILL_ID=amzn1.ask.skill.xxxxx
  VOICE_GOOGLE_PROJECT_ID=revenge-voice-xxxxx
  VOICE_ENABLED=true
  ```
config_keys: |
  ```yaml
  voice:
    enabled: true
    alexa:
      skill_id: amzn1.ask.skill.xxxxx
      verification_enabled: true
    google:
      project_id: revenge-voice-xxxxx
      credentials_file: /config/google-service-account.json
  ```
component_interaction: |
  **Alexa Command Flow**:
  1. User: "Alexa, ask Revenge to play Inception"
  2. Alexa sends JSON request to POST /api/v1/voice/alexa
  3. Service verifies request signature
  4. Parse intent: "PlayMediaIntent" with slots {"title": "Inception"}
  5. Search content database for "Inception"
  6. Start playback session for user's default device
  7. Return Alexa response: "Playing Inception"
  8. Log command in voice_commands table

  **Google Assistant Flow**:
  1. User: "Hey Google, tell Revenge to pause"
  2. Google sends request to POST /api/v1/voice/google
  3. Parse intent: "PauseIntent"
  4. Find active playback session for user
  5. Send pause command to playback service
  6. Return Google response: "Paused"
  7. Log command

  **Account Linking**:
  1. User opens Alexa/Google app
  2. Enable Revenge skill/action
  3. Redirect to Revenge OAuth2 flow
  4. User logs in and authorizes
  5. Alexa/Google receives OAuth token
  6. Store in voice_assistant_connections
api_endpoints: |
  ```
  # Voice webhook endpoints (public, verified)
  POST /api/v1/voice/alexa            # Alexa skill webhook
  POST /api/v1/voice/google           # Google Assistant webhook

  # User management
  GET  /api/v1/voice/connections      # List connections
  DELETE /api/v1/voice/connections/:id # Disconnect assistant

  # Command history
  GET  /api/v1/voice/commands         # Get command history
  ```

  **Example Alexa Request**:
  ```json
  {
    "version": "1.0",
    "session": {
      "user": {"userId": "amzn1.ask.account.XXXXX"}
    },
    "request": {
      "type": "IntentRequest",
      "intent": {
        "name": "PlayMediaIntent",
        "slots": {
          "title": {"value": "Inception"},
          "type": {"value": "movie"}
        }
      }
    }
  }
  ```

  **Example Alexa Response**:
  ```json
  {
    "version": "1.0",
    "response": {
      "outputSpeech": {
        "type": "PlainText",
        "text": "Playing Inception"
      },
      "shouldEndSession": true
    }
  }
  ```
unit_tests: |
  ```go
  func TestVoiceService_ParseIntent(t *testing.T) {
    // Test intent parsing from raw commands
  }

  func TestVoiceService_ProcessAlexaRequest(t *testing.T) {
    // Test Alexa request handling
  }
  ```
integration_tests: |
  ```go
  func TestVoice_AlexaFlow(t *testing.T) {
    // Test full Alexa command workflow
  }

  func TestVoice_GoogleFlow(t *testing.T) {
    // Test full Google Assistant workflow
  }
  ```
