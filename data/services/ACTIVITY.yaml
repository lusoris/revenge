doc_title: Activity Service
doc_category: service
created_date: '2026-01-31'
overall_status: âœ… Complete
status_design: âœ…
status_design_notes: '-'
status_sources: âœ…
status_sources_notes: '-'
status_instructions: âœ…
status_instructions_notes: '-'
status_code: ğŸ”´
status_code_notes: '-'
status_linting: ğŸ”´
status_linting_notes: '-'
status_unit_testing: ğŸ”´
status_unit_testing_notes: '-'
status_integration_testing: ğŸ”´
status_integration_testing_notes: '-'
technical_summary: '> Audit logging and event tracking'
wiki_tagline: '> Audit logging and event tracking'
wiki_overview: The Activity service logs important events for security and debugging.
  Track logins, failed auth attempts, permission changes, and admin actions. Activity
  logs include timestamps, user info, IP addresses, and action details. Admins can
  search and filter logs. Configurable retention period automatically cleans old entries.
sources:
- name: Uber fx
  url: https://pkg.go.dev/go.uber.org/fx
  note: Auto-resolved from fx
- name: ogen OpenAPI Generator
  url: https://pkg.go.dev/github.com/ogen-go/ogen
  note: Auto-resolved from ogen
- name: sqlc
  url: https://docs.sqlc.dev/en/stable/
  note: Auto-resolved from sqlc
- name: sqlc Configuration
  url: https://docs.sqlc.dev/en/stable/reference/config.html
  note: Auto-resolved from sqlc-config
design_refs:
- title: services
  path: INDEX.md
- title: 01_ARCHITECTURE
  path: ../architecture/01_ARCHITECTURE.md
- title: 02_DESIGN_PRINCIPLES
  path: ../architecture/02_DESIGN_PRINCIPLES.md
- title: 03_METADATA_SYSTEM
  path: ../architecture/03_METADATA_SYSTEM.md
service_name: Activity Service
package_path: internal/service/activity
fx_module: activity.Module

architecture_diagram: |
  ```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   Client    â”‚â”€â”€â”€â”€â–¶â”‚  API Handler â”‚â”€â”€â”€â”€â–¶â”‚   Service   â”‚
  â”‚  (Web/App)  â”‚â—€â”€â”€â”€â”€â”‚   (ogen)     â”‚â—€â”€â”€â”€â”€â”‚   (Logic)   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â–¼                      â–¼            â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚Repositoryâ”‚          â”‚  River    â”‚  â”‚  Cache â”‚
                  â”‚  (sqlc)  â”‚          â”‚  Queue    â”‚  â”‚(otter) â”‚
                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ PostgreSQL  â”‚
                  â”‚   (pgx)     â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```

database_schema: |
  **Schema**: `public`

  ```sql
  -- Activity audit log
  CREATE TABLE activity_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Actor (who performed the action)
    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    username VARCHAR(255),                         -- Denormalized for historical records

    -- Action details
    action VARCHAR(100) NOT NULL,                  -- 'user.login', 'user.logout', 'library.create', 'settings.update'
    resource_type VARCHAR(50),                     -- 'user', 'library', 'movie', 'setting'
    resource_id UUID,

    -- Change data
    changes JSONB,                                 -- {"field": {"old": "...", "new": "..."}}
    metadata JSONB,                                -- Additional context

    -- Request info
    ip_address INET,
    user_agent TEXT,

    -- Result
    success BOOLEAN DEFAULT true,
    error_message TEXT,

    created_at TIMESTAMPTZ DEFAULT now()
  );
  CREATE INDEX idx_activity_log_user ON activity_log(user_id, created_at DESC);
  CREATE INDEX idx_activity_log_action ON activity_log(action, created_at DESC);
  CREATE INDEX idx_activity_log_resource ON activity_log(resource_type, resource_id);
  CREATE INDEX idx_activity_log_created ON activity_log(created_at DESC);
  CREATE INDEX idx_activity_log_ip ON activity_log(ip_address, created_at DESC);
  ```

module_structure: |
  ```
  internal/service/activity/
  â”œâ”€â”€ module.go                    # fx module
  â”œâ”€â”€ types.go                     # Domain types
  â”œâ”€â”€ repository.go                # Database operations (sqlc)
  â”œâ”€â”€ service.go                   # Activity logging service
  â”œâ”€â”€ cleanup.go                   # Old log cleanup (River job)
  â”œâ”€â”€ handler.go                   # HTTP API handlers
  â””â”€â”€ activity_test.go
  ```

key_interfaces: |
  ```go
  type ActivityService interface {
    // Logging
    Log(ctx context.Context, entry ActivityEntry) error
    LogWithContext(ctx context.Context, userID uuid.UUID, action, resourceType string, resourceID uuid.UUID, changes map[string]interface{}) error

    // Querying
    GetUserActivity(ctx context.Context, userID uuid.UUID, filters ActivityFilters) ([]ActivityEntry, error)
    GetResourceActivity(ctx context.Context, resourceType string, resourceID uuid.UUID) ([]ActivityEntry, error)
    Search(ctx context.Context, filters ActivityFilters) ([]ActivityEntry, error)

    // Cleanup
    CleanupOldLogs(ctx context.Context, olderThan time.Time) (int, error)
  }

  type ActivityEntry struct {
    ID           uuid.UUID              `db:"id" json:"id"`
    UserID       *uuid.UUID             `db:"user_id" json:"user_id,omitempty"`
    Username     *string                `db:"username" json:"username,omitempty"`
    Action       string                 `db:"action" json:"action"`
    ResourceType *string                `db:"resource_type" json:"resource_type,omitempty"`
    ResourceID   *uuid.UUID             `db:"resource_id" json:"resource_id,omitempty"`
    Changes      map[string]interface{} `db:"changes" json:"changes,omitempty"`
    IPAddress    *net.IP                `db:"ip_address" json:"ip_address,omitempty"`
    Success      bool                   `db:"success" json:"success"`
    CreatedAt    time.Time              `db:"created_at" json:"created_at"`
  }
  ```

dependencies: |
  **Go Packages**:
  - `github.com/google/uuid`
  - `github.com/jackc/pgx/v5`
  - `github.com/riverqueue/river` - Cleanup jobs
  - `go.uber.org/fx`

env_vars: |
  ```bash
  ACTIVITY_RETENTION_DAYS=90
  ACTIVITY_CLEANUP_INTERVAL=24h
  ```

config_keys: |
  ```yaml
  activity:
    retention_days: 90
    cleanup_interval: 24h
    log_failed_attempts: true
  ```

component_interaction: |
  **Activity Logging**:
  1. User performs action (e.g., updates settings)
  2. Service calls ActivityService.Log()
  3. Extract user_id, IP, user agent from context
  4. Insert into activity_log table
  5. Async notification to admins for critical actions

  **Audit Query**:
  1. Admin searches activity: GET /api/v1/activity?user_id=...&action=...
  2. Service queries activity_log with filters
  3. Return paginated results

  **Cleanup** (background):
  1. River job runs daily
  2. DELETE FROM activity_log WHERE created_at < now() - retention_days
  3. Log cleanup statistics

api_endpoints: |
  ```
  GET    /api/v1/activity                # Search activity logs
  GET    /api/v1/activity/users/:id      # Get user activity
  GET    /api/v1/activity/resources/:type/:id # Get resource activity
  ```

  **Example Response**:
  ```json
  {
    "entries": [
      {
        "id": "uuid-123",
        "user_id": "uuid-456",
        "username": "admin",
        "action": "settings.update",
        "resource_type": "setting",
        "resource_id": "uuid-789",
        "changes": {
          "server.name": {
            "old": "Revenge",
            "new": "My Server"
          }
        },
        "ip_address": "192.168.1.100",
        "success": true,
        "created_at": "2026-02-01T10:00:00Z"
      }
    ],
    "total": 1,
    "page": 1
  }
  ```

unit_tests: |
  ```go
  func TestActivityService_Log(t *testing.T) {
    // Test activity logging
  }
  ```

integration_tests: |
  ```go
  func TestActivity_CleanupOldLogs(t *testing.T) {
    // Test log retention cleanup
  }
  ```
