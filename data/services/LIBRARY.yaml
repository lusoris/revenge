doc_title: Library Service
doc_category: service
created_date: '2026-01-31'
overall_status: ‚úÖ Complete
status_design: ‚úÖ
status_design_notes: '-'
status_sources: ‚úÖ
status_sources_notes: '-'
status_instructions: ‚úÖ
status_instructions_notes: '-'
status_code: üî¥
status_code_notes: '-'
status_linting: üî¥
status_linting_notes: '-'
status_unit_testing: üî¥
status_unit_testing_notes: '-'
status_integration_testing: üî¥
status_integration_testing_notes: '-'
technical_summary: '> Library management and access control'
wiki_tagline: '> Library management and access control'
wiki_overview: Libraries organize your media by type and location. Create separate libraries for Movies, TV Shows, Music,
  or Adult content. Each library points to one or more folders on disk. Control which users can see which libraries. Libraries
  scan automatically on a schedule or manually on demand. Configure refresh intervals, naming conventions, and metadata sources
  per library.
sources:
- name: Casbin
  url: https://pkg.go.dev/github.com/casbin/casbin/v2
  note: Auto-resolved from casbin
- name: Uber fx
  url: https://pkg.go.dev/go.uber.org/fx
  note: Auto-resolved from fx
- name: ogen OpenAPI Generator
  url: https://pkg.go.dev/github.com/ogen-go/ogen
  note: Auto-resolved from ogen
- name: pgx PostgreSQL Driver
  url: https://pkg.go.dev/github.com/jackc/pgx/v5
  note: Auto-resolved from pgx
- name: PostgreSQL Arrays
  url: https://www.postgresql.org/docs/current/arrays.html
  note: Auto-resolved from postgresql-arrays
- name: PostgreSQL JSON Functions
  url: https://www.postgresql.org/docs/current/functions-json.html
  note: Auto-resolved from postgresql-json
- name: River Job Queue
  url: https://pkg.go.dev/github.com/riverqueue/river
  note: Auto-resolved from river
- name: sqlc
  url: https://docs.sqlc.dev/en/stable/
  note: Auto-resolved from sqlc
- name: sqlc Configuration
  url: https://docs.sqlc.dev/en/stable/reference/config.html
  note: Auto-resolved from sqlc-config
design_refs:
- title: services
  path: INDEX.md
- title: 01_ARCHITECTURE
  path: ../architecture/01_ARCHITECTURE.md
- title: 02_DESIGN_PRINCIPLES
  path: ../architecture/02_DESIGN_PRINCIPLES.md
- title: 03_METADATA_SYSTEM
  path: ../architecture/03_METADATA_SYSTEM.md
service_name: Library Service
package_path: internal/service/library
fx_module: library.Module
architecture_diagram: |-
  ```mermaid
  flowchart TD
      node1["Client<br/>(Web/App)"]
      node2["API Handler<br/>(ogen)"]
      node3["Service<br/>(Logic)"]
      node4["‚ñº                      ‚ñº            ‚ñº<br/>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ<br/>sitory"]
      node5["PostgreSQL<br/>(pgx)"]
      node1 --> node2
      node2 --> node3
      node3 --> node4
      node4 --> node5
  ```
database_schema: |
  **Schema**: `public`

  Note: Core schema defined in LIBRARY_TYPES.yaml feature. Additional service-specific tables:

  ```sql
  -- Library permissions (user access to libraries)
  CREATE TABLE library_permissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    library_id UUID NOT NULL REFERENCES libraries(id) ON DELETE CASCADE,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    role_id UUID REFERENCES roles(id) ON DELETE CASCADE,

    -- Permission type
    permission VARCHAR(50) NOT NULL,               -- 'view', 'download', 'manage'

    created_at TIMESTAMPTZ DEFAULT now()
  );
  CREATE UNIQUE INDEX idx_library_perms_user ON library_permissions(library_id, user_id, permission);
  CREATE INDEX idx_library_perms_role ON library_permissions(library_id, role_id);
  ```
module_structure: |
  ```
  internal/service/library/
  ‚îú‚îÄ‚îÄ module.go                    # fx module
  ‚îú‚îÄ‚îÄ types.go                     # Domain types
  ‚îú‚îÄ‚îÄ repository.go                # Database operations (sqlc)
  ‚îú‚îÄ‚îÄ service.go                   # Library service logic
  ‚îú‚îÄ‚îÄ permissions.go               # Library access control
  ‚îú‚îÄ‚îÄ handler.go                   # HTTP API handlers
  ‚îî‚îÄ‚îÄ library_test.go
  ```
key_interfaces: |
  ```go
  type LibraryService interface {
    // Library CRUD (delegates to library types feature)
    GetLibrary(ctx context.Context, libraryID uuid.UUID) (*Library, error)
    ListLibraries(ctx context.Context, userID uuid.UUID) ([]Library, error)

    // Permissions
    GrantPermission(ctx context.Context, libraryID, userID uuid.UUID, permission string) error
    RevokePermission(ctx context.Context, libraryID, userID uuid.UUID, permission string) error
    CheckPermission(ctx context.Context, libraryID, userID uuid.UUID, permission string) (bool, error)

    // Scan operations
    TriggerScan(ctx context.Context, libraryID uuid.UUID, scanType string) error
  }
  ```
dependencies: |
  **Go Packages**:
  - `github.com/google/uuid`
  - `github.com/jackc/pgx/v5`
  - `github.com/fsnotify/fsnotify`
  - `go.uber.org/fx`
env_vars: |
  ```bash
  LIBRARY_DEFAULT_SCAN_INTERVAL=6h
  ```
config_keys: |
  ```yaml
  library:
    default_scan_interval: 6h
    realtime_monitoring: true
  ```
component_interaction: |
  **Check Library Access**:
  1. User requests GET /api/v1/libraries/:id
  2. Service checks library_permissions for user
  3. If no direct permission, check role-based permissions via RBAC
  4. If permitted, return library details
  5. If not, return 403 Forbidden
api_endpoints: |
  ```
  GET    /api/v1/libraries                   # List accessible libraries
  GET    /api/v1/libraries/:id               # Get library details
  POST   /api/v1/libraries/:id/permissions   # Grant permission
  DELETE /api/v1/libraries/:id/permissions/:user_id # Revoke permission
  ```
unit_tests: |
  ```go
  func TestLibraryService_CheckPermission(t *testing.T) {
    // Test permission checking
  }
  ```
integration_tests: |
  ```go
  func TestLibrary_PermissionFlow(t *testing.T) {
    // Test grant/revoke/check workflow
  }
  ```
