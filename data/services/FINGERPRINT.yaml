doc_title: Fingerprint Service
doc_category: service
created_date: '2026-01-31'
overall_status: âœ… Complete
status_design: âœ…
status_design_notes: '-'
status_sources: âœ…
status_sources_notes: '-'
status_instructions: âœ…
status_instructions_notes: '-'
status_code: ðŸ”´
status_code_notes: '-'
status_linting: ðŸ”´
status_linting_notes: '-'
status_unit_testing: ðŸ”´
status_unit_testing_notes: '-'
status_integration_testing: ðŸ”´
status_integration_testing_notes: '-'
technical_summary: '> Media file identification via perceptual hashing and acoustic
  fingerprinting'
wiki_tagline: '> Media file identification via perceptual hashing and acoustic fingerprinting'
wiki_overview: Fingerprinting identifies media files by their content, not just filenames.
  Perceptual hashes match images and video frames even after re-encoding. Acoustic
  fingerprints identify music tracks. This enables duplicate detection, automatic
  metadata matching, and skip intro detection. Fingerprints are computed on library
  scan and stored for fast lookups.
sources:
- name: FFmpeg Documentation
  url: https://ffmpeg.org/ffmpeg.html
  note: Auto-resolved from ffmpeg
- name: FFmpeg Codecs
  url: https://ffmpeg.org/ffmpeg-codecs.html
  note: Auto-resolved from ffmpeg-codecs
- name: FFmpeg Formats
  url: https://ffmpeg.org/ffmpeg-formats.html
  note: Auto-resolved from ffmpeg-formats
- name: Uber fx
  url: https://pkg.go.dev/go.uber.org/fx
  note: Auto-resolved from fx
- name: go-astiav (FFmpeg bindings)
  url: https://pkg.go.dev/github.com/asticode/go-astiav
  note: Auto-resolved from go-astiav
- name: go-astiav GitHub README
  url: https://github.com/asticode/go-astiav
  note: Auto-resolved from go-astiav-docs
- name: pgx PostgreSQL Driver
  url: https://pkg.go.dev/github.com/jackc/pgx/v5
  note: Auto-resolved from pgx
- name: PostgreSQL Arrays
  url: https://www.postgresql.org/docs/current/arrays.html
  note: Auto-resolved from postgresql-arrays
- name: PostgreSQL JSON Functions
  url: https://www.postgresql.org/docs/current/functions-json.html
  note: Auto-resolved from postgresql-json
- name: River Job Queue
  url: https://pkg.go.dev/github.com/riverqueue/river
  note: Auto-resolved from river
design_refs:
- title: services
  path: INDEX.md
- title: 01_ARCHITECTURE
  path: ../architecture/01_ARCHITECTURE.md
- title: 02_DESIGN_PRINCIPLES
  path: ../architecture/02_DESIGN_PRINCIPLES.md
- title: 03_METADATA_SYSTEM
  path: ../architecture/03_METADATA_SYSTEM.md
service_name: Fingerprint Service
package_path: internal/service/fingerprint
fx_module: fingerprint.Module

architecture_diagram: |
  ```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   Scanner   â”‚â”€â”€â”€â”€â–¶â”‚   Service    â”‚â”€â”€â”€â”€â–¶â”‚  Repository â”‚
  â”‚  (Library)  â”‚     â”‚   (Logic)    â”‚     â”‚   (sqlc)    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                             â”‚                    â”‚
                             â–¼                    â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚   FFmpeg    â”‚      â”‚ PostgreSQL  â”‚
                      â”‚(go-astiav)  â”‚      â”‚   (pgx)     â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```

database_schema: |
  **Schema**: `public`

  ```sql
  -- Media fingerprints
  CREATE TABLE media_fingerprints (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Content reference
    content_type VARCHAR(50) NOT NULL,             -- 'movie', 'episode', 'track', 'image'
    content_id UUID NOT NULL,
    file_path TEXT NOT NULL,

    -- Perceptual hash (for images/video frames)
    phash BIGINT,                                  -- 64-bit perceptual hash

    -- Acoustic fingerprint (for audio)
    chromaprint TEXT,                              -- Chromaprint fingerprint
    duration_seconds INTEGER,

    -- File hash (for deduplication)
    md5_hash VARCHAR(32),
    sha256_hash VARCHAR(64),
    file_size_bytes BIGINT,

    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
  );
  CREATE UNIQUE INDEX idx_fingerprints_content ON media_fingerprints(content_type, content_id);
  CREATE INDEX idx_fingerprints_phash ON media_fingerprints(phash) WHERE phash IS NOT NULL;
  CREATE INDEX idx_fingerprints_md5 ON media_fingerprints(md5_hash) WHERE md5_hash IS NOT NULL;
  CREATE INDEX idx_fingerprints_sha256 ON media_fingerprints(sha256_hash) WHERE sha256_hash IS NOT NULL;

  -- Duplicate detection results
  CREATE TABLE duplicate_files (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Original file
    original_fingerprint_id UUID NOT NULL REFERENCES media_fingerprints(id) ON DELETE CASCADE,

    -- Duplicate file
    duplicate_fingerprint_id UUID NOT NULL REFERENCES media_fingerprints(id) ON DELETE CASCADE,

    -- Similarity metrics
    similarity_score FLOAT NOT NULL,               -- 0.0-1.0
    match_type VARCHAR(50) NOT NULL,               -- 'exact_hash', 'perceptual', 'acoustic'

    detected_at TIMESTAMPTZ DEFAULT now(),
    UNIQUE(original_fingerprint_id, duplicate_fingerprint_id)
  );
  CREATE INDEX idx_duplicates_original ON duplicate_files(original_fingerprint_id);
  ```

module_structure: |
  ```
  internal/service/fingerprint/
  â”œâ”€â”€ module.go                    # fx module
  â”œâ”€â”€ types.go                     # Domain types
  â”œâ”€â”€ repository.go                # Database operations (sqlc)
  â”œâ”€â”€ service.go                   # Fingerprinting service
  â”œâ”€â”€ perceptual.go                # Perceptual hashing (pHash)
  â”œâ”€â”€ acoustic.go                  # Acoustic fingerprinting (Chromaprint)
  â”œâ”€â”€ hash.go                      # File hashing (MD5, SHA256)
  â”œâ”€â”€ duplicate.go                 # Duplicate detection
  â”œâ”€â”€ handler.go                   # HTTP API handlers
  â””â”€â”€ fingerprint_test.go
  ```

key_interfaces: |
  ```go
  type FingerprintService interface {
    // Generate fingerprints
    GenerateFingerprint(ctx context.Context, contentType string, contentID uuid.UUID, filePath string) (*Fingerprint, error)
    GenerateBatch(ctx context.Context, files []FileInfo) error

    // Query
    GetFingerprint(ctx context.Context, contentType string, contentID uuid.UUID) (*Fingerprint, error)
    FindSimilar(ctx context.Context, fingerprint Fingerprint, threshold float64) ([]Fingerprint, error)

    // Duplicate detection
    DetectDuplicates(ctx context.Context) ([]DuplicateMatch, error)
    GetDuplicates(ctx context.Context, fingerprintID uuid.UUID) ([]DuplicateMatch, error)
  }

  type Fingerprint struct {
    ID              uuid.UUID  `db:"id" json:"id"`
    ContentType     string     `db:"content_type" json:"content_type"`
    ContentID       uuid.UUID  `db:"content_id" json:"content_id"`
    FilePath        string     `db:"file_path" json:"file_path"`
    PHash           *int64     `db:"phash" json:"phash,omitempty"`
    Chromaprint     *string    `db:"chromaprint" json:"chromaprint,omitempty"`
    MD5Hash         *string    `db:"md5_hash" json:"md5_hash,omitempty"`
    SHA256Hash      *string    `db:"sha256_hash" json:"sha256_hash,omitempty"`
    FileSizeBytes   int64      `db:"file_size_bytes" json:"file_size_bytes"`
  }
  ```

dependencies: |
  **Go Packages**:
  - `github.com/google/uuid`
  - `github.com/jackc/pgx/v5`
  - `github.com/asticode/go-astiav` - FFmpeg for frame extraction
  - `crypto/md5` - File hashing
  - `crypto/sha256` - File hashing
  - `github.com/riverqueue/river` - Background fingerprinting jobs
  - `go.uber.org/fx`

  **External Tools**:
  - FFmpeg (for frame extraction)
  - fpcalc (Chromaprint fingerprinting tool)

env_vars: |
  ```bash
  FINGERPRINT_ENABLED=true
  FINGERPRINT_AUTO_SCAN=true
  FINGERPRINT_DUPLICATE_THRESHOLD=0.95
  ```

config_keys: |
  ```yaml
  fingerprint:
    enabled: true
    auto_scan: true
    duplicate_threshold: 0.95
    chromaprint_path: /usr/bin/fpcalc
  ```

component_interaction: |
  **Fingerprint Generation** (on library scan):
  1. Library scanner finds new video file
  2. Queue fingerprint job via River
  3. Background worker:
     - Calculate MD5/SHA256 of file
     - Extract keyframe with FFmpeg
     - Generate perceptual hash (pHash)
     - If audio, extract with fpcalc to get Chromaprint
  4. Store in media_fingerprints
  5. Check for duplicates based on hashes

  **Duplicate Detection**:
  1. Admin triggers: POST /api/v1/fingerprints/detect-duplicates
  2. Query all fingerprints
  3. For each pair with matching file size:
     - Compare MD5/SHA256 (exact match = 1.0)
     - Compare pHash (Hamming distance)
     - Compare Chromaprint (similarity score)
  4. If similarity > threshold, insert into duplicate_files
  5. Return duplicate pairs

api_endpoints: |
  ```
  POST   /api/v1/fingerprints/generate/:type/:id  # Generate fingerprint
  GET    /api/v1/fingerprints/:type/:id           # Get fingerprint
  POST   /api/v1/fingerprints/detect-duplicates   # Detect duplicates
  GET    /api/v1/fingerprints/duplicates          # List all duplicates
  DELETE /api/v1/fingerprints/duplicates/:id      # Mark as not duplicate
  ```

unit_tests: |
  ```go
  func TestFingerprintService_GenerateFingerprint(t *testing.T) {
    // Test fingerprint generation
  }

  func TestPerceptualHash_Similarity(t *testing.T) {
    // Test pHash similarity calculation
  }
  ```

integration_tests: |
  ```go
  func TestFingerprint_DuplicateDetection(t *testing.T) {
    // Test full duplicate detection workflow
  }
  ```
