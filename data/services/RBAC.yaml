doc_title: RBAC Service
doc_category: service
created_date: '2026-01-31'
overall_status: âœ… Complete
status_design: âœ…
status_design_notes: '-'
status_sources: âœ…
status_sources_notes: '-'
status_instructions: âœ…
status_instructions_notes: '-'
status_code: ğŸ”´
status_code_notes: '-'
status_linting: ğŸ”´
status_linting_notes: '-'
status_unit_testing: ğŸ”´
status_unit_testing_notes: '-'
status_integration_testing: ğŸ”´
status_integration_testing_notes: '-'
technical_summary: '> Role-based access control with Casbin'
wiki_tagline: '> Role-based access control with Casbin'
wiki_overview: The RBAC service controls who can do what in Revenge. Built on Casbin,
  it supports roles (Admin, User, Guest) and fine-grained permissions. Admins define
  policies like "Users can view movies" or "Guests cannot access adult content". Policies
  are stored in PostgreSQL and cached for fast authorization checks on every request.
sources:
- name: Casbin
  url: https://pkg.go.dev/github.com/casbin/casbin/v2
  note: Auto-resolved from casbin
- name: Uber fx
  url: https://pkg.go.dev/go.uber.org/fx
  note: Auto-resolved from fx
- name: pgx PostgreSQL Driver
  url: https://pkg.go.dev/github.com/jackc/pgx/v5
  note: Auto-resolved from pgx
- name: PostgreSQL Arrays
  url: https://www.postgresql.org/docs/current/arrays.html
  note: Auto-resolved from postgresql-arrays
- name: PostgreSQL JSON Functions
  url: https://www.postgresql.org/docs/current/functions-json.html
  note: Auto-resolved from postgresql-json
- name: River Job Queue
  url: https://pkg.go.dev/github.com/riverqueue/river
  note: Auto-resolved from river
design_refs:
- title: services
  path: INDEX.md
- title: 01_ARCHITECTURE
  path: ../architecture/01_ARCHITECTURE.md
- title: 02_DESIGN_PRINCIPLES
  path: ../architecture/02_DESIGN_PRINCIPLES.md
- title: 03_METADATA_SYSTEM
  path: ../architecture/03_METADATA_SYSTEM.md
service_name: RBAC Service
package_path: internal/service/rbac
fx_module: rbac.Module

architecture_diagram: |
  ```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   Client    â”‚â”€â”€â”€â”€â–¶â”‚  Middleware  â”‚â”€â”€â”€â”€â–¶â”‚   Casbin    â”‚
  â”‚  (Web/App)  â”‚â—€â”€â”€â”€â”€â”‚   (Auth)     â”‚â—€â”€â”€â”€â”€â”‚  Enforcer   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                                                   â–¼
                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                            â”‚ PostgreSQL  â”‚
                                            â”‚casbin_rule  â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```

database_schema: |
  **Schema**: `public`

  Note: Core schema defined in RBAC_CASBIN.yaml feature. Additional service-specific tables:

  ```sql
  -- Casbin rules (managed by casbin-pgx-adapter)
  CREATE TABLE casbin_rule (
    id SERIAL PRIMARY KEY,
    ptype VARCHAR(100),
    v0 VARCHAR(100),
    v1 VARCHAR(100),
    v2 VARCHAR(100),
    v3 VARCHAR(100),
    v4 VARCHAR(100),
    v5 VARCHAR(100)
  );
  CREATE INDEX idx_casbin_rule_ptype ON casbin_rule(ptype);
  ```

module_structure: |
  ```
  internal/service/rbac/
  â”œâ”€â”€ module.go                    # fx module
  â”œâ”€â”€ types.go                     # Domain types
  â”œâ”€â”€ service.go                   # RBAC service logic
  â”œâ”€â”€ enforcer.go                  # Casbin enforcer wrapper
  â”œâ”€â”€ middleware.go                # HTTP auth middleware
  â”œâ”€â”€ handler.go                   # HTTP API handlers
  â””â”€â”€ rbac_test.go
  ```

key_interfaces: |
  ```go
  type RBACService interface {
    // Policy enforcement
    Enforce(ctx context.Context, sub, obj, act string) (bool, error)
    EnforceWithContext(ctx context.Context, userID uuid.UUID, resource, action string) (bool, error)

    // Policy management
    AddPolicy(ctx context.Context, sub, obj, act string) error
    RemovePolicy(ctx context.Context, sub, obj, act string) error
    GetPolicies(ctx context.Context) ([][]string, error)

    // Role management
    AssignRole(ctx context.Context, userID uuid.UUID, role string) error
    RemoveRole(ctx context.Context, userID uuid.UUID, role string) error
    GetUserRoles(ctx context.Context, userID uuid.UUID) ([]string, error)
  }
  ```

dependencies: |
  **Go Packages**:
  - `github.com/google/uuid`
  - `github.com/jackc/pgx/v5`
  - `github.com/casbin/casbin/v2`
  - `github.com/casbin/pgx-adapter`
  - `go.uber.org/fx`

env_vars: |
  ```bash
  RBAC_MODEL_PATH=/config/casbin_model.conf
  RBAC_POLICY_RELOAD_INTERVAL=5m
  ```

config_keys: |
  ```yaml
  rbac:
    model_path: /config/casbin_model.conf
    policy_reload_interval: 5m
  ```

component_interaction: |
  **Authorization Check**:
  1. HTTP request with Bearer token
  2. Middleware validates session
  3. Extract user_id from session
  4. Call RBAC.Enforce(user_id, resource, action)
  5. Casbin checks policies in PostgreSQL
  6. If allowed, proceed; if denied, return 403

api_endpoints: |
  ```
  # Policy management (admin only)
  GET    /api/v1/rbac/policies              # List policies
  POST   /api/v1/rbac/policies              # Add policy
  DELETE /api/v1/rbac/policies              # Remove policy

  # Role management
  POST   /api/v1/rbac/users/:id/roles       # Assign role
  DELETE /api/v1/rbac/users/:id/roles/:role # Remove role
  GET    /api/v1/rbac/users/:id/roles       # Get user roles
  ```

unit_tests: |
  ```go
  func TestRBACService_Enforce(t *testing.T) {
    // Test policy enforcement
  }
  ```

integration_tests: |
  ```go
  func TestRBAC_MiddlewareIntegration(t *testing.T) {
    // Test HTTP middleware auth flow
  }
  ```
