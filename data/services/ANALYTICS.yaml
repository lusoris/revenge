doc_title: Analytics Service
doc_category: service
created_date: '2026-01-31'
overall_status: ‚úÖ Complete
status_design: ‚úÖ
status_design_notes: '-'
status_sources: ‚úÖ
status_sources_notes: '-'
status_instructions: ‚úÖ
status_instructions_notes: Generated from design
status_code: üî¥
status_code_notes: '-'
status_linting: üî¥
status_linting_notes: '-'
status_unit_testing: üî¥
status_unit_testing_notes: '-'
status_integration_testing: üî¥
status_integration_testing_notes: '-'
technical_summary: '> Usage analytics, playback statistics, and library insights'
wiki_tagline: '> Usage analytics, playback statistics, and library insights'
wiki_overview: Analytics provides insights into how your server is used. See most-watched movies, popular genres, peak usage
  times, and user activity. Track playback statistics like total watch time and completion rates. Library dashboards show
  storage usage, file counts, and metadata coverage. All data stays on your server - no external tracking.
sources:
- name: Uber fx
  url: https://pkg.go.dev/go.uber.org/fx
  note: Auto-resolved from fx
- name: pgx PostgreSQL Driver
  url: https://pkg.go.dev/github.com/jackc/pgx/v5
  note: Auto-resolved from pgx
- name: PostgreSQL Arrays
  url: https://www.postgresql.org/docs/current/arrays.html
  note: Auto-resolved from postgresql-arrays
- name: PostgreSQL JSON Functions
  url: https://www.postgresql.org/docs/current/functions-json.html
  note: Auto-resolved from postgresql-json
- name: River Job Queue
  url: https://pkg.go.dev/github.com/riverqueue/river
  note: Auto-resolved from river
design_refs:
- title: services
  path: INDEX.md
- title: 01_ARCHITECTURE
  path: ../architecture/01_ARCHITECTURE.md
- title: 02_DESIGN_PRINCIPLES
  path: ../architecture/02_DESIGN_PRINCIPLES.md
- title: 03_METADATA_SYSTEM
  path: ../architecture/03_METADATA_SYSTEM.md
service_name: Analytics Service
package_path: internal/service/analytics
fx_module: analytics.Module
architecture_diagram: |-
  ```mermaid
  flowchart TD
      node1["Client<br/>(Web/App)"]
      node2["API Handler<br/>(ogen)"]
      node3["Service<br/>(Logic)"]
      node4["‚ñº                      ‚ñº            ‚ñº<br/>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ<br/>sitory"]
      node5["PostgreSQL<br/>(pgx)"]
      node1 --> node2
      node2 --> node3
      node3 --> node4
      node4 --> node5
  ```
database_schema: |
  **Schema**: `public`

  Note: Core playback analytics in ANALYTICS_SERVICE.yaml feature. Service-specific aggregation tables:

  ```sql
  -- Library statistics (aggregated)
  CREATE TABLE library_stats (
    library_id UUID NOT NULL REFERENCES libraries(id) ON DELETE CASCADE,
    stat_date DATE NOT NULL,

    -- Content counts
    total_items INTEGER DEFAULT 0,
    total_size_bytes BIGINT DEFAULT 0,

    -- Playback stats
    total_plays INTEGER DEFAULT 0,
    unique_users INTEGER DEFAULT 0,
    total_watch_time_seconds BIGINT DEFAULT 0,

    PRIMARY KEY (library_id, stat_date)
  );
  CREATE INDEX idx_library_stats_date ON library_stats(stat_date DESC);

  -- Popular content (aggregated)
  CREATE TABLE popular_content (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    content_type VARCHAR(50) NOT NULL,
    content_id UUID NOT NULL,

    -- Time periods
    plays_24h INTEGER DEFAULT 0,
    plays_7d INTEGER DEFAULT 0,
    plays_30d INTEGER DEFAULT 0,
    plays_all_time INTEGER DEFAULT 0,

    last_updated TIMESTAMPTZ DEFAULT now(),
    UNIQUE(content_type, content_id)
  );
  CREATE INDEX idx_popular_content_24h ON popular_content(plays_24h DESC);
  CREATE INDEX idx_popular_content_7d ON popular_content(plays_7d DESC);
  ```
module_structure: |
  ```
  internal/service/analytics/
  ‚îú‚îÄ‚îÄ module.go                    # fx module
  ‚îú‚îÄ‚îÄ types.go                     # Domain types
  ‚îú‚îÄ‚îÄ repository.go                # Database operations (sqlc)
  ‚îú‚îÄ‚îÄ service.go                   # Analytics service
  ‚îú‚îÄ‚îÄ aggregation.go               # Data aggregation (River jobs)
  ‚îú‚îÄ‚îÄ reports.go                   # Report generation
  ‚îú‚îÄ‚îÄ handler.go                   # HTTP API handlers
  ‚îî‚îÄ‚îÄ analytics_test.go
  ```
key_interfaces: |
  ```go
  type AnalyticsService interface {
    // Library stats
    GetLibraryStats(ctx context.Context, libraryID uuid.UUID, dateRange DateRange) (*LibraryStats, error)
    GetServerStats(ctx context.Context, dateRange DateRange) (*ServerStats, error)

    // Popular content
    GetMostWatched(ctx context.Context, contentType string, period TimePeriod, limit int) ([]PopularItem, error)
    GetTopGenres(ctx context.Context, period TimePeriod) ([]GenreStats, error)

    // User insights
    GetUserActivity(ctx context.Context, userID uuid.UUID, dateRange DateRange) (*UserActivity, error)
    GetActiveUsers(ctx context.Context, period TimePeriod) (int, error)

    // Aggregation
    AggregateDaily(ctx context.Context, date time.Time) error
  }

  type ServerStats struct {
    TotalLibraries    int     `json:"total_libraries"`
    TotalItems        int     `json:"total_items"`
    TotalSizeGB       float64 `json:"total_size_gb"`
    TotalUsers        int     `json:"total_users"`
    ActiveUsers24h    int     `json:"active_users_24h"`
    TotalPlays        int     `json:"total_plays"`
    TotalWatchHours   float64 `json:"total_watch_hours"`
  }
  ```
dependencies: |
  **Go Packages**:
  - `github.com/google/uuid`
  - `github.com/jackc/pgx/v5`
  - `github.com/riverqueue/river` - Aggregation jobs
  - `github.com/maypok86/otter` - Stats cache
  - `go.uber.org/fx`
env_vars: |
  ```bash
  ANALYTICS_AGGREGATION_INTERVAL=1h
  ANALYTICS_RETENTION_DAYS=365
  ```
config_keys: |
  ```yaml
  analytics:
    aggregation_interval: 1h
    retention_days: 365
    cache_ttl: 5m
  ```
component_interaction: |
  **Daily Aggregation** (background):
  1. River job runs every hour
  2. Query playback_sessions for past hour
  3. Aggregate by library, content, user
  4. Update library_stats, popular_content tables
  5. Cache invalidation for affected stats

  **Dashboard Query**:
  1. Admin requests GET /api/v1/analytics/server
  2. Service queries aggregated tables
  3. Calculate totals, averages
  4. Return dashboard data
api_endpoints: |
  ```
  GET    /api/v1/analytics/server              # Server overview
  GET    /api/v1/analytics/libraries/:id       # Library stats
  GET    /api/v1/analytics/popular/:type       # Most watched content
  GET    /api/v1/analytics/users/:id           # User activity
  ```

  **Example Server Stats Response**:
  ```json
  {
    "total_libraries": 5,
    "total_items": 1543,
    "total_size_gb": 8542.3,
    "total_users": 12,
    "active_users_24h": 8,
    "total_plays": 23456,
    "total_watch_hours": 4532.5
  }
  ```
unit_tests: |
  ```go
  func TestAnalyticsService_AggregateDaily(t *testing.T) {
    // Test daily aggregation
  }
  ```
integration_tests: |
  ```go
  func TestAnalytics_ReportGeneration(t *testing.T) {
    // Test full analytics workflow
  }
  ```
