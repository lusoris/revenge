doc_title: User Service
doc_category: service
created_date: '2026-01-31'
overall_status: âœ… Complete
status_design: âœ…
status_design_notes: '-'
status_sources: âœ…
status_sources_notes: '-'
status_instructions: âœ…
status_instructions_notes: '-'
status_code: ðŸ”´
status_code_notes: '-'
status_linting: ðŸ”´
status_linting_notes: '-'
status_unit_testing: ðŸ”´
status_unit_testing_notes: '-'
status_integration_testing: ðŸ”´
status_integration_testing_notes: '-'
technical_summary: '> User account management and authentication'
wiki_tagline: '> User account management and authentication'
wiki_overview: The User service manages user accounts, profiles, and preferences. Admins can create users, assign roles, and
  manage permissions. Users can update their profile, change email/password, and configure notification settings. Profile
  images are stored with configurable storage backends. User data can be exported or deleted for GDPR compliance.
sources:
- name: Uber fx
  url: https://pkg.go.dev/go.uber.org/fx
  note: Auto-resolved from fx
- name: golang.org/x/crypto
  url: https://pkg.go.dev/golang.org/x/crypto
  note: Auto-resolved from golang-x-crypto
- name: ogen OpenAPI Generator
  url: https://pkg.go.dev/github.com/ogen-go/ogen
  note: Auto-resolved from ogen
- name: pgx PostgreSQL Driver
  url: https://pkg.go.dev/github.com/jackc/pgx/v5
  note: Auto-resolved from pgx
- name: PostgreSQL Arrays
  url: https://www.postgresql.org/docs/current/arrays.html
  note: Auto-resolved from postgresql-arrays
- name: PostgreSQL JSON Functions
  url: https://www.postgresql.org/docs/current/functions-json.html
  note: Auto-resolved from postgresql-json
- name: River Job Queue
  url: https://pkg.go.dev/github.com/riverqueue/river
  note: Auto-resolved from river
- name: sqlc
  url: https://docs.sqlc.dev/en/stable/
  note: Auto-resolved from sqlc
- name: sqlc Configuration
  url: https://docs.sqlc.dev/en/stable/reference/config.html
  note: Auto-resolved from sqlc-config
design_refs:
- title: services
  path: INDEX.md
- title: 01_ARCHITECTURE
  path: ../architecture/01_ARCHITECTURE.md
- title: 02_DESIGN_PRINCIPLES
  path: ../architecture/02_DESIGN_PRINCIPLES.md
- title: 03_METADATA_SYSTEM
  path: ../architecture/03_METADATA_SYSTEM.md
service_name: User Service
package_path: internal/service/user
fx_module: user.Module
architecture_diagram: |-
  ```mermaid
  flowchart TD
      node1([Client<br/>(Web/App)])
      node2[[API Handler<br/>(ogen)]]
      node3[[Service<br/>(Logic)]]
      node4["Repository<br/>(sqlc)"]
      node5[(Storage<br/>Service)]
      node6[(Cache<br/>(otter))]
      node7[(PostgreSQL<br/>(pgx))]
      node8[(File<br/>Storage)]
      node1 --> node2
      node2 --> node3
      node4 --> node5
      node5 --> node6
      node7 --> node8
      node3 --> node4
      node6 --> node7
  ```
database_schema: |
  **Schema**: `public`

  ```sql
  -- User profiles
  CREATE TABLE user_profiles (
    user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

    -- Profile info
    bio TEXT,
    avatar_url TEXT,
    banner_url TEXT,

    -- Location/timezone
    timezone VARCHAR(50),                          -- 'America/New_York', 'Europe/London'
    language VARCHAR(10) DEFAULT 'en',             -- ISO 639-1 code
    country VARCHAR(2),                            -- ISO 3166-1 alpha-2

    -- Privacy settings
    profile_visibility VARCHAR(20) DEFAULT 'private', -- 'public', 'friends', 'private'
    show_watch_history BOOLEAN DEFAULT false,

    updated_at TIMESTAMPTZ DEFAULT now()
  );

  -- User notification preferences
  CREATE TABLE user_notification_preferences (
    user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

    -- Email notifications
    email_new_content BOOLEAN DEFAULT true,
    email_request_status BOOLEAN DEFAULT true,
    email_newsletter BOOLEAN DEFAULT false,

    -- In-app notifications
    notify_new_episodes BOOLEAN DEFAULT true,
    notify_request_fulfilled BOOLEAN DEFAULT true,
    notify_server_updates BOOLEAN DEFAULT false,

    updated_at TIMESTAMPTZ DEFAULT now()
  );

  -- User storage quotas (for uploads, profile images)
  CREATE TABLE user_quotas (
    user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

    -- Storage limits
    max_storage_bytes BIGINT DEFAULT 104857600,    -- 100 MB default
    used_storage_bytes BIGINT DEFAULT 0,

    -- Rate limits
    max_api_requests_per_hour INTEGER DEFAULT 1000,

    updated_at TIMESTAMPTZ DEFAULT now()
  );

  -- Data export requests (GDPR compliance)
  CREATE TABLE user_data_exports (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    -- Export details
    status VARCHAR(20) DEFAULT 'pending',          -- 'pending', 'processing', 'completed', 'failed'
    export_file_path TEXT,                         -- Path to generated ZIP file
    file_size_bytes BIGINT,

    requested_at TIMESTAMPTZ DEFAULT now(),
    completed_at TIMESTAMPTZ,
    expires_at TIMESTAMPTZ,                        -- Auto-delete after 7 days
    downloaded_at TIMESTAMPTZ
  );
  CREATE INDEX idx_user_exports_user ON user_data_exports(user_id, requested_at DESC);
  CREATE INDEX idx_user_exports_expires ON user_data_exports(expires_at) WHERE status = 'completed';

  -- Account deletion requests
  CREATE TABLE user_deletion_requests (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    -- Deletion details
    status VARCHAR(20) DEFAULT 'pending',          -- 'pending', 'processing', 'completed', 'cancelled'
    reason TEXT,

    requested_at TIMESTAMPTZ DEFAULT now(),
    completed_at TIMESTAMPTZ,
    scheduled_for TIMESTAMPTZ                      -- Delayed deletion (30 days grace period)
  );
  CREATE INDEX idx_user_deletion_user ON user_deletion_requests(user_id);
  ```
module_structure: |
  ```
  internal/service/user/
  â”œâ”€â”€ module.go                    # fx module
  â”œâ”€â”€ types.go                     # Domain types
  â”œâ”€â”€ repository.go                # Database operations (sqlc)
  â”œâ”€â”€ service.go                   # User service logic
  â”œâ”€â”€ profile.go                   # Profile management
  â”œâ”€â”€ gdpr.go                      # Data export/deletion
  â”œâ”€â”€ storage.go                   # File upload/quota management
  â”œâ”€â”€ handler.go                   # HTTP API handlers
  â””â”€â”€ user_test.go

  web/src/routes/(app)/users/
  â”œâ”€â”€ [id]/
  â”‚   â”œâ”€â”€ +page.svelte             # User profile view
  â”‚   â”œâ”€â”€ +page.ts
  â”‚   â””â”€â”€ edit/
  â”‚       â””â”€â”€ +page.svelte         # Profile edit form
  â””â”€â”€ me/
      â””â”€â”€ settings/
          â”œâ”€â”€ +page.svelte         # User settings
          â”œâ”€â”€ profile/
          â”‚   â””â”€â”€ +page.svelte     # Profile settings
          â”œâ”€â”€ notifications/
          â”‚   â””â”€â”€ +page.svelte     # Notification preferences
          â”œâ”€â”€ privacy/
          â”‚   â””â”€â”€ +page.svelte     # Privacy settings
          â””â”€â”€ data/
              â””â”€â”€ +page.svelte     # Data export/deletion
  ```
key_interfaces: |
  ```go
  type UserService interface {
    // User management
    GetUser(ctx context.Context, userID uuid.UUID) (*User, error)
    ListUsers(ctx context.Context, filters UserFilters) ([]User, error)
    UpdateUser(ctx context.Context, userID uuid.UUID, update UserUpdate) (*User, error)
    DeleteUser(ctx context.Context, userID uuid.UUID) error

    // Profile
    GetProfile(ctx context.Context, userID uuid.UUID) (*UserProfile, error)
    UpdateProfile(ctx context.Context, userID uuid.UUID, profile ProfileUpdate) (*UserProfile, error)
    UploadAvatar(ctx context.Context, userID uuid.UUID, file io.Reader) (string, error)

    // Notifications
    GetNotificationPreferences(ctx context.Context, userID uuid.UUID) (*NotificationPreferences, error)
    UpdateNotificationPreferences(ctx context.Context, userID uuid.UUID, prefs NotificationPreferences) error

    // GDPR
    RequestDataExport(ctx context.Context, userID uuid.UUID) (*DataExport, error)
    GetDataExport(ctx context.Context, exportID uuid.UUID) (*DataExport, error)
    RequestAccountDeletion(ctx context.Context, userID uuid.UUID, reason string) error
    CancelDeletion(ctx context.Context, requestID uuid.UUID) error
  }

  type UserProfile struct {
    UserID            uuid.UUID  `db:"user_id" json:"user_id"`
    Bio               *string    `db:"bio" json:"bio,omitempty"`
    AvatarURL         *string    `db:"avatar_url" json:"avatar_url,omitempty"`
    BannerURL         *string    `db:"banner_url" json:"banner_url,omitempty"`
    Timezone          *string    `db:"timezone" json:"timezone,omitempty"`
    Language          string     `db:"language" json:"language"`
    ProfileVisibility string     `db:"profile_visibility" json:"profile_visibility"`
  }
  ```
dependencies: |
  **Go Packages**:
  - `github.com/google/uuid`
  - `github.com/jackc/pgx/v5`
  - `github.com/riverqueue/river` - Background data export jobs
  - `io` - File handling
  - `archive/zip` - Data export ZIP creation
  - `go.uber.org/fx`
env_vars: |
  ```bash
  USER_DEFAULT_STORAGE_QUOTA_MB=100
  USER_MAX_AVATAR_SIZE_MB=5
  USER_DATA_EXPORT_EXPIRY=168h  # 7 days
  USER_DELETION_GRACE_PERIOD=720h  # 30 days
  ```
config_keys: |
  ```yaml
  user:
    storage:
      default_quota_mb: 100
      max_avatar_size_mb: 5
      upload_path: /data/uploads/avatars
    gdpr:
      data_export_expiry: 168h
      deletion_grace_period: 720h
    profile:
      default_visibility: private
  ```
component_interaction: |
  **Profile Update**:
  1. User edits profile (bio, avatar, timezone)
  2. PUT /api/v1/users/me/profile
  3. Service validates fields
  4. If avatar uploaded:
     - Check quota (used_storage_bytes + file_size <= max_storage_bytes)
     - Save file to /data/uploads/avatars/{user_id}/{filename}
     - Update user_quotas.used_storage_bytes
  5. Update user_profiles table
  6. Return updated profile

  **Data Export** (GDPR):
  1. User requests data export
  2. POST /api/v1/users/me/data-export
  3. Create user_data_exports record (status=pending)
  4. Queue River job to generate export
  5. Background job:
     - Query all user data (profile, watch history, ratings, etc.)
     - Generate JSON files
     - Create ZIP archive
     - Store in /data/exports/{user_id}/{export_id}.zip
     - Update export record (status=completed, file_path, file_size)
     - Send email notification
  6. User downloads via GET /api/v1/users/me/data-export/:id/download
  7. After 7 days, auto-delete file

  **Account Deletion**:
  1. User requests deletion
  2. POST /api/v1/users/me/delete
  3. Create user_deletion_requests (status=pending, scheduled_for=30 days from now)
  4. Send confirmation email
  5. User can cancel within 30 days
  6. After 30 days, River job processes deletion:
     - Delete all user data (cascade)
     - Remove uploaded files
     - Update deletion request (status=completed)
api_endpoints: |
  ```
  # User management (admin)
  GET    /api/v1/users               # List users
  GET    /api/v1/users/:id           # Get user
  PUT    /api/v1/users/:id           # Update user
  DELETE /api/v1/users/:id           # Delete user

  # Current user (self)
  GET    /api/v1/users/me            # Get current user
  PUT    /api/v1/users/me            # Update current user

  # Profile
  GET    /api/v1/users/:id/profile   # Get profile
  PUT    /api/v1/users/me/profile    # Update profile
  POST   /api/v1/users/me/avatar     # Upload avatar

  # Notifications
  GET    /api/v1/users/me/notifications/preferences
  PUT    /api/v1/users/me/notifications/preferences

  # GDPR
  POST   /api/v1/users/me/data-export           # Request export
  GET    /api/v1/users/me/data-export/:id       # Get export status
  GET    /api/v1/users/me/data-export/:id/download  # Download export
  POST   /api/v1/users/me/delete                # Request deletion
  DELETE /api/v1/users/me/delete/:id            # Cancel deletion
  ```

  **Example Profile Update Request**:
  ```json
  {
    "bio": "Movie enthusiast and avid reader",
    "timezone": "America/New_York",
    "language": "en",
    "profile_visibility": "friends"
  }
  ```
unit_tests: |
  ```go
  func TestUserService_UpdateProfile(t *testing.T) {
    // Test profile updates
  }

  func TestUserService_UploadAvatar(t *testing.T) {
    // Test avatar upload and quota enforcement
  }
  ```
integration_tests: |
  ```go
  func TestUser_DataExportFlow(t *testing.T) {
    // Test full GDPR data export workflow
  }

  func TestUser_DeletionFlow(t *testing.T) {
    // Test account deletion with grace period
  }
  ```
