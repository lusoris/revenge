doc_title: OIDC Service
doc_category: service
created_date: '2026-01-31'
overall_status: âœ… Complete
status_design: âœ…
status_design_notes: '-'
status_sources: âœ…
status_sources_notes: '-'
status_instructions: âœ…
status_instructions_notes: '-'
status_code: ðŸ”´
status_code_notes: '-'
status_linting: ðŸ”´
status_linting_notes: '-'
status_unit_testing: ðŸ”´
status_unit_testing_notes: '-'
status_integration_testing: ðŸ”´
status_integration_testing_notes: '-'
technical_summary: '> OpenID Connect / SSO provider management'
wiki_tagline: '> OpenID Connect / SSO provider management'
wiki_overview: The OIDC service enables Single Sign-On with external identity providers. Connect Authentik, Keycloak, Authelia,
  or any OIDC-compliant provider. Users can link multiple providers to one account. Auto-create users on first login or require
  admin approval. Supports standard claims for profile info and group mapping for automatic role assignment.
sources:
- name: Authelia Documentation
  url: https://www.authelia.com/overview/
  note: Auto-resolved from authelia
- name: Authentik Documentation
  url: https://goauthentik.io/docs/
  note: Auto-resolved from authentik
- name: Uber fx
  url: https://pkg.go.dev/go.uber.org/fx
  note: Auto-resolved from fx
- name: Keycloak Documentation
  url: https://www.keycloak.org/documentation
  note: Auto-resolved from keycloak
- name: ogen OpenAPI Generator
  url: https://pkg.go.dev/github.com/ogen-go/ogen
  note: Auto-resolved from ogen
- name: sqlc
  url: https://docs.sqlc.dev/en/stable/
  note: Auto-resolved from sqlc
- name: sqlc Configuration
  url: https://docs.sqlc.dev/en/stable/reference/config.html
  note: Auto-resolved from sqlc-config
design_refs:
- title: services
  path: INDEX.md
- title: 01_ARCHITECTURE
  path: ../architecture/01_ARCHITECTURE.md
- title: 02_DESIGN_PRINCIPLES
  path: ../architecture/02_DESIGN_PRINCIPLES.md
- title: 03_METADATA_SYSTEM
  path: ../architecture/03_METADATA_SYSTEM.md
service_name: OIDC Service
package_path: internal/service/oidc
fx_module: oidc.Module
architecture_diagram: |-
  ```mermaid
  flowchart TD
      node1["Client<br/>(Browser)"]
      node2["API Handler<br/>(ogen)"]
      node3["Service<br/>(Logic)"]
      node4["â–¼            â–¼            â–¼<br/>â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€"]
      node5["PostgreSQL"]
      node1 --> node2
      node2 --> node3
      node3 --> node4
      node4 --> node5
  ```
database_schema: |
  **Schema**: `public`

  ```sql
  -- OIDC providers
  CREATE TABLE oidc_providers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Provider details
    name VARCHAR(100) NOT NULL UNIQUE,             -- 'authentik', 'keycloak', 'authelia'
    display_name TEXT NOT NULL,
    issuer_url TEXT NOT NULL,                      -- https://auth.example.com/application/o/revenge/
    client_id TEXT NOT NULL,
    client_secret TEXT NOT NULL,                   -- Encrypted

    -- Configuration
    scopes TEXT[] DEFAULT '{openid,email,profile}',
    enabled BOOLEAN DEFAULT true,
    auto_create_users BOOLEAN DEFAULT false,
    group_claim VARCHAR(100),                      -- Claim for group/role mapping

    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
  );

  -- User OIDC links (user -> provider mapping)
  CREATE TABLE user_oidc_links (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    provider_id UUID NOT NULL REFERENCES oidc_providers(id) ON DELETE CASCADE,

    -- Provider user info
    provider_user_id TEXT NOT NULL,                -- 'sub' claim from provider
    provider_email TEXT,

    linked_at TIMESTAMPTZ DEFAULT now(),
    UNIQUE(provider_id, provider_user_id)
  );
  CREATE INDEX idx_user_oidc_links_user ON user_oidc_links(user_id);
  ```
module_structure: |
  ```
  internal/service/oidc/
  â”œâ”€â”€ module.go                    # fx module
  â”œâ”€â”€ types.go                     # Domain types
  â”œâ”€â”€ repository.go                # Database operations (sqlc)
  â”œâ”€â”€ service.go                   # OIDC service logic
  â”œâ”€â”€ provider.go                  # Provider client
  â”œâ”€â”€ handler.go                   # HTTP API handlers (OAuth callback)
  â””â”€â”€ oidc_test.go
  ```
key_interfaces: |
  ```go
  type OIDCService interface {
    // Provider management
    AddProvider(ctx context.Context, provider OIDCProvider) error
    GetProvider(ctx context.Context, name string) (*OIDCProvider, error)
    ListProviders(ctx context.Context) ([]OIDCProvider, error)

    // OAuth flow
    GetAuthURL(ctx context.Context, providerName, redirectURL string) (string, error)
    HandleCallback(ctx context.Context, providerName, code string) (*User, error)

    // User linking
    LinkUser(ctx context.Context, userID uuid.UUID, providerName string) error
    UnlinkUser(ctx context.Context, userID uuid.UUID, providerName string) error
  }
  ```
dependencies: |
  **Go Packages**:
  - `github.com/google/uuid`
  - `github.com/jackc/pgx/v5`
  - `github.com/coreos/go-oidc/v3/oidc` - OIDC client
  - `golang.org/x/oauth2` - OAuth2 flow
  - `go.uber.org/fx`
env_vars: |
  ```bash
  OIDC_CALLBACK_URL=https://revenge.example.com/api/v1/oidc/callback
  ```
config_keys: |
  ```yaml
  oidc:
    callback_url: https://revenge.example.com/api/v1/oidc/callback
  ```
component_interaction: |
  **OAuth Login Flow**:
  1. User clicks "Login with Authentik"
  2. GET /api/v1/oidc/auth/authentik
  3. Service generates OAuth state token
  4. Redirect to Authentik: https://auth.example.com/authorize?client_id=...&redirect_uri=...&state=...
  5. User logs in at Authentik
  6. Authentik redirects back: GET /api/v1/oidc/callback?code=...&state=...
  7. Service exchanges code for tokens
  8. Query Authentik userinfo endpoint
  9. Check if provider_user_id exists in user_oidc_links
  10. If exists, find user; if not, create user (if auto_create_users)
  11. Create session
  12. Redirect to app
api_endpoints: |
  ```
  # OAuth flow
  GET  /api/v1/oidc/auth/:provider         # Initiate OAuth flow
  GET  /api/v1/oidc/callback/:provider     # OAuth callback

  # Provider management (admin)
  POST /api/v1/oidc/providers              # Add provider
  GET  /api/v1/oidc/providers              # List providers
  PUT  /api/v1/oidc/providers/:id          # Update provider
  ```
unit_tests: |
  ```go
  func TestOIDCService_GetAuthURL(t *testing.T) {
    // Test OAuth URL generation
  }
  ```
integration_tests: |
  ```go
  func TestOIDC_CallbackFlow(t *testing.T) {
    // Test full OAuth callback workflow
  }
  ```
