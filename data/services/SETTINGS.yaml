doc_title: Settings Service
doc_category: service
created_date: '2026-01-31'
overall_status: âœ… Complete
status_design: âœ…
status_design_notes: '-'
status_sources: âœ…
status_sources_notes: '-'
status_instructions: âœ…
status_instructions_notes: '-'
status_code: ðŸ”´
status_code_notes: '-'
status_linting: ðŸ”´
status_linting_notes: '-'
status_unit_testing: ðŸ”´
status_unit_testing_notes: '-'
status_integration_testing: ðŸ”´
status_integration_testing_notes: '-'
technical_summary: '> Server settings persistence and retrieval'
wiki_tagline: '> Server settings persistence and retrieval'
wiki_overview: The Settings service stores and manages server configuration that can be changed at runtime. Unlike config
  file settings, these can be modified through the UI without restarting. Includes transcoding preferences, default languages,
  metadata sources, and feature flags. Changes take effect immediately and persist across restarts.
sources:
- name: Uber fx
  url: https://pkg.go.dev/go.uber.org/fx
  note: Auto-resolved from fx
- name: koanf
  url: https://pkg.go.dev/github.com/knadh/koanf/v2
  note: Auto-resolved from koanf
- name: ogen OpenAPI Generator
  url: https://pkg.go.dev/github.com/ogen-go/ogen
  note: Auto-resolved from ogen
- name: pgx PostgreSQL Driver
  url: https://pkg.go.dev/github.com/jackc/pgx/v5
  note: Auto-resolved from pgx
- name: PostgreSQL Arrays
  url: https://www.postgresql.org/docs/current/arrays.html
  note: Auto-resolved from postgresql-arrays
- name: PostgreSQL JSON Functions
  url: https://www.postgresql.org/docs/current/functions-json.html
  note: Auto-resolved from postgresql-json
- name: River Job Queue
  url: https://pkg.go.dev/github.com/riverqueue/river
  note: Auto-resolved from river
- name: sqlc
  url: https://docs.sqlc.dev/en/stable/
  note: Auto-resolved from sqlc
- name: sqlc Configuration
  url: https://docs.sqlc.dev/en/stable/reference/config.html
  note: Auto-resolved from sqlc-config
design_refs:
- title: services
  path: INDEX.md
- title: 01_ARCHITECTURE
  path: ../architecture/01_ARCHITECTURE.md
- title: 02_DESIGN_PRINCIPLES
  path: ../architecture/02_DESIGN_PRINCIPLES.md
- title: 03_METADATA_SYSTEM
  path: ../architecture/03_METADATA_SYSTEM.md
service_name: Settings Service
package_path: internal/service/settings
fx_module: settings.Module
architecture_diagram: |-
  ```mermaid
  flowchart TD
      subgraph row1[ ]
          direction LR
          node1(["Client<br/>(Web/App)"])
          node2[["API Handler<br/>(ogen)"]]
          node3[["Service<br/>(Logic)"]]
      end
      subgraph row2[ ]
          direction LR
          node4["Repository<br/>(sqlc)"]
          node5["Koanf<br/>(Config)"]
          node6[("Cache<br/>(otter)")]
      end
      node7[("PostgreSQL<br/>(pgx)")]
      node1 --> node2
      node2 --> node3
      node4 --> node5
      node5 --> node6
      node3 --> node4
      node6 --> node7

      %% Hide row subgraph borders
      style row1 fill:transparent,stroke:transparent
      style row2 fill:transparent,stroke:transparent
  ```
database_schema: |
  **Schema**: `public`

  ```sql
  -- Server settings (runtime configuration)
  CREATE TABLE settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Setting identification
    key VARCHAR(255) NOT NULL UNIQUE,              -- 'server.name', 'transcoding.default_quality'
    value TEXT NOT NULL,                           -- JSON-encoded value
    value_type VARCHAR(50) NOT NULL,               -- 'string', 'integer', 'boolean', 'json'

    -- Metadata
    category VARCHAR(100),                         -- 'server', 'transcoding', 'metadata'
    description TEXT,
    default_value TEXT,

    -- Validation
    is_required BOOLEAN DEFAULT false,
    validation_rules JSONB,                        -- JSON schema or validation rules

    updated_at TIMESTAMPTZ DEFAULT now(),
    updated_by_user_id UUID REFERENCES users(id)
  );
  CREATE INDEX idx_settings_key ON settings(key);
  CREATE INDEX idx_settings_category ON settings(category);

  -- Setting change history (audit log)
  CREATE TABLE settings_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    setting_id UUID NOT NULL REFERENCES settings(id) ON DELETE CASCADE,

    -- Change details
    old_value TEXT,
    new_value TEXT NOT NULL,

    changed_by_user_id UUID REFERENCES users(id),
    changed_at TIMESTAMPTZ DEFAULT now()
  );
  CREATE INDEX idx_settings_history_setting ON settings_history(setting_id, changed_at DESC);
  ```
module_structure: |
  ```
  internal/service/settings/
  â”œâ”€â”€ module.go                    # fx module
  â”œâ”€â”€ types.go                     # Domain types
  â”œâ”€â”€ repository.go                # Database operations (sqlc)
  â”œâ”€â”€ service.go                   # Settings service logic
  â”œâ”€â”€ defaults.go                  # Default settings
  â”œâ”€â”€ validation.go                # Setting validation
  â”œâ”€â”€ handler.go                   # HTTP API handlers
  â””â”€â”€ settings_test.go
  ```
key_interfaces: |
  ```go
  type SettingsService interface {
    // Get/Set
    GetSetting(ctx context.Context, key string) (*Setting, error)
    GetSettings(ctx context.Context, category string) ([]Setting, error)
    SetSetting(ctx context.Context, key, value string, userID uuid.UUID) error
    SetBulk(ctx context.Context, settings map[string]string, userID uuid.UUID) error

    // Defaults
    ResetToDefault(ctx context.Context, key string) error
    LoadDefaults(ctx context.Context) error

    // History
    GetHistory(ctx context.Context, key string) ([]SettingChange, error)
  }

  type Setting struct {
    Key          string     `db:"key" json:"key"`
    Value        string     `db:"value" json:"value"`
    ValueType    string     `db:"value_type" json:"value_type"`
    Category     *string    `db:"category" json:"category,omitempty"`
    Description  *string    `db:"description" json:"description,omitempty"`
  }
  ```
dependencies: |
  **Go Packages**:
  - `github.com/google/uuid`
  - `github.com/jackc/pgx/v5`
  - `github.com/knadh/koanf/v2` - Configuration management
  - `github.com/maypok86/otter` - Settings cache
  - `go.uber.org/fx`
env_vars: |
  ```bash
  SETTINGS_CACHE_TTL=5m
  ```
config_keys: |
  ```yaml
  settings:
    cache_ttl: 5m
  ```
component_interaction: |
  **Update Setting**:
  1. Admin changes setting: PUT /api/v1/settings/server.name
  2. Service validates value against rules
  3. Store old value in settings_history
  4. Update settings table
  5. Invalidate cache
  6. Broadcast change event (WebSocket)
  7. Affected services reload configuration
api_endpoints: |
  ```
  GET    /api/v1/settings               # List all settings
  GET    /api/v1/settings/:key          # Get setting
  PUT    /api/v1/settings/:key          # Update setting
  POST   /api/v1/settings/bulk          # Bulk update
  POST   /api/v1/settings/:key/reset    # Reset to default
  GET    /api/v1/settings/:key/history  # Get change history
  ```
unit_tests: |
  ```go
  func TestSettingsService_SetSetting(t *testing.T) {
    // Test setting update with validation
  }
  ```
integration_tests: |
  ```go
  func TestSettings_HistoryTracking(t *testing.T) {
    // Test change history logging
  }
  ```
